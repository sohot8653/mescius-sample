/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

import{MergeManager,CellRange,FlexGrid,Row,Column,ColumnCollection,CellRangeEventArgs,AllowSorting,HeadersVisibility,AutoSizeMode}from"@grapecity/wijmo.grid";import{asArray,assert,isArray,isString,isNumber,isUndefined,asBoolean,getTypes,getType,tryCast,toHeaderCase,addClass,DataType,Binding,Control,CollectionView,ObservableArray,NotifyCollectionChangedEventArgs,NotifyCollectionChangedAction,copy,_registerModule}from"@grapecity/wijmo";import*as selfModule from"@grapecity/wijmo.grid.transposed";export class _MergeManager extends MergeManager{getMergedRange(e,t,o,r=!0){let s=e.grid,i=s._hasColumnGroups();if(e==s.columnHeaders&&i)return null;if(e==s.rowHeaders&&i){if(t<0||t>=e.rows.length||o<0||o>=e.columns.length)return null;let r=s._getColumnGroup(t,o);if(r){let o=r._rng,s=e.rows;if(s.isFrozen(o.row)!=s.isFrozen(o.row2)){o=o.clone();s.isFrozen(t)?o.row2=s.frozen-1:o.row=s.frozen}return o}return null}return super.getMergedRange(e,t,o,r)}}export class TransposedGrid extends FlexGrid{constructor(e,t){super(e,null);this._keyPrefix="item";this._autoGenRows=!0;addClass(this.hostElement,"wj-transposed-grid");this.allowSorting=AllowSorting.None;this.headersVisibility=HeadersVisibility.Row;this._rowInfo=new ColumnCollection(this,this.columns.defaultSize);this._grpHdl=new _RowGroupHandler(this);this.mergeManager=new _MergeManager;this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this);this.deferUpdate(()=>{let e=this.rowHeaders.columns;if(e.length){e[e.length-1].width=this.columns.defaultSize}})}get autoGenerateRows(){return this._autoGenRows}set autoGenerateRows(e){this._autoGenRows=asBoolean(e)}get rowGroups(){return this._grpHdl.getGroupDefinitions()}set rowGroups(e){this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();this._grpHdl.createColumnGroups(asArray(e))})}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}get allowAddNew(){return!1}set allowAddNew(e){}get allowDelete(){return!1}set allowDelete(e){}get allowSorting(){return AllowSorting.None}set allowSorting(e){assert(e===AllowSorting.None,"TransposedGrid does not support sorting.");this._alSorting=e}get columnGroups(){return null}set columnGroups(e){throw"TransposedGrid does not support columnGroups, use rowGroups instead."}onRowEditEnded(e){let t=tryCast(this._sourceItems,"ICollectionView");if(t){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change);t.collectionChanged.raise(t,e)}super.onRowEditEnded(e)}_getCollectionView(e){let t=tryCast(this._sourceItems,"ICollectionView");t&&t.collectionChanged.removeHandler(this._sourceViewChanged);t=tryCast(e,"ICollectionView");let o=e;if(isArray(e))o=this._transposeItemsSource(e);else if(t){t.collectionChanged.addHandler(this._sourceViewChanged,this);o=this._transposeItemsSource(t.items)}this.autoGenerateColumns=!0;let r=super._getCollectionView(o),s=null;t instanceof CollectionView&&(s=t.getError);s&&r instanceof CollectionView&&(this._supportsProxies()?r.getError=(e,t)=>{if(null==t)return null;let o=e._keys.indexOf(t);return s(e._arr[o],e._bnd.path)}:r.getError=(e,t)=>{if(null==t)return null;let o=parseInt(t.substr(this._keyPrefix.length));return s(e._arr[o],e._rowInfo.binding)});this._sourceItems=e;return r}_getColumnTypes(e){let t,o;if(this._sourceItems)if(isArray(this._sourceItems))o=this._sourceItems;else{let e=tryCast(this._sourceItems,"ICollectionView");e&&(o=e.items)}return t=o?o.map((e,t)=>({binding:this._keyPrefix+t,dataType:DataType.Object})):getTypes(e)}_copy(e,t){if(/rows|columns/.test(e)){assert(isArray(t),"Array Expected.");let e=asArray(t);e.some(e=>null!=e.columns)?this.rowGroups=e:this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();t.forEach(e=>{let t=new TransposedGridRow(e);this._rowInfo.push(t)})});return!0}return super._copy(e,t)}onLoadedRows(e){let t=this.columns;for(let e=0;e<t.length;e++){let o=t[e];o.align=null;o.dataType=0}let o=this.rowHeaders.columns;for(let e=0;e<o.length;e++){o[e].align="left";o[e].width=0}let r=FlexGrid._getSerializableProperties(Row);this.rows.forEach(e=>{let t=e.dataItem._rowInfo;if(t){this._copyProps(t,e,r,["showDropDown","width","size"]);if(this._hasColumnGroups())for(let t=0;t<o.length;t++){let o=this._grpHdl.getColumnGroup(e.index,t);o&&this._updateRowHeaders(e.index,t,o)}else o.length&&this._updateRowHeaders(e.index,o.length-1,t)}});for(let e=0;e<o.length;e++)0===o[e].width&&(o[e].width=this.columns.defaultSize);super.onLoadedRows(e)}_getBindingColumn(e,t,o){let r=o;if(e!=this.cells)return r;let s=e.rows[t],i=s&&s.dataItem&&s.dataItem._rowInfo;if(isUndefined(i))return r;r=new Column;let n=FlexGrid._getSerializableProperties(Column);this._copyProps(i,r,n);r.binding=o.binding;r.header=i.header||toHeaderCase(i.binding);return r}_isTransposed(){return!0}_autoSizeRows(){this.autoSizeMode&AutoSizeMode.Both&&this.autoSizeRows();super._autoSizeRows()}_copyProps(e,t,o,r=[]){for(let s in e)if(o.indexOf(s)>-1&&-1===r.indexOf(s)){let o=e[s];if(!isUndefined(o))try{t[s]=o}catch(e){}}}_updateRowHeaders(e,t,o){let r=o.header||toHeaderCase(o.binding);this.rowHeaders.setCellData(e,t,r);let s=this.rowHeaders.columns,i=o.width;if(isNumber(i)&&i>0){let e=o._rng;if(e&&e instanceof CellRange&&e.isValid){let t=e.columnSpan;assert(t>0,"Column span is negative or equal to 0");i/=t}s[t].width=Math.max(s[t].width,i)}}_rowInfoChanged(){this._toRowInfo&&clearTimeout(this._toRowInfo);this._toRowInfo=setTimeout(()=>{let e=this.selection,t=this.itemsSource;this.itemsSource=null;this.itemsSource=t;this.selection=e},Control._REFRESH_INTERVAL)}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new ObservableArray,o=getTypes(e),r=e.map((e,t)=>this._keyPrefix+t);(this.autoGenerateRows?this._getRowInfo(e):this._rowInfo).forEach((s,i)=>{let n=new Binding(s.binding);if(null==s.dataType&&e.length){let t=n.getValue(e[0]);s.dataType=null!=t?getType(t):o[i].dataType}if(this._supportsProxies()){let o=this._createProxy(e,s,r);t.push(o)}else{let o=this._createTransposedObject(e,s,this._keyPrefix);t.push(o)}});e instanceof ObservableArray&&e.collectionChanged.addHandler((e,o)=>{if(o.action===NotifyCollectionChangedAction.Change)this.activeEditor||this.invalidate();else{let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()}});return t}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,o){let r={_arr:e,_rowInfo:t,_bnd:new Binding(t.binding),_keys:o};return new Proxy(r,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let o=e._keys.indexOf(t);return o>-1?e._bnd.getValue(e._arr[o]):e[t]},set:(e,t,o)=>{let r=e._keys.indexOf(t);if(r>-1){let t=e._arr,s=t[r];e._bnd.setValue(s,o);if(t instanceof ObservableArray){let e=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,s,r);t.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,o){let r={_arr:e,_rowInfo:t},s=new Binding(t.binding);for(let t=0;t<e.length;t++){let i=e[t];Object.defineProperty(r,o+t,{enumerable:!0,get:()=>s.getValue(i),set:o=>{s.setValue(i,o);if(e instanceof ObservableArray){let o=new NotifyCollectionChangedEventArgs(NotifyCollectionChangedAction.Change,i,t);e.onCollectionChanged(o)}return!0}})}return r}_getRowInfo(e){let t=[];getTypes(e).forEach(e=>{let o=e.binding,r=e.dataType;if(r!=DataType.Object&&r!=DataType.Array){let e={binding:o,header:toHeaderCase(o),dataType:r},s=FlexGrid._defTypeWidth[r];if(null!=s){if(isString(s)){let e=Math.round(parseFloat(s));s=s.indexOf("*")<0?e:e*this.columns.defaultSize}isNumber(s)&&s>0&&(e.width=s)}t.push(e)}});return t}}export class TransposedGridRow extends Column{get height(){return this._height}set height(e){this._height=e}}export class _RowGroupHandler{constructor(e){this._grid=e}get columnGroups(){return null}createColumnGroups(e){this._createRowGroups(e)}hasColumnGroups(){return null!=this._colGroups&&this._colGroups.length>0}getGroupDefinitions(){return this._groupDefs}getColumnGroup(e,t){let o=this._grid;if(t<o.rowHeaders.columns.length&&e<o._rowInfo.length)for(let o=this._colGroups;o;){let r=o;for(let r=0;r<o.length;r++){let s=o[r],i=s._rng;if(i.containsRow(e)){if(i.containsColumn(t)||0==s.columns.length)return s;o=s.columns;break}}if(o==r)break}return null}canMoveColumnGroup(e,t,o,r){return this._grid.columns.canMoveElement(t,r)}moveColumnGroup(e,t,o,r,s){return this._grid.columns.moveElement(t,r)}_createRowGroups(e){let t=this._grid;this._groupDefs=asArray(e);t.autoGenerateRows=!1;t._rowInfo.clear();this._colGroups=[];e.forEach(e=>{this._colGroups.push(new _RowGroup(e,null))});let o=1;this._colGroups.forEach(e=>{this._addRowGroup(e);o=Math.max(o,e._getMaxLevel())});this._colGroups.forEach(e=>{e._expandRange(o)});let r=t.rowHeaders.columns;r.clear();for(let e=0;e<=o;e++){let t=new Column;r.splice(e,0,t);e<o&&(t.cssClassAll="wj-colgroup")}}_addRowGroup(e){let t=this._grid;e._grid=t;e._rng.row=t._rowInfo.length;0==e.columns.length?t._rowInfo.push(e):e.columns.forEach(e=>{this._addRowGroup(e)});e._rng.row2=t._rowInfo.length-1}}export class _RowGroup extends Column{constructor(e,t){super();this._rng=new CellRange(-1,0);this._cols=[];this._lvl=0;this._collapsed=!1;this._pGrp=t;this._lvl=0;for(let e=t;e;e=e._pGrp)this._lvl++;t&&t.columns.indexOf(this)<0&&t.columns.push(this);this._rng.col=this._rng.col2=this._lvl;this.allowDragging=!1;copy(this,e)}get columns(){return this._cols}set columns(e){let t=this._cols=[];e.forEach(e=>{let o=new _RowGroup(e,this);t.indexOf(o)<0&&t.push(o)})}get rows(){return this._cols}get isEmpty(){return 0===this._cols.length}get height(){return this._height}set height(e){this._height=e}get level(){let e=this,t=0;for(;e._pGrp;){e=e._pGrp;t++}return t}get collapseTo(){return this._collTo}set collapseTo(e){assert(isArray(e)||isString(e),"collapseTo should be an array or a string.");this._collTo=e}get isCollapsed(){return this._collapsed}set isCollapsed(e){if(e!=this._collapsed){let t=this._grid;if(t){let o=new CellRangeEventArgs(t.rowHeaders,this._rng,this);if(t.onColumnGroupCollapsedChanging(o)){this._collapsed=asBoolean(e);t.onColumnGroupCollapsedChanged(o)}}else this._collapsed=asBoolean(e)}setTimeout(()=>{this._updateCollapsedState()})}_copy(e,t){if(/rows|columns/.test(e)){let e=asArray(t);this.columns=e;return!0}return!1}_updateCollapsedState(){let e=this._grid._rowInfo,t=this._rng,o=this._collapsed;this._cols.forEach(e=>{if(e instanceof _RowGroup){e._collapsed=o;e._updateCollapsedState()}});let r=this._getCollapseToIndices();for(let s=t.topRow;s<=t.bottomRow;s++)e[s].visible=!o||r.indexOf(s)>-1}_getMaxLevel(){let e=this._lvl;this.columns.forEach(t=>{e=Math.max(e,t._getMaxLevel())});return e}_expandRange(e){let t=e-this._getMaxLevel();if(t>0){this._rng.col2+=t;this._cols.forEach(e=>{e._shiftRange(t)})}let o=this._grid._rowInfo,r=this._rng;for(let t=r.row;t<=r.row2;t++){o[t]._rng.col2=e}}_shiftRange(e){this._rng.col+=e;this._rng.col2+=e;this._cols.forEach(t=>{t._shiftRange(e)})}_getCollapseToBindings(){let e=this.collapseTo;return isString(e)?[e]:e}_getCollapseToIndices(){let e=this._grid,t=this._rng,o=this._getCollapseToBindings();if(o&&o.length){let r=[],s=e._rowInfo;for(let e=0;e<o.length;e++)switch(o[e]){case"$first":r.push(t.topRow);break;case"$last":r.push(t.bottomRow);break;default:let i=s.indexOf(o[e]);i>-1&&r.push(i)}if(r.length)return r}return[t.bottomRow]}}_registerModule("wijmo.grid.transposed",selfModule);