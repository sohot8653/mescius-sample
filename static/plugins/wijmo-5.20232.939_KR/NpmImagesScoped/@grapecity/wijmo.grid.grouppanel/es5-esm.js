/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();import{_getModule,Control,SortDescription,PropertyGroupDescription,NotifyCollectionChangedAction,assert,asBoolean,asNumber,asType,setCss,toggleClass,culture,_addCultureInfo,createElement,removeChild,_startDrag,hasClass,closest,_registerModule}from"@grapecity/wijmo";import{FlexGrid,CellRange,CellRangeEventArgs,AllowSorting}from"@grapecity/wijmo.grid";import*as selfModule from"@grapecity/wijmo.grid.grouppanel";export function softGridFilter(){return _getModule("wijmo.grid.filter")}_addCultureInfo("GroupPanel",{dragDrop:"Drag and Drop columns here to create Groups."});var GroupPanel=function(e){__extends(GroupPanel,e);function GroupPanel(t,r){var i=e.call(this,t)||this;i._hideGroupedCols=!0;i._showDragGlyphs=!0;i._maxGroups=6;i._hiddenCols=[];i._placeholder=null;i._dragEndBnd=i._dragEnd.bind(i);i._focusGd=null;var n=i.getTemplate();i.applyTemplate("wj-grouppanel wj-control",n,{_divMarkers:"div-markers",_divPH:"div-ph"});setCss(i._divMarkers.parentElement,{width:"100%",height:"100%",minHeight:"1em",overflow:"hidden",cursor:"default"});var o=i.hostElement,l=i.addEventListener.bind(i);l(o,"dragstart",i._dragStart.bind(i));l(o,"dragover",i._dragOver.bind(i));l(o,"drop",i._drop.bind(i));l(o,"dragend",i._dragEndBnd);l(o,"click",i._click.bind(i));i.initialize(r);return i}Object.defineProperty(GroupPanel.prototype,"hideGroupedColumns",{get:function(){return this._hideGroupedCols},set:function(e){e!=this._hideGroupedCols&&(this._hideGroupedCols=asBoolean(e))},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"showDragGlyphs",{get:function(){return this._showDragGlyphs},set:function(e){if(e!=this._showDragGlyphs){this._showDragGlyphs=asBoolean(e);this.refresh()}},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"maxGroups",{get:function(){return this._maxGroups},set:function(e){if(e!=this._maxGroups){this._maxGroups=asNumber(e);var t=this._gds,r=this._maxGroups;t&&r>-1&&r<t.length&&t.splice(r,t.length-r)}},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"placeholder",{get:function(){return this._placeholder},set:function(e){if(e!=this._placeholder){this._placeholder=e;this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"grid",{get:function(){return this._g},set:function(e){if((e=asType(e,FlexGrid,!0))!=this._g){var t=this._g;if(t){t.draggingColumn.removeHandler(this._draggingColumn);t.itemsSourceChanging.removeHandler(this._itemsSourceChanging);t.itemsSourceChanged.removeHandler(this._itemsSourceChanged);t.columns.collectionChanged.removeHandler(this._itemsSourceChanged);t.removeEventListener(t.hostElement,"dragend",this._dragEndBnd)}t=this._g=e;this._hiddenCols=[];if(t){t.draggingColumn.addHandler(this._draggingColumn,this);t.itemsSourceChanging.addHandler(this._itemsSourceChanging,this);t.itemsSourceChanged.addHandler(this._itemsSourceChanged,this);t.columns.collectionChanged.addHandler(this._itemsSourceChanged,this);t.addEventListener(t.hostElement,"dragend",this._dragEndBnd)}this._itemsSourceChanged(t,null)}},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"collectionView",{get:function(){return this._g?this._g.collectionView:null},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"filter",{get:function(){return this._filter},set:function(e){if((e=asType(e,softGridFilter().FlexGridFilter,!0))!=this._filter){var t=this._filter;if(t){t.filterApplied.removeHandler(this.refresh,this);t.filterChanged.removeHandler(this._filterChanged,this)}if(t=this._filter=e){t.filterApplied.addHandler(this.refresh,this);t.filterChanged.addHandler(this._filterChanged,this)}this.refresh()}},enumerable:!0,configurable:!0});Object.defineProperty(GroupPanel.prototype,"groupDescriptionCreator",{get:function(){return this._gdc},set:function(e){this._gdc=e},enumerable:!0,configurable:!0});GroupPanel.prototype.refresh=function(){var t=this;e.prototype.refresh.call(this);this._divMarkers.innerHTML="";this._dragMarker=this._dragCol=null;if(this._gds){for(var r,i=this._g,n=i.columnHeaders,_loop_1=function(e){var l=o._gds[e],s=-1,a=-1;if(l instanceof PropertyGroupDescription)for(var d=n.rows.length-1;d>=0&&a<0;d--)for(var u=0;u<n.columns.length&&a<0;u++){if((p=i._getBindingColumn(n,d,n.columns[u]))&&p.binding==l.propertyName){a=u;s=d;break}}if(a>-1&&s>-1){var h=document.createElement("button");i.cellFactory.updateCell(o._g.columnHeaders,s,a,h);h.setAttribute("class","wj-cell wj-header wj-groupmarker");h.setAttribute("role","button");h.setAttribute("tabindex","0");h.addEventListener("focus",(function(){t._focusGd=l}));o._focusGd===l&&setTimeout((function(){h.focus()}),50);h.addEventListener("keydown",(function(e){if(!(46!==e.keyCode||e.altKey||e.shiftKey||e.ctrlKey||e.metaKey)){var t=e.path.find((function(e){return e.classList.contains("wj-groupmarker")}));Array.from(t.children).find((function(e){return e.classList.contains("wj-remove")})).click()}}));setCss(h,{position:"static",display:"inline-block",verticalAlign:"top",left:"",right:"",top:"",width:"",height:"",paddingLeft:"",paddingRight:""});removeChild(h.querySelector(".wj-elem-filter"));removeChild(h.querySelector(".wj-column-selector"));if(o.showDragGlyphs){r=createElement('<span class="wj-glyph-drag"></span>');h.insertBefore(r,h.firstChild)}var p=i._getBindingColumn(n,s,n.columns[a]),c=o._getColumnFilter(p);if(c){var g=createElement('<span class="wj-filter wj-glyph-filter"></span>',h);toggleClass(g,"wj-filter-on",c.isActive);toggleClass(g,"wj-filter-off",!c.isActive)}createElement('<span class="wj-remove">&times;</span>',h);o._divMarkers.appendChild(h);if(p&&o.hideGroupedColumns){var f=[];if(o.grid.layoutDefinition){o.grid.layoutDefinition.forEach((function(e){return e.cells.forEach((function(e){return f.push(e.binding)}))}))}if(!f.includes(p._binding.path)){p.visible=!1;o._hiddenCols.push(p)}}}},o=this,l=0;l<this._gds.length;l++)_loop_1(l);this._divPH.textContent=null!=this._placeholder?this._placeholder:culture.GroupPanel.dragDrop;var s=this._divMarkers.children.length>0;this._divPH.style.display=s?"none":"";this._divMarkers.style.display=s?"":"none"}};GroupPanel.prototype.hitTest=function(e){var t=e instanceof HTMLElement?e:e instanceof MouseEvent?e.target:null;assert(null!=t,"MouseEvent or Element expected");var r=closest(t,".wj-cell");if(hasClass(r,"wj-cell")){var i=this._getElementIndex(r);return this._gds&&i>-1?this._gds[i]:null}return null};GroupPanel.prototype._filterChanged=function(){this._filterMarker=null};GroupPanel.prototype._getColumnFilter=function(e){var t=this._filter,r=null;t&&(r=t.filterColumns&&t.filterColumns.indexOf(e.binding)<0?null:t.getColumnFilter(e));return r};GroupPanel.prototype._editFilter=function(e){var t=this._gds,r=this._getElementIndex(e),i=t&&r>-1?t[r]:null,n=i instanceof PropertyGroupDescription?i.propertyName:null,o=n?this._g.getColumn(n):null;o&&this._filter.editColumnFilter(o,null,e)};GroupPanel.prototype._addGroup=function(e,t){for(var r=this._getIndex(t),i=this._gds,n=this._maxGroups,o=0;o<i.length;o++){var l=i[o];if(l instanceof PropertyGroupDescription&&l.propertyName==e.binding){i.removeAt(o);o<r&&r--;break}}if(n>-1)for(o=n-1;o<i.length;o++){this._removeGroup(o,i);o<r&&r--}if(n<0||i.length<n){var s=this._gdc?this._gdc(e.binding):null;s||(s=new PropertyGroupDescription(e.binding));i.insert(r,s);if(e&&this.hideGroupedColumns){e.visible=!1;this._hiddenCols.push(e)}}};GroupPanel.prototype._moveGroup=function(e,t){var r=this._gds,i=this._getElementIndex(this._dragMarker),n=this._getIndex(t);n>i&&n--;n>=this._gds.length&&(n=this._gds.length);i!=n&&r.deferUpdate((function(){var e=r[i];r.removeAt(i);r.insert(n,e)}))};GroupPanel.prototype._removeGroup=function(e,t){void 0===t&&(t=this._gds);var r=t&&e>-1?t[e]:null,i=r instanceof PropertyGroupDescription?r.propertyName:null,n=i?this._g.columns.getColumn(i):null;if(n){n.visible=!0;var o=this._hiddenCols,l=o.indexOf(n);l>-1&&o.splice(l,1)}r&&t.removeAt(e)};GroupPanel.prototype._getIndex=function(e){for(var t=e.clientX,r=this._divMarkers.children,i=0;i<r.length;i++){var n=r[i].getBoundingClientRect();if((t-n.left)*(t-n.right)<0)return i}return r.length};GroupPanel.prototype._getElementIndex=function(e){if(e&&e.parentElement)for(var t=e.parentElement.children,r=0;r<t.length;r++)if(t[r]==e)return r;return-1};GroupPanel.prototype._draggingColumn=function(e,t){var r=this._g,i=r._getBindingColumn(t.panel,t.row,r.columns[t.col]);this._dragCol=i.binding?i:null};GroupPanel.prototype._itemsSourceChanging=function(e,t){this._hiddenCols.forEach((function(e){e.visible=!0}));this._hiddenCols=[]};GroupPanel.prototype._itemsSourceChanged=function(e,t){this._view&&this._view.collectionChanged.removeHandler(this._collectionChanged);this._view=this._g?this._g.collectionView:null;this._gds=this._view?this._view.groupDescriptions:null;this._view&&this._view.collectionChanged.addHandler(this._collectionChanged,this);this.invalidate()};GroupPanel.prototype._collectionChanged=function(e,t){t.action==NotifyCollectionChangedAction.Reset&&this.invalidate()};GroupPanel.prototype._dragStart=function(e){_startDrag(e.dataTransfer,"move");this._dragMarker=e.target;this._dragCol=null};GroupPanel.prototype._dragOver=function(e){if(this._dragCol||this._dragMarker){e.dataTransfer.dropEffect="move";e.preventDefault();e.stopPropagation()}};GroupPanel.prototype._drop=function(e){this._dragMarker?this._moveGroup(this._dragMarker,e):this._dragCol&&this._addGroup(this._dragCol,e)};GroupPanel.prototype._dragEnd=function(e){this._dragMarker=this._dragCol=null};GroupPanel.prototype._click=function(e){var t=e.target,r=closest(t,".wj-cell");if(hasClass(r,"wj-cell"))if(hasClass(t,"wj-filter")){if(r!=this._filterMarker){this._editFilter(r);this._filterMarker=r;return}}else if(hasClass(t,"wj-remove")){var i=this._getElementIndex(r);this._removeGroup(i)}else this._updateSort(e,r);this._filterMarker=null;this.hostElement.focus()};GroupPanel.prototype._updateSort=function(e,t){var r=this,i=this._g,n=i.collectionView;if(n&&n.canSort&&i.allowSorting!=AllowSorting.None){var o=this._getElementIndex(t),l=this._gds[o],s=l instanceof PropertyGroupDescription?l.propertyName:null,a=s?i.getColumn(s):null;if(a&&a.allowSorting){for(var d=a.sortMemberPath||a.binding,u=-1,h=n.sortDescriptions,p=0;p<h.length;p++)if(h[p].property==d){u=p;break}var c=new CellRangeEventArgs(i.columnHeaders,new CellRange(0,a.index),e);if(i.onSortingColumn(c)){var g=e.ctrlKey||e.metaKey,f=e.shiftKey;h.deferUpdate((function(){if(g&&f)h.clear();else if(u<0){r._g.allowSorting!=AllowSorting.MultiColumn&&h.clear();var e=new SortDescription(d,!0);h.push(e)}else{var t=h[u].ascending;if(g||r.isTouching&&!t)h.splice(u,1);else{e=new SortDescription(d,!t);h.splice(u,1,e)}}}));i.onSortedColumn(c)}}}};GroupPanel.controlTemplate='<div><div wj-part="div-ph"></div><div wj-part="div-markers"></div></div>';return GroupPanel}(Control);export{GroupPanel};_registerModule("wijmo.grid.grouppanel",selfModule);