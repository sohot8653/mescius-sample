/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.hasOwnProperty.call(t,i)&&(e[i]=t[i]);e.default=t;return e};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@grapecity/wijmo"),selfModule=__importStar(require("@grapecity/wijmo.odata"));function softGrid(){return wijmo_1._getModule("wijmo.grid")}exports.softGrid=softGrid;function softFilter(){return wijmo_1._getModule("wijmo.grid.filter")}exports.softFilter=softFilter;class ODataCollectionView extends wijmo_1.CollectionView{constructor(t,e,i){super();this._count=0;this._sortOnServer=!0;this._pageOnServer=!0;this._filterOnServer=!0;this._deferCommits=!1;this._hasPendingChanges=!1;this._showDatesAsGmt=!1;this._inferDataTypes=!0;this._reviverBnd=this._reviver.bind(this);this.loading=new wijmo_1.Event;this.loaded=new wijmo_1.Event;this.error=new wijmo_1.Event;this.hasPendingChangesChanged=new wijmo_1.Event;this._url=wijmo_1.asString(t,!1);this._tbl=wijmo_1.asString(e);wijmo_1.copy(this,i);this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&!this.hasPendingChanges&&this._getData()});this.itemsEdited.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsAdded.collectionChanged.addHandler(this._updateHasChanges,this);this.itemsRemoved.collectionChanged.addHandler(this._updateHasChanges,this);this._getData()}get tableName(){return this._tbl}get entityType(){return this._entityType}set entityType(t){this._entityType=wijmo_1.asString(t)}get fields(){return this._fields}set fields(t){if(this._fields!=t){this._fields=wijmo_1.asArray(t);this._getData()}}get requestHeaders(){return this._requestHeaders}set requestHeaders(t){this._requestHeaders=t}get keys(){return this._keys}set keys(t){this._keys=wijmo_1.asArray(t)}get expand(){return this._expand}set expand(t){this._expand=wijmo_1.asString(t)}get jsonReviver(){return this._jsonReviver}set jsonReviver(t){this._jsonReviver=wijmo_1.asFunction(t)}get dataTypes(){return this._dataTypes}set dataTypes(t){this._dataTypes=t}get inferDataTypes(){return this._inferDataTypes}set inferDataTypes(t){if(t!=this.inferDataTypes){this._inferDataTypes=wijmo_1.asBoolean(t);this._getData()}}get showDatesAsGmt(){return this._showDatesAsGmt}set showDatesAsGmt(t){if(t!=this.showDatesAsGmt){this._showDatesAsGmt=wijmo_1.asBoolean(t);this._getData()}}get sortOnServer(){return this._sortOnServer}set sortOnServer(t){if(t!=this._sortOnServer){this._sortOnServer=wijmo_1.asBoolean(t);this._getData()}}get pageOnServer(){return this._pageOnServer}set pageOnServer(t){if(t!=this._pageOnServer){this._pageOnServer=wijmo_1.asBoolean(t);this.pageSize&&this._getData()}}get filterOnServer(){return this._filterOnServer}set filterOnServer(t){if(t!=this._filterOnServer){this._filterOnServer=wijmo_1.asBoolean(t);this._getData()}}get filterDefinition(){return this._filterDef}set filterDefinition(t){if(t!=this._filterDef){this._filterDef=wijmo_1.asString(t);this._getData()}}updateFilterDefinition(t){this.filterOnServer&&softGrid()&&softFilter()&&t instanceof softFilter().FlexGridFilter&&(this.filterDefinition=this._asODataFilter(t))}get oDataVersion(){return this._odv}set oDataVersion(t){this._odv=wijmo_1.asNumber(t)}get isLoading(){return this._loading}get deferCommits(){return this._deferCommits}set deferCommits(t){this._deferCommits=wijmo_1.asBoolean(t);this.deferCommits&&(this.trackChanges=!0)}onLoading(t){this.loading.raise(this,t)}onLoaded(t){this.loaded.raise(this,t)}load(){this._getData()}onError(t){this.error.raise(this,t);return!t.cancel}onHasPendingChangesChanged(t){this.hasPendingChangesChanged.raise(this,t)}implementsInterface(t){return"IEditableCollectionView"==t?null!=this.keys&&this.keys.length>0:super.implementsInterface(t)}commitNew(){if(!this.deferCommits){let t={Accept:"application/json"};if(this.requestHeaders)for(let e in this.requestHeaders)t[e]=this.requestHeaders[e];let e=this.currentAddItem;if(e){let i=this._getWriteUrl();wijmo_1.httpRequest(i,{method:"POST",requestHeaders:t,data:this._convertToDbFormat(e),success:t=>{let i=JSON.parse(t.responseText,this._reviverBnd);this.keys.forEach(t=>{e[t]=i[t]});this.refresh()},error:this._error.bind(this)})}}super.commitNew()}commitEdit(){if(!this.deferCommits){let t=this.currentEditItem;if(t&&!this.currentAddItem&&this._getChangedFields(t,this._edtClone)){let e=this._getWriteUrl(this._edtClone);wijmo_1.httpRequest(e,{method:"PATCH",requestHeaders:this.requestHeaders,data:this._convertToDbFormat(t),error:this._error.bind(this)})}}super.commitEdit()}remove(t){if(!this.deferCommits&&t&&t!=this.currentAddItem&&this.items.indexOf(t)>-1){let e=this._getWriteUrl(t);wijmo_1.httpRequest(e,{method:"DELETE",requestHeaders:this.requestHeaders,error:this._error.bind(this)})}super.remove(t)}commitChanges(t){if(this.deferCommits){let e=[];this.itemsEdited.forEach(t=>{e.push({method:"PATCH",url:this._getWriteUrl(t),data:this._convertToDbFormat(t)})});this.itemsAdded.forEach(t=>{e.push({method:"POST",url:this._getWriteUrl(),data:this._convertToDbFormat(t)})});this.itemsRemoved.forEach(t=>{e.push({method:"DELETE",url:this._getWriteUrl(t)})});if(e.length){let i=(new Date).getTime().toString();wijmo_1.httpRequest(this._getServiceUrl()+"$batch",{method:"POST",requestHeaders:{"Content-Type":'multipart/mixed; boundary="'+i+'"'},data:this._encodeBatch(e,i),success:t=>{this.clearChanges();this.load()},error:t=>{if(this.onError(new wijmo_1.RequestErrorEventArgs(t)))throw"HttpRequest Error: "+t.status+" "+t.statusText},complete:e=>{wijmo_1.isFunction(t)&&t(e)}})}}}cancelChanges(){if(this.deferCommits){this.clearChanges();this.load()}}get hasPendingChanges(){return!!this.deferCommits&&(this.itemsAdded.length>0||this.itemsEdited.length>0||this.itemsRemoved.length>0)}get totalItemCount(){return this._count}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(t){if(t!=this._pgSz){this._pgSz=wijmo_1.asInt(t);if(this.pageOnServer){this._pgIdx=wijmo_1.clamp(this._pgIdx,0,this.pageCount-1);this._getData()}else this.refresh()}}onPageChanging(t){super.onPageChanging(t);!t.cancel&&this.pageOnServer&&this._getData();return!t.cancel}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_performRefresh(){let t=this._canFilter,e=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;super._performRefresh();this._canFilter=t;this._canSort=e}_updateHasChanges(){let t=this.hasPendingChanges;if(t!=this._hasPendingChanges){this._hasPendingChanges=t;this.onHasPendingChangesChanged()}}_storeItems(t,e){e?Array.prototype.push.apply(this.sourceCollection,t):this.sourceCollection=t}_getReadUrl(t){let e=this._getServiceUrl();t?e=0==t.indexOf("http")?t:e+t:this._tbl&&(e+=this._tbl);return e}_getReadParams(t){let e={};(!t||t.indexOf("$format")<0&&t.indexOf("%24format")<0)&&(e.$format="json");if(!t&&this._tbl){this._odv<4?e.$inlinecount="allpages":e.$count=!0;this.fields&&(e.$select=this.fields.join(","));this.expand&&(e.$expand=this.expand);if(this.sortOnServer&&this.sortDescriptions.length){let t="";this.sortDescriptions.forEach(e=>{t&&(t+=",");t+=e.property;e.ascending||(t+=" desc")});e.$orderby=t}if(this.pageOnServer&&this.pageSize>0){e.$skip=this.pageIndex*this.pageSize;e.$top=this.pageSize}this.filterDefinition&&(e.$filter=this.filterDefinition)}return e}_getData(t,e){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>{if(null==this._odv){this._getSchema();return}this._loading=!0;this.onLoading();let i=wijmo_1.httpRequest(this._getReadUrl(t),{requestHeaders:this.requestHeaders,data:this._getReadParams(t),success:e=>{let i=JSON.parse(e.responseText,this._reviverBnd),s=i.d?i.d.results:i.value,r=i.d?i.d.__count:i["odata.count"]||i["@odata.count"];null!=r&&(this._count=parseInt(r));if(this.pageIndex>0&&this.pageIndex>=this.pageCount){let t=this.pageIndex;this.moveToLastPage();if(this.pageIndex!=t)return}t||this.inferDataTypes&&!this._dataTypesInferred&&(this._dataTypesInferred=this._getInferredDataTypes(s));let a=this.dataTypes?this.dataTypes:this._dataTypesInferred;a&&s.forEach(t=>{this._convertItem(a,t)});this._storeItems(s,null!=t);this.refresh();if(t=i.d?i.d.__next:i["odata.nextLink"]||i["@odata.nextLink"])this._getData(t);else{this._loading=!1;this.onLoaded()}},error:t=>{this._loading=!1;this.onLoaded();if(this.onError(new wijmo_1.RequestErrorEventArgs(t)))throw"HttpRequest Error: "+t.status+" "+t.statusText}});wijmo_1.isFunction(e)&&e(i)},100)}_convertToDbFormat(t){let e={},i=this.calculatedFields;for(let s in t)if(!(i&&s in i)){let i=t[s];wijmo_1.isDate(i)&&this._showDatesAsGmt?i=new Date(i.getTime()-6e4*i.getTimezoneOffset()):wijmo_1.isNumber(i)&&this._odv<4&&(i=i.toString());e[s]=i}this.entityType&&(e["odata.type"]=this.entityType);return e}_reviver(t,e){if("string"==typeof e&&ODataCollectionView._rxDate.test(e)){e=0==e.indexOf("/Date(")?new Date(parseInt(e.substr(6))):new Date(e);wijmo_1.isDate(e)&&this._showDatesAsGmt&&(e=new Date(e.getTime()+6e4*e.getTimezoneOffset()))}return this._jsonReviver?this._jsonReviver(t,e):e}_convertItem(t,e){for(let i in t){let s=t[i],r=e[i];if(null!=r){r=s==wijmo_1.DataType.Date&&wijmo_1.isString(r)&&0==r.indexOf("/Date(")?new Date(parseInt(r.substr(6))):wijmo_1.changeType(r,s,null);wijmo_1.isDate(r)&&this._showDatesAsGmt&&(r=new Date(r.getTime()+6e4*r.getTimezoneOffset()));e[i]=r}}}_getInferredDataTypes(t){let e=null;if(t.length>0){let i={};t.forEach(t=>{this._extend(i,t)});for(let t in i){let s=i[t];if(wijmo_1.isString(s)&&ODataCollectionView._rxDate.test(s)){e||(e={});e[t]=wijmo_1.DataType.Date}}}return e}_getServiceUrl(){let t=this._url;"/"!=t[t.length-1]&&(t+="/");return t}_getSchema(){let t=this._getServiceUrl()+"$metadata",e=ODataCollectionView._odvCache;this._odv=e[t];this._odv?this._getData():wijmo_1.httpRequest(t,{requestHeaders:this.requestHeaders,success:i=>{let s=i.responseText.match(/<.*Version\s*=\s*"([0-9.]+)"/),r=s?parseFloat(s[1]):4;e[t]=this._odv=r},error:i=>{e[t]=this._odv=4},complete:t=>{this._getData()}})}_getWriteUrl(t){let e=this._getServiceUrl()+this._tbl;if(t){wijmo_1.assert(this.keys&&this.keys.length>0,"write operations require keys.");let i=[];this.keys.forEach(e=>{let s=t[e];null==s&&(s="");wijmo_1.isString(s)&&(s="'"+s+"'");i.push(1==this.keys.length?s:e+"="+s)});i.length&&(e+="("+i.join(",")+")")}return e}_asODataFilter(t){let e="";for(let i=0;i<t.grid.columns.length;i++){let s=t.grid.columns[i],r=t.getColumnFilter(s,!1);if(r&&r.isActive){e&&(e+=" and ");r.conditionFilter&&r.conditionFilter.isActive?e+=this._asODataConditionFilter(r.conditionFilter):r.valueFilter&&r.valueFilter.isActive&&(e+=this._asODataValueFilter(r.valueFilter))}}return e}_asODataValueFilter(t){let e=t.column,i=e.binding,s=e.dataMap,r="";for(let a in t.showValues){let t=wijmo_1.changeType(a,e.dataType,e.format);s&&wijmo_1.isString(t)&&(t=s.getKeyValue(t));r&&(r+=" or ");r+=this._asEquals(i,t,e.dataType)}r.length&&(r="("+r+")");return r}_asEquals(t,e,i){let s="",r=wijmo_1.DataType;if(""===e||null==e){s+=t+" eq null";i==r.String&&(s+=" or "+t+" eq ''")}else i==r.Date?s+=t+" ge "+this._asODataValue(e,i)+" and "+t+" lt "+this._asODataValue(wijmo_1.DateTime.addDays(e,1),i):s+=t+" eq "+this._asODataValue(e,i);return"("+s+")"}_asODataConditionFilter(t){let e=this._asODataCondition(t,t.condition1),i=this._asODataCondition(t,t.condition2);return e&&i?"("+e+(t.and?" and ":" or ")+i+")":e?"("+e+")":i?"("+i+")":null}_asODataCondition(t,e){let i=t.column,s=i.binding,r=i.dataMap,a=e.value;r&&wijmo_1.isString(a)&&(a=r.getKeyValue(a));a=this._asODataValue(a,t.column.dataType);switch(e.operator){case 0:return s+" eq "+a;case 1:return s+" ne "+a;case 2:return s+" gt "+a;case 3:return s+" ge "+a;case 4:return s+" lt "+a;case 5:return s+" le "+a;case 6:return"startswith("+s+","+a+")";case 7:return"endswith("+s+","+a+")";case 8:return this._odv>=4?"contains("+s+","+a+")":"substringof("+a.toLowerCase()+", tolower("+s+"))";case 9:return this._odv>=4?"not contains("+s+","+a+")":"not substringof("+a.toLowerCase()+", tolower("+s+"))"}}_asODataValue(t,e){if(wijmo_1.isDate(t)){this._showDatesAsGmt&&(t=new Date(t.getTime()-6e4*t.getTimezoneOffset()));t=t.toJSON();this._odv<4&&(t="datetime'"+t.substr(0,10)+"'");return t}return wijmo_1.isString(t)?"'"+t.replace(/'/g,"''")+"'":null!=t?t.toString():e==wijmo_1.DataType.String?"''":null}_error(t){if(this.onError(new wijmo_1.RequestErrorEventArgs(t))){this._getData();throw"HttpRequest Error: "+t.status+" "+t.statusText}}_encodeBatch(t,e){let i=[],s="changeset-"+e;i.push("--"+e,"Content-Type: multipart/mixed; boundary="+s,"");t.forEach((t,e)=>{i.push("--"+s,"Content-Type: application/http","Content-Transfer-Encoding: binary","Content-ID: "+e,"",t.method.toUpperCase()+" "+t.url+" HTTP/1.1","Host: "+location.host);t.data&&i.push("Content-Type: application/json","",JSON.stringify(t.data));i.push("")});i.push("--"+s+"--","");i.push("--"+e+"--","");return i.join("\r\n")}}ODataCollectionView._odvCache={};ODataCollectionView._rxDate=/^\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}|\/Date\([\d\-]*?\)/;exports.ODataCollectionView=ODataCollectionView;const _MIN_DATA_WINDOW=100;class ODataVirtualCollectionView extends ODataCollectionView{constructor(t,e,i){super(t,e,{pageOnServer:!0,sortOnServer:!0,canGroup:!1});this._start=0;this._end=100;this._refresh=!1;wijmo_1.copy(this,i);this._data=[];this.sourceCollection=this._data;this._firstLoad=!0;this.setWindow(0,_MIN_DATA_WINDOW)}setWindow(t,e){this._toSetWindow&&clearTimeout(this._toSetWindow);this._toSetWindow=setTimeout(()=>{this._toSetWindow=null;this._performSetWindow(t,e)},50)}get requestCanceled(){this._requestCanceled||(this._requestCanceled=new wijmo_1.Event);return this._requestCanceled}onRequestCanceled(t){this.requestCanceled.raise(this,t)}get pageOnServer(){return!0}set pageOnServer(t){if(!t)throw"ODataVirtualCollectionView requires pageOnServer = true."}get sortOnServer(){return!0}set sortOnServer(t){if(!wijmo_1.asBoolean(t))throw"ODataVirtualCollectionView requires sortOnServer = true."}get filterOnServer(){return!0}set filterOnServer(t){if(!wijmo_1.asBoolean(t))throw"ODataVirtualCollectionView requires filterOnServer = true."}get canGroup(){return this._canGroup}set canGroup(t){if(wijmo_1.asBoolean(t))throw"ODataVirtualCollectionView does not support grouping."}_performRefresh(){this.isLoading||(this._refresh=!0);super._performRefresh()}_getReadParams(t){let e=super._getReadParams(t);if(!t){e.$skip=this._start||0;e.$top=this._fetchSize()}return e}_storeItems(t,e){if(this._refresh||this._data.length!=this.totalItemCount){this._data.length=this.totalItemCount;for(let t=0;t<this._data.length;t++)this._data[t]=new _NullValue(t);this._refresh=!1}e||(this._loadOffset=0);let i=this._loadOffset+(this._start||0);for(let e=0;e<t.length;e++)this._data[e+i]=t[e];this._loadOffset+=t.length;setTimeout(()=>{this._firstLoad&&this.currentPosition<0&&t.length&&this.moveCurrentToFirst();this._firstLoad=!1})}_performSetWindow(t,e){if(this._pendingRequest){this._pendingRequest.abort();this._pendingRequest=null;this.onRequestCanceled()}t=wijmo_1.asInt(t);e=wijmo_1.asInt(e);wijmo_1.assert(t<=e,"start must be <= end.");let i=t<this._start,s=this._data;this._start=this._end=t;for(let i=t;i<=e&&i<s.length;i++)if(s[i]instanceof _NullValue){this._start=i;break}for(let t=e;t>=this._start&&t<s.length;t--)if(s[t]instanceof _NullValue){this._end=t;break}if(this._start!=this._end||s[this._start]instanceof _NullValue){i&&(this._start=Math.max(0,this._end-this._fetchSize()+1));this._getData(null,t=>{this._pendingRequest=t})}}_fetchSize(){return Math.max(this._end-this._start+1,this.pageSize,_MIN_DATA_WINDOW)}}exports.ODataVirtualCollectionView=ODataVirtualCollectionView;class _NullValue{constructor(t){this._id=t}}wijmo_1._registerModule("wijmo.odata",selfModule);