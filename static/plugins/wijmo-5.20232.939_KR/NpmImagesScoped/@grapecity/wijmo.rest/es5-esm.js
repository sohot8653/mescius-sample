/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}(),__awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,n){function fulfilled(e){try{step(o.next(e))}catch(e){n(e)}}function rejected(e){try{step(o.throw(e))}catch(e){n(e)}}function step(e){e.done?i(e.value):new r((function(t){t(e.value)})).then(fulfilled,rejected)}step((o=o.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,o,i,n,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return n={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function verb(n){return function(a){return function step(n){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(i=2&n[0]?o.return:n[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,n[1])).done)return i;(o=0,i)&&(n=[2&n[0],i.value]);switch(n[0]){case 0:case 1:i=n;break;case 4:s.label++;return{value:n[1],done:!1};case 5:s.label++;o=n[1];n=[0];continue;case 7:n=s.ops.pop();s.trys.pop();continue;default:if(!(i=s.trys,i=i.length>0&&i[i.length-1])&&(6===n[0]||2===n[0])){s=0;continue}if(3===n[0]&&(!i||n[1]>i[0]&&n[1]<i[3])){s.label=n[1];break}if(6===n[0]&&s.label<i[1]){s.label=i[1];i=n;break}if(i&&s.label<i[2]){s.label=i[2];s.ops.push(n);break}i[2]&&s.ops.pop();s.trys.pop();continue}n=t.call(e,s)}catch(e){n=[6,e];o=0}finally{r=i=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,a])}}};import{asArray,asBoolean,asInt,copy,clamp,CollectionView,Event,CancelEventArgs,_registerModule}from"@grapecity/wijmo";import*as selfModule from"@grapecity/wijmo.rest";var RestCollectionView=function(e){__extends(RestCollectionView,e);function RestCollectionView(t){var r=e.call(this)||this;r._loading=!1;r._fields=null;r._keys=null;r._sortOnServer=!0;r._pageOnServer=!0;r._filterOnServer=!0;r._totalItemCount=0;r.loading=new Event;r.loaded=new Event;r.error=new Event;t&&copy(r,t);r.sortDescriptions.collectionChanged.addHandler((function(){r.sortOnServer&&r._getData()}));r._getData();return r}Object.defineProperty(RestCollectionView.prototype,"fields",{get:function(){return this._fields},set:function(e){if(this._fields!=e){this._fields=asArray(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(RestCollectionView.prototype,"sortOnServer",{get:function(){return this._sortOnServer},set:function(e){if(e!=this._sortOnServer){this._sortOnServer=asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(RestCollectionView.prototype,"pageOnServer",{get:function(){return this._pageOnServer},set:function(e){if(e!=this._pageOnServer){this._pageOnServer=asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(RestCollectionView.prototype,"filterOnServer",{get:function(){return this._filterOnServer},set:function(e){if(e!=this._filterOnServer){this._filterOnServer=asBoolean(e);this._getData()}},enumerable:!0,configurable:!0});Object.defineProperty(RestCollectionView.prototype,"requestHeaders",{get:function(){return this._requestHeaders},set:function(e){this._requestHeaders=e},enumerable:!0,configurable:!0});RestCollectionView.prototype.updateFilterDefinition=function(e){if(this.filterOnServer){this._filterProvider=e;this._getData()}};Object.defineProperty(RestCollectionView.prototype,"isLoading",{get:function(){return this._loading},enumerable:!0,configurable:!0});RestCollectionView.prototype.onLoading=function(e){this.loading.raise(this,e)};RestCollectionView.prototype.onLoaded=function(e){this.loaded.raise(this,e)};RestCollectionView.prototype.load=function(){this._getData()};RestCollectionView.prototype.onError=function(e){this.error.raise(this,e);return!e.cancel};RestCollectionView.prototype._performRefresh=function(){var t=this._canFilter,r=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;e.prototype._performRefresh.call(this);this._canFilter=t;this._canSort=r};Object.defineProperty(RestCollectionView.prototype,"totalItemCount",{get:function(){return this.pageOnServer?this._totalItemCount:this._view.length},enumerable:!0,configurable:!0});Object.defineProperty(RestCollectionView.prototype,"pageCount",{get:function(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1},enumerable:!0,configurable:!0});Object.defineProperty(RestCollectionView.prototype,"pageSize",{get:function(){return this._pgSz},set:function(e){if(e!=this._pgSz){this._pgSz=asInt(e);if(this.pageOnServer){this._pgIdx=clamp(this._pgIdx,0,this.pageCount-1);this._getData()}else this.refresh()}},enumerable:!0,configurable:!0});RestCollectionView.prototype.onPageChanging=function(t){e.prototype.onPageChanging.call(this,t);this.pageOnServer&&!t.cancel&&this._getData();return!t.cancel};RestCollectionView.prototype.commitNew=function(){var t=this,r=this.currentAddItem;if(r)try{var o=this.addItem(r);o&&o.then&&o.then((function(){return t.refresh()}))}catch(e){this._raiseError(e,!0)}e.prototype.commitNew.call(this)};RestCollectionView.prototype.commitEdit=function(){var t=this,r=this.currentEditItem;if(r&&!this.currentAddItem&&!this._sameContent(r,this._edtClone)&&this.items.indexOf(r)>-1)try{var o=this.patchItem(r);o&&o.then&&o.then((function(){return t.refresh()}))}catch(e){this._raiseError(e,!0)}e.prototype.commitEdit.call(this)};RestCollectionView.prototype.remove=function(t){var r=this;if(t&&t!=this.currentAddItem&&this.items.indexOf(t)>-1)try{var o=this.deleteItem(t);o&&o.then&&o.then((function(){return r.refresh()}))}catch(e){this._raiseError(e,!0)}e.prototype.remove.call(this,t)};RestCollectionView.prototype._getPageView=function(){return this.pageOnServer?this._view:e.prototype._getPageView.call(this)};RestCollectionView.prototype._getData=function(){var e=this;this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout((function(){return __awaiter(e,void 0,void 0,(function(){var e,t,r,o;return __generator(this,(function(i){switch(i.label){case 0:this._toGetData=null;this._loading=!0;this.onLoading();e=null;t=null;i.label=1;case 1:i.trys.push([1,3,,4]);r=this.currentPosition;return[4,this.getItems()];case 2:e=i.sent();this.sourceCollection=e;this.refresh();r>-1&&this.moveCurrentToPosition(r);this.pageIndex>0&&this.pageIndex>=this.pageCount&&this.moveToLastPage();return[3,4];case 3:o=i.sent();t=o;return[3,4];case 4:this._loading=!1;this.onLoaded();t&&this._raiseError(t,!1);return[2]}}))}))}),100)};RestCollectionView.prototype._raiseError=function(e,t){if(this.onError(new RESTErrorEventArgs(e))){t&&this._getData();throw"Server Error: "+e}};RestCollectionView.prototype.getItems=function(){throw"This method is virtual: it should be overridden"};RestCollectionView.prototype.addItem=function(e){throw"This method is virtual: it should be overridden"};RestCollectionView.prototype.patchItem=function(e){throw"This method is virtual: it should be overridden"};RestCollectionView.prototype.deleteItem=function(e){throw"This method is virtual: it should be overridden"};return RestCollectionView}(CollectionView);export{RestCollectionView};var RESTErrorEventArgs=function(e){__extends(RESTErrorEventArgs,e);function RESTErrorEventArgs(t){var r=e.call(this)||this;r._error=t;return r}Object.defineProperty(RESTErrorEventArgs.prototype,"error",{get:function(){return this._error},enumerable:!0,configurable:!0});return RESTErrorEventArgs}(CancelEventArgs);export{RESTErrorEventArgs};_registerModule("wijmo.rest",selfModule);