/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

import{_getModule,Control,Globalize,DataType,asBoolean,isString,isNumber,isInt,isDate,isFunction,isNullOrWhiteSpace,isObject,asEnum,getType,copy,_deprecated,_registerModule}from"@grapecity/wijmo";import{FlexGrid,Row,GroupRow,Column,CellRange,CellRangeEventArgs,RowColFlags,CellType,_NewRowTemplate}from"@grapecity/wijmo.grid";import*as mXlsx from"@grapecity/wijmo.xlsx";import*as selfModule from"@grapecity/wijmo.grid.xlsx";export function softDetail(){return _getModule("wijmo.grid.detail")}export function softMultiRow(){return _getModule("wijmo.grid.multirow")}export function softTransposed(){return _getModule("wijmo.grid.transposed")}export function softTransposedMultiRow(){return _getModule("wijmo.grid.transposedmultirow")}export class FlexGridXlsxConverter{static save(e,l,t,o){let s=new mXlsx.Workbook;this._saveFlexGridToWorkbook(s,e,l,!1,null,void 0,o);t&&s.save(t);return s}static saveAsync(e,l,t,o,s,r,n,i){let a=new mXlsx.Workbook;if(!n){this._saveFlexGridToWorkbook(a,e,l,!1,null,void 0,i);t?a.saveAsync(t,e=>{isFunction(o)&&o(e,a)},s,null):isFunction(o)&&o(null,a);return a}let d=null!=t;this.cancelAsync(()=>{let n,u=[e.collectionView&&e.collectionView.collectionChanged,e.columns&&e.columns.collectionChanged,e.rows&&e.rows.collectionChanged,e.resizedColumn,e.resizedRow],removeHandlers=()=>u.forEach(e=>{e&&e.removeHandler(restart)}),restart=()=>{this._cs&&this._cs.cancel(!1);clearTimeout(n);n=setTimeout(()=>{removeHandlers();a=null;this.saveAsync(e,l,t,o,s,r,void 0,i)},100)},finish=()=>{clearTimeout(n);this._cs=null;removeHandlers()};this._cs=new mXlsx._SyncPromise(null,finish);u.forEach(e=>{e&&e.addHandler(restart)});this._saveFlexGridToWorkbook(a,e,l,!0,this._cs,e=>{isFunction(r)&&r(d?Math.round(mXlsx._map(e,0,100,0,50)):e)},i).then(()=>{if(t){a._externalCancellation=()=>this._cs;a.saveAsync(t,e=>{finish();isFunction(o)&&o(e,a)},e=>{finish();isFunction(s)&&s(e)},e=>{isFunction(r)&&r(Math.round(mXlsx._map(e,0,100,51,100)))})}else{finish();isFunction(r)&&r(100);isFunction(o)&&o(null,a)}},e=>{finish();throw e})});return null}static cancelAsync(e){if(this._cs){this._cs.cancel();setTimeout(()=>{this._cs=null;isFunction(e)&&e()},100)}else isFunction(e)&&e()}static load(e,l,t){if(l instanceof Blob)_blobToBuffer(l,o=>{l=null;let s=new mXlsx.Workbook;s.load(o,t?t.includeStyles:void 0);o=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,s,t);s=null})});else if(l instanceof mXlsx.Workbook)e.deferUpdate(()=>{this._loadToFlexGrid(e,l,t);l=null});else{if(!(l instanceof ArrayBuffer||isString(l)))throw"Invalid workbook.";let o=new mXlsx.Workbook;o.load(l,t?t.includeStyles:void 0);l=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,o,t);o=null})}}static loadAsync(e,l,t,o,s){if(l instanceof Blob)_blobToBuffer(l,r=>{l=null;let n=new mXlsx.Workbook;n.loadAsync(r,()=>{r=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,n,t);o&&o(n);n=null})},s,t?t.includeStyles:void 0)});else if(l instanceof mXlsx.Workbook)e.deferUpdate(()=>{this._loadToFlexGrid(e,l,t);o&&o(l);l=null});else{if(!(l instanceof ArrayBuffer||isString(l)))throw"Invalid workbook.";let r=new mXlsx.Workbook;r.loadAsync(l,()=>{l=null;e.deferUpdate(()=>{this._loadToFlexGrid(e,r,t);o&&o(r);r=null})},s,t?t.includeStyles:void 0)}}static _saveFlexGridToWorkbook(e,l,t,o,s,r,n){let i=new mXlsx._SyncPromise(s),a=new mXlsx.WorkSheet,d=!t||null==t.includeColumnHeaders||t.includeColumnHeaders,u=!(!t||null==t.includeRowHeaders)&&t.includeRowHeaders,c=_ExportCellStyles.Cache,h=t?t.includeColumns:null,f=t?t.formatItem:null,m=[],p=t&&null!=t.convertHtmlEntities?asEnum(t.convertHtmlEntities,HtmlEntityConversion):HtmlEntityConversion.Auto;if(t){null!=t.includeCellStyles&&_deprecated("includeCellStyles","includeStyles");c=!1===asBoolean(null!=t.includeStyles?t.includeStyles:t.includeCellStyles,!0)?_ExportCellStyles.None:!1===asBoolean(t.quickCellStyles,!0)?_ExportCellStyles.Regular:_ExportCellStyles.Cache}let g=c===_ExportCellStyles.Cache?new _StyleCache(500):null;null==this.hasCssText&&(this.hasCssText="cssText"in document.body.style);a.name=t?t.sheetName:"";a.visible=!t||!1!==t.sheetVisible;a.rightToLeft=l.rightToLeft;let x,w=l.wj_sheetInfo;if(w&&w.tables&&w.tables.length>0)for(let e=0;e<w.tables.length;e++)a.tables.push(w.tables[e]);if(!w&&(c!==_ExportCellStyles.None||f)){(x=document.createElement("div")).style.visibility="hidden";x.setAttribute(FlexGrid._WJS_MEASURE,"true");l.hostElement.appendChild(x)}let y=u?l.rowHeaders.columns.length:0,_=this._getPerRowColumnsSettings(l,u?[l.topLeftCells,l.columnHeaders]:[l.columnHeaders]),C=_.cols,b=softMultiRow()&&l instanceof softMultiRow().MultiRow?this._getPerRowColumnsSettings(l,u?[l.rowHeaders,l.cells]:[l.cells],l.rowsPerItem).cols:null,S=C.length,T=[[l.topLeftCells,l.columnHeaders],[l.rowHeaders,l.cells],[l.bottomLeftCells,l.columnFooters]];d||T.shift();let k=T.map(e=>e[1].rows.length).reduce((e,l)=>e+l);C.length&&C[0].forEach((e,l)=>{let t=_.bndCols[0][l];if(l>=y&&h&&!h(t))return;let o=new mXlsx.WorkbookColumn;o._deserialize(e);a._addWorkbookColumn(o)});this._saveContentToWorksheet(s,o,Date.now(),0,{panels:T,panelIdx:0,globRowIdx:0,rowsOffset:0,totalRows:k},l,a,u,e=>e==CellType.Cell&&b?b:C,c,x,m,g,h,p,f,e=>{r(Math.round(e/k*100))},()=>{let o=new mXlsx.WorkbookFrozenPane;o.rows=d?l.rows.frozen+S:l.rows.frozen;o.columns=u?l.columns.frozen+y:l.columns.frozen;let s=Math.min(l.columns.length,l.columns.frozen);if(h)for(var r=0;r<s;r++)h(l.columns[r])||o.columns--;a.frozenPane=o;e._addWorkSheet(a);if(!w&&(c!==_ExportCellStyles.None||f)){l.hostElement.removeChild(x);m.forEach(e=>e.forEach(e=>{e&&e.parentElement&&e.parentElement.removeChild(e)}))}g&&g.clear();e.activeWorksheet=t?t.activeWorksheet:null;i.resolve()},n);return i}static _saveContentToWorksheet(e,l,t,o,s,r,n,i,a,d,u,c,h,f,m,p,g,x,w){let y=w||(d?20:200);for(let _=o;_<s.totalRows;_++){if(e&&e.cancelled)return;if(l&&_-o>y&&Date.now()-t>100){setTimeout(()=>{if(!e||!e.cancelled){g(_);this._saveContentToWorksheet(e,l,Date.now(),_,s,r,n,i,a,d,u,c,h,f,m,p,g,x,w)}},0);return}for(;_-s.rowsOffset>=s.panels[s.panelIdx][1].rows.length;){s.rowsOffset+=s.panels[s.panelIdx][1].rows.length;s.panelIdx++}let C=s.panels[s.panelIdx],b=C[0],S=C[1],T=_-s.rowsOffset,k=S.rows[T];if(S.cellType!==CellType.Cell&&k.renderSize<=0||k instanceof _NewRowTemplate)continue;let v=0,R={},W=new mXlsx.WorkbookRow,X=k instanceof GroupRow,A=0;S.cellType===CellType.Cell&&(X?A=k.level:r.rows.maxGroupLevel>-1&&(A=r.rows.maxGroupLevel+1));let E=a(S.cellType);i&&(v=this._parseFlexGridRowToSheetRow(n,b,R,T,0,E,d,u,c,h,X,A,f,m,p));this._parseFlexGridRowToSheetRow(n,S,R,T,v,E,d,u,c,h,X,A,f,m,p);if(R.cells.length>0){W._deserialize(R);n._addWorkbookRow(W,s.globRowIdx)}s.globRowIdx++}isFunction(x)&&x()}static _loadToFlexGrid(e,l,t){if(softTransposedMultiRow()&&e instanceof softTransposedMultiRow().TransposedMultiRow)throw"Not supported.";t=t||{};let o,s=null!=e.wj_sheetInfo,r={},n=[],i=[],a={};e.itemsSource=null;e.columns.clear();e.columnHeaders.rows.clear();e.rows.clear();e.columns.frozen=0;e.rows.frozen=0;let d=null==t.sheetIndex||isNaN(t.sheetIndex)?0:t.sheetIndex;if(d<0||d>=l.sheets.length)throw"The sheet index option is out of the sheet range of current workbook.";if(null!=t.sheetName)for(let e=0;e<l.sheets.length;e++)if(t.sheetName===l.sheets[e].name){o=l.sheets[e];break}if(null==(o=o||l.sheets[d]).rows)return;let u=this._getColumnCount(o.rows),c=this._getRowCount(o.rows,u),h=o.columns;for(let l=0;l<u;l++){e.columns.push(new Column);if(h[l]){isNaN(+h[l].width)||(e.columns[l].width=+h[l].width);h[l].visible||null==h[l].visible||(e.columns[l].visible=!!h[l].visible);h[l].style&&h[l].style.wordWrap&&(e.columns[l].wordWrap=h[l].style.wordWrap)}}let f,m=(null==t.includeColumnHeaders||t.includeColumnHeaders)&&o.rows.length>0,p=m?this._getColumnHeadersHeight(o):0,g=!1,x=[],w=o.frozenPane&&o.frozenPane.rows,y=o.frozenPane&&o.frozenPane.columns;w=isNumber(w)&&!isNaN(w)?w:null;y=isNumber(y)&&!isNaN(y)?y:null;for(let l=p;l<c;l++){let t=!1,d=null,c=o.rows[l];if(c){let e=l+1;for(;e<o.rows.length;){let l=o.rows[e];if(l){(isNaN(c.groupLevel)&&!isNaN(l.groupLevel)||!isNaN(c.groupLevel)&&c.groupLevel<l.groupLevel)&&(t=!0);break}e++}}if(t&&!o.summaryBelow){f&&(f.isCollapsed=g);(f=new GroupRow).isReadOnly=!1;g=null!=c.collapsed&&c.collapsed;f.level=isNaN(c.groupLevel)?0:c.groupLevel;a[f.level]=g;this._checkParentCollapsed(a,f.level)&&f._setFlag(RowColFlags.ParentCollapsed,!0);e.rows.push(f)}else{let l=new Row;c&&this._checkParentCollapsed(a,c.groupLevel)&&l._setFlag(RowColFlags.ParentCollapsed,!0);e.rows.push(l)}c&&c.height&&!isNaN(c.height)&&(e.rows[l-p].height=c.height);for(let o=0;o<u;o++)if(c){let a=c.cells[o],h=a?a.formula:null;h&&"="!==h[0]&&(h="="+h);if(a&&a.textRuns&&a.textRuns.length>0){e.rows[l-p].isContentHtml=!0;e.setCellData(l-p,o,this._parseTextRunsToHTML(a.textRuns))}else{let t=h&&s?h:this._getItemValue(a);e.setCellData(l-p,o,t,""!=t)}t||this._setColumn(x,o,a);let f=l*u+o,m=a?a.style:null;if(m){d=null==d?!!m.wordWrap:d&&!!m.wordWrap;if(s){let e,t=mXlsx.Workbook._parseExcelFormat(a);if(m.hAlign)e=mXlsx.Workbook._parseHAlignToString(asEnum(m.hAlign,mXlsx.HAlign));else switch(this._getItemType(a)){case DataType.Number:e="right";break;case DataType.Boolean:e="center";break;default:e=t&&0===t.search(/[n,c,p]/i)?"right":"left"}r[f]={fontWeight:m.font&&m.font.bold?"bold":"none",fontStyle:m.font&&m.font.italic?"italic":"none",textDecoration:m.font&&m.font.underline?"underline":"none",textAlign:e,fontFamily:m.font&&m.font.family?m.font.family:"",fontSize:m.font&&m.font.size?m.font.size+"px":"",color:m.font&&m.font.color?m.font.color:"",backgroundColor:m.fill&&m.fill.color?m.fill.color:"",whiteSpace:m.wordWrap?"pre-wrap":"normal",format:t};if(m.borders){if(m.borders.left){this._parseBorderStyle(m.borders.left.style,"Left",r[f]);r[f].borderLeftColor=m.borders.left.color}if(m.borders.right){this._parseBorderStyle(m.borders.right.style,"Right",r[f]);r[f].borderRightColor=m.borders.right.color}if(m.borders.top){this._parseBorderStyle(m.borders.top.style,"Top",r[f]);r[f].borderTopColor=m.borders.top.color}if(m.borders.bottom){this._parseBorderStyle(m.borders.bottom.style,"Bottom",r[f]);r[f].borderBottomColor=m.borders.bottom.color}}if(m.fill&&m.fill.color){let e=r[f],t=m.borders,s=m.fill.color;if(t){t.left&&t.left.color||(e.borderLeftColor=s);t.right&&t.right.color||o===y-1||(e.borderRightColor=s);t.top&&t.top.color||(e.borderTopColor=s);t.bottom&&t.bottom.color||l===w-1||(e.borderBottomColor=s)}else{e.borderLeftColor=s;o!==y-1&&(e.borderRightColor=s);e.borderTopColor=s;l!==w-1&&(e.borderBottomColor=s)}}m.font&&-1===i.indexOf(m.font.family)&&i.push(m.font.family)}}s&&a&&isNumber(a.rowSpan)&&a.rowSpan>0&&isNumber(a.colSpan)&&a.colSpan>0&&(a.rowSpan>1||a.colSpan>1)&&n.push(new CellRange(l,o,l+a.rowSpan-1,o+a.colSpan-1))}if(c){this._checkParentCollapsed(a,c.groupLevel)||c.visible||null==c.visible||(e.rows[l-p].visible=c.visible);e.rows[l-p].wordWrap=!!c.style&&!!c.style.wordWrap||!!d}}f&&(f.isCollapsed=g);null!=y&&(e.columns.frozen=y);null!=w&&(e.rows.frozen=m&&w>0?w-1:w);for(let l=0;l<e.columnHeaders.columns.length;l++){let t=x[l],o=e.columns[l];o.isRequired=!1;if(t){t.dataType===DataType.Boolean&&(o.dataType=t.dataType);o.format=t.format;o.align=t.hAlign;o.wordWrap=o.wordWrap||!!t.wordWrap}}for(let l=0;l<Math.max(p,1);l++)e.columnHeaders.rows.push(new Row);for(let l=0;l<p;l++)for(let t=0;t<e.columnHeaders.columns.length;t++){let s=o.rows[l]?o.rows[l].cells[t]:null,r=s&&null!=s.value?s.value:"",n=e.columnHeaders.columns[t];if(r){let e=mXlsx.Workbook._parseExcelFormat(s);r=Globalize.format(r,e)}n.header=n.header||r;e.columnHeaders.setCellData(l,t,r)}if(s){let l=null!=t.sheetVisible?t.sheetVisible:!1!==o.visible;e.wj_sheetInfo.name=o.name;e.wj_sheetInfo.visible=l;e.wj_sheetInfo.styledCells=r;e.wj_sheetInfo.mergedRanges=n;e.wj_sheetInfo.fonts=i;e.wj_sheetInfo.tables=o.tables}}static _getColumnHeadersHeight(e){let l;if(!e||!(l=e.rows).length)return 0;if(!l[0])return 1;let t=0;for(let e=1;t<l.length&&e>0;t++,e--){let o=l[t].cells.reduce((e,l)=>Math.max(e,l.rowSpan||0),1);o>e&&(e=o)}return t}static _escapePlainText(e){return null==e?"":""===e?"'":"'"===e[0]||e.length>1&&"="===e[0]&&"="===e[1]?"'"+e:e}static _parseFlexGridRowToSheetRow(e,l,t,o,s,r,n,i,a,d,u,c,h,f,m){let p=l.grid,g=p.wj_sheetInfo,x=l.rows[o],w=0,y=g&&g.evaluateFormula;null==x.recordIndex?l.cellType===CellType.ColumnHeader&&l.rows.length>1&&(w=Math.min(o,r.length-1)):w=x.recordIndex;t.cells||(t.cells=[]);t.visible=x.isVisible;t.height=x.renderHeight||l.rows.defaultSize;t.groupLevel=c;u&&(t.collapsed=x.isCollapsed);x.wordWrap&&(t.style={wordWrap:x.wordWrap});let _,C=x.constructor===Row||x.constructor===_NewRowTemplate||softTransposed()&&p instanceof softTransposed().TransposedGrid&&x instanceof Row||softDetail()&&x.constructor===softDetail().DetailRow||softMultiRow()&&x.constructor===softMultiRow()._MultiRow||softTransposedMultiRow()&&x instanceof softTransposedMultiRow()._MultiRow,b=softDetail()&&x.constructor===softDetail().DetailRow,S=0;const T=Math.round(mXlsx._xlsx._parsePixelToCharWidth(p.treeIndent)||0),getTreeIndent=e=>e*T;let k=!1;for(;S<l.columns.length;S++){let T,v,R,W=1,X=1,A=!1,E=p._getBindingColumn(l,o,l.columns[S]),F=0;if(g&&l===p.cells){let e=o*l.columns.length+S;g.mergedRanges&&(T=this._getMergedRange(o,S,g.mergedRanges));g.styledCells&&(v=g.styledCells[e])}else if(n!==_ExportCellStyles.None){R=this._getMeasureCell(l,S,i,a);v=(T=p.getMergedRange(l,o,S,!1))?this._getCellStyle(l,R,T.bottomRow,T.rightCol,d,!!m)||{}:this._getCellStyle(l,R,o,S,d,!!m)||{}}T||(T=p.getMergedRange(l,o,S,!1));if(T){if(o===T.topRow&&S===T.leftCol){X=T.bottomRow-T.topRow+1;W=this._getColSpan(l,T,h);A=!0}if(S>T.leftCol&&S<=T.rightCol&&k){A=!0;k=!1;W=T.rightCol-S+1}}else A=!0;if(h&&!h(E)){k=A;continue}let H,N,M,B,D,I,z,L=r[w]?r[w][S+s]:null;if(C||u){M=A?l.getCellData(o,S,!0):null;B=A?l.getCellData(o,S,!1):null;N=this._isFormula(M);H=null;D=isDate(B);if(l.cellType===CellType.ColumnHeader&&isString(M))z="General";else if(v&&v.format){I={d:"M/d/yyyy",D:"dddd, MMMM dd, yyyy"}[I=v.format]||I;/[hsmyt\:]/i.test(I)&&(D=!0);z=mXlsx.Workbook._parseCellFormat(v.format,D)}else if(L&&L.style&&L.style.format){I=E.format;z=L.style.format}else z=null;N&&null!=y&&isFunction(y)&&(H=y(M));if(!z)if(D)z="m/d/yyyy";else if(isNumber(B)&&!E.dataMap)z=isInt(B)?"#,##0":"#,##0.00";else if(N){let e=M.toLowerCase();if(e.indexOf("now()")>-1){z="m/d/yyyy h:mm";D=!0}else if(e.indexOf("today()")>-1||e.indexOf("date(")>-1){z="m/d/yyyy";D=!0}else if(e.indexOf("time(")>-1){z="h:mm AM/PM";D=!0}}else z="General"}else{M=A?p.columnHeaders.getCellData(0,S,!0):null;z="General"}let G=void 0;if(isString(M)&&"{"!==M[0]&&-1!==M.indexOf("<span")){G=this._parseToTextRuns(M);M=null}let O=this._parseCellStyle(v)||{};if(l===p.cells&&u&&x.hasChildren&&S===p.columns.firstVisibleIndex){let l;if(N&&null!=H)l=H;else{M?l=M:A&&(l=x.getGroupHeader());l&&(l=l.replace(/<\/?\w+>/g,"").replace(/&#39;/g,"'"))}if(null==l&&!v)continue;!(D=isDate(l))&&I&&"d"===I.toLowerCase()&&isInt(l)&&(z="0");l=isString(l)?mXlsx.Workbook._unescapeXML(l):l;S===p.columns.firstVisibleIndex&&p.treeIndent&&(F=getTreeIndent(c));_={value:l,isDate:D,formula:N?this._parseToExcelFormula(M,D):null,colSpan:W,rowSpan:X,style:this._extend(O,{format:z,font:p.childItemsPath?{}:{bold:!0},hAlign:e.rightToLeft?mXlsx.HAlign.Right:mXlsx.HAlign.Left,indent:F}),textRuns:G}}else{if(u||f===HtmlEntityConversion.Auto&&E.isContentHtml||f===HtmlEntityConversion.Yes){M=isString(M)?mXlsx.Workbook._unescapeXML(M):M;B=isString(B)?mXlsx.Workbook._unescapeXML(B):B}!D&&I&&"d"===I.toLowerCase()&&isInt(B)&&(z="0");let t,o;t=O&&O.hAlign?O.hAlign:L&&L.style&&null!=L.style.hAlign?asEnum(L.style.hAlign,mXlsx.HAlign,!0):isDate(B)?mXlsx.HAlign.Left:mXlsx.HAlign.General;l===p.cells&&S===p.columns.firstVisibleIndex&&p.treeIndent&&(e.rightToLeft&&t===mXlsx.HAlign.Right||!e.rightToLeft&&t===mXlsx.HAlign.Left||t===mXlsx.HAlign.General)&&(F=getTreeIndent(c));v&&v.verticalAlign&&(o=mXlsx.Workbook._parseStringToVAlign(v.verticalAlign));_={value:N?H:"General"!==z||""===M&&null==B||!0===B||!1===B?this._escapePlainText(B):this._escapePlainText(M),isDate:D,formula:N?this._parseToExcelFormula(M,D):null,colSpan:S<p.columns.firstVisibleIndex?1:W,rowSpan:X,style:this._extend(O,{format:z,hAlign:t,vAlign:void 0!==o?o:X>1?l===p.cells||!1===p.centerHeadersVertically?mXlsx.VAlign.Top:mXlsx.VAlign.Center:null,indent:F}),textRuns:G}}if(m){m(new XlsxFormatItemEventArgs(l,new CellRange(o,S),R,i,a,d,_))}if(b){let e=l.getCellElement(o,S);if(e){let l=x.detail;e.appendChild(l);Control.refreshAll(l)}}t.cells.push(_)}return s+S}static _parseCellStyle(e,l=!1){if(null==e)return null;let t=e.fontSize;t=t?+t.substring(0,t.indexOf("px")):null;isNaN(t)&&(t=null);let o=e.whiteSpace;o=!!o&&o.indexOf("pre")>-1;let s=e.textAlign;"start"===s&&(s="rtl"===e.direction?"right":"left");"end"===s&&(s="rtl"===e.direction?"left":"right");return{font:{bold:"bold"===e.fontWeight||+e.fontWeight>=700,italic:"italic"===e.fontStyle,underline:"underline"===(e.textDecorationStyle||e.textDecoration),family:this._parseToExcelFontFamily(e.fontFamily),size:t,color:e.color},fill:{color:e.backgroundColor},borders:this._parseBorder(e,l),hAlign:mXlsx.Workbook._parseStringToHAlign(s),wordWrap:o}}static _parseBorder(e,l){let t={left:this._parseEgdeBorder(e,"Left"),right:this._parseEgdeBorder(e,"Right"),top:this._parseEgdeBorder(e,"Top"),bottom:this._parseEgdeBorder(e,"Bottom")};if(l){t.vertical=this._parseEgdeBorder(e,"Vertical");t.horizontal=this._parseEgdeBorder(e,"Horizontal")}return t}static _parseEgdeBorder(e,l){let t,o=e["border"+l+"Style"],s=e["border"+l+"Width"];s&&(s=parseFloat(s));if(o&&"none"!==o&&"hidden"!==o&&0!==s){t={};switch(o=o.toLowerCase()){case"dotted":t.style=s>1?mXlsx.BorderStyle.MediumDashDotted:mXlsx.BorderStyle.Dotted;break;case"dashed":t.style=s>1?mXlsx.BorderStyle.MediumDashed:mXlsx.BorderStyle.Dashed;break;case"double":t.style=mXlsx.BorderStyle.Double;break;default:t.style=s>2?mXlsx.BorderStyle.Thick:s>1?mXlsx.BorderStyle.Medium:mXlsx.BorderStyle.Thin}t.color=e["border"+l+"Color"]}return t}static _parseBorderStyle(e,l,t){let o="border"+l+"Style",s="border"+l+"Width";switch(e){case mXlsx.BorderStyle.Dotted:case mXlsx.BorderStyle.Hair:t[o]="dotted";t[s]="1px";break;case mXlsx.BorderStyle.Dashed:case mXlsx.BorderStyle.ThinDashDotDotted:case mXlsx.BorderStyle.ThinDashDotted:t[o]="dashed";t[s]="1px";break;case mXlsx.BorderStyle.MediumDashed:case mXlsx.BorderStyle.MediumDashDotDotted:case mXlsx.BorderStyle.MediumDashDotted:case mXlsx.BorderStyle.SlantedMediumDashDotted:t[o]="dashed";t[s]="2px";break;case mXlsx.BorderStyle.Double:t[o]="double";t[s]="3px";break;case mXlsx.BorderStyle.Medium:t[o]="solid";t[s]="2px";break;case mXlsx.BorderStyle.Thick:t[o]="solid";t[s]="3px";break;default:t[o]="solid";t[s]="1px"}}static _parseToExcelFontFamily(e){let l;e&&(l=e.split(","))&&l.length>0&&(e=l[0].replace(/\"|\'/g,""));return e}static _parseToExcelFormula(e,l){let t=e.match(/(floor|ceiling)\([+-]?\d+\.?\d*\)/gi);if(t)for(let l=0;l<t.length;l++){let o=t[l],s=o.substring(0,o.lastIndexOf(")"))+", 1)";e=e.replace(o,s)}t=null;if(t=e.match(/text\(\"?\w+\"?\s*\,\s*\"\w+\"\)/gi)){let o=/\"?\w+\"?\s*\,\s*\"(\w+)\"/i;for(let s=0;s<t.length;s++){let r=t[s],n=r.match(o);if(n&&2===n.length){let t=n[1];if(!/^d{1,4}?$/.test(t)){let o=mXlsx.Workbook._parseCellFormat(t,l),s=r.replace(t,o);e=e.replace(r,s)}}}}return e}static _parseToTextRuns(e){let l=e.split("<span "),t=[];for(let e=0;e<l.length;e++){let o,s=l[e];if(-1!==s.indexOf("</span>")){o={text:s.substring(s.indexOf(">")+1,s.indexOf("</span>")),font:this._parseToTextRunFont(s.substring(s.indexOf('style="')+7,s.indexOf(';"')))}}else o={text:s};t.push(o)}return t}static _parseToTextRunFont(e){let l,t=e.split(";");if(t.length>0){let e,o,s,r,n,i;for(let l=0;l<t.length;l++){let a=t[l].split(":");if(2===a.length){a[1]=a[1].trim();switch(a[0]){case"font-size":r=+a[1].substring(0,a[1].indexOf("px"));isNaN(r)&&(r=null);break;case"font-weight":e="bold"===a[1]||+a[1]>=700;break;case"font-style":o="italic"===a[1];break;case"text-decoration-style":case"text-decoration":s="underline"===a[1];break;case"font-family":n=this._parseToExcelFontFamily(a[1]);break;case"color":i=a[1]}}}l={bold:e,italic:o,underline:s,family:n,size:r,color:i}}return l}static _getMeasureCell(e,l,t,o){let s=o[e.cellType],r=s&&s[l],n=null==r;if(r){if(this.hasCssText){r.style.cssText="";r.style.visibility="hidden"}}else{s||(o[e.cellType]=s=[]);s[l]=r=t.cloneNode()}!n&&r.parentElement||(e.hostElement.children.length>0?e.hostElement.children[0].appendChild(r):e.hostElement.appendChild(r));return r}static _getColumnSetting(e,l,t){let o=e;null!=e.colspan&&(o=this._getRenderColumn(l,t));return o?{autoWidth:!0,width:o.renderWidth||t.defaultSize,visible:o.visible&&0!==o.width&&!o._getFlag(RowColFlags.ParentCollapsed),style:{format:e.format?mXlsx.Workbook._parseCellFormat(e.format,e.dataType===DataType.Date):"",hAlign:mXlsx.Workbook._parseStringToHAlign(this._toExcelHAlign(o.getAlignment())),wordWrap:o.wordWrap}}:null}static _getPerRowColumnsSettings(e,l,t){let o=[],s=[];l.forEach((r,n)=>{let i=0,a=n>0?l[0].columns.length:0;for(let l=0;l<r.rows.length&&!(null!=t&&l>=t);l++)if(!(r.rows[l].renderSize<=0)){o[i]=o[i]||[];s[i]=s[i]||[];r.columns.forEach((t,n)=>{let d=e._getBindingColumn(r,l,t),u=this._getColumnSetting(d,n,r.columns);if(u){o[i][a+n]=u;s[i][a+n]=d}});i++}});return{cols:o,bndCols:s}}static _toExcelHAlign(e){return(e=e?e.trim().toLowerCase():e)?e.indexOf("center")>-1?"center":e.indexOf("right")>-1||e.indexOf("end")>-1?"right":e.indexOf("justify")>-1?"justify":"left":e}static _getColumnCount(e){let l=0;for(let t=0;t<e.length;t++){let o=e[t]&&e[t].cells?e[t].cells:[];if(o&&o.length>0){let e=o.length;isInt(o[e-1].colSpan)&&o[e-1].colSpan>1&&(e=e+o[e-1].colSpan-1);e>l&&(l=e)}}return l}static _getRowCount(e,l){var t=e.length,o=t-1;for(let s=0;s<l;s++)e:for(;o>=0;o--){let l=e[o],r=(l&&l.cells?l.cells:[])[s];if(r&&(null!=r.value&&""!==r.value||isInt(r.rowSpan)&&r.rowSpan>1)){isInt(r.rowSpan)&&r.rowSpan>1&&o+r.rowSpan>t&&(t=o+r.rowSpan);break e}}return t}static _numAlpha(e){let l=Math.floor(e/26)-1;return(l>-1?this._numAlpha(l):"")+String.fromCharCode(65+e%26)}static _getItemType(e){return null==e||null==e.value||isNaN(e.value)?null:getType(e.value)}static _setColumn(e,l,t){let o=e[l],s=this._getItemType(t);s===DataType.Boolean&&t.formula&&(s=null);if(o){o.dataType!==s&&o.dataType===DataType.Boolean&&s!==DataType.Boolean&&(o.dataType=s);if(t&&null!=t.value&&(!isString(t.value)||!isNullOrWhiteSpace(t.value))){let e=mXlsx.Workbook._parseExcelFormat(t);e&&o.format!==e&&"General"!==e&&(o.format=e)}let e,l;if(t&&t.style){t.style.hAlign&&(e=mXlsx.Workbook._parseHAlignToString(asEnum(t.style.hAlign,mXlsx.HAlign)));t.style.vAlign&&(l=mXlsx.Workbook._parseVAlignToString(asEnum(t.style.vAlign,mXlsx.VAlign)));null==o.wordWrap?o.wordWrap=!!t.style.wordWrap:o.wordWrap=o.wordWrap&&!!t.style.wordWrap}e||s!==DataType.Number||(e="right");o.hAlign=e;o.vAlign=l}else e[l]={dataType:s,format:mXlsx.Workbook._parseExcelFormat(t),hAlign:"",vAlign:"",wordWrap:null}}static _getItemValue(e){if(null==e||null==e.value)return null;let l=e.value;isString(l)&&"'"===l[0]&&(l=l.substr(1));return isNumber(l)&&isNaN(l)?"":l instanceof Date&&isNaN(l.getTime())?"":l}static _getCellStyle(e,l,t,o,s,r){let n,i=e.grid;try{let n=!(s&&!i.formatItem.hasHandlers&&!i.itemFormatter&&!r);i.cellFactory.updateCell(e,t,o,l,null,n);l.className=l.className.replace("wj-state-selected","");l.className=l.className.replace("wj-state-multi-selected","")}catch(e){return null}if(s){let t=e.hostElement,o=l,r=o.style.cssText.split(/;\s+/).filter(e=>{let l=e.substring(0,e.indexOf(":"));return/^(color|background|border|font|text|whitespace)/i.test(l)}).join(";");do{r=o.className+r}while(o!==t&&(o=o.parentElement));if(!(n=s.getValue(r))){n=window.getComputedStyle(l);s.add(r,n)}}else n=window.getComputedStyle(l);return n}static _parseTextRunsToHTML(e){let l="";for(let t=0;t<e.length;t++){let o=e[t],s=o.font;l+=s?'<span style="'+(s.bold?"font-weight: bold;":"")+(s.italic?"font-style: italic;":"")+(s.underline?"text-decoration: underline;":"")+(s.family?"font-family: "+s.family+";":"")+(null!=s.size?"font-size: "+s.size+"px;":"")+(s.color?"color: "+s.color+";":"")+'">'+o.text+"</span>":o.text}return l}static _extend(e,l){for(let t in l){let o=l[t];isObject(o)&&e[t]?copy(e[t],o):e[t]=o}return e}static _checkParentCollapsed(e,l){let t=!1;Object.keys(e).forEach(o=>{!0===e[o]&&!1===t&&!isNaN(l)&&+o<l&&(t=!0)});return t}static _getColSpan(e,l,t){let o=0;for(let s=l.leftCol;s<=l.rightCol;s++)t&&!t(e.columns[s])||o++;return o}static _getRenderColumn(e,l){return e>=l.length?null:l[e]}static _getMergedRange(e,l,t){for(let o=0;o<t.length;o++){let s=t[o];if(e>=s.topRow&&e<=s.bottomRow&&l>=s.leftCol&&l<=s.rightCol)return s}return null}static _isFormula(e){return e&&"string"==typeof e&&e.length>1&&"="===e[0]&&"="!==e[1]}}export class XlsxFormatItemEventArgs extends CellRangeEventArgs{constructor(e,l,t,o,s,r,n){super(e,l);this._cell=t;this._patternCell=o;this._xlsxCell=n;this._cellsCache=s;this._styleCache=r}get cell(){return this._cell}get xlsxCell(){return this._xlsxCell}set xlsxCell(e){this._xlsxCell=e}getFormattedCell(){if(!this._cell){this._cell=FlexGridXlsxConverter._getMeasureCell(this.panel,this.col,this._patternCell,this._cellsCache);FlexGridXlsxConverter._getCellStyle(this.panel,this._cell,this.row,this.col,this._styleCache,!0)}return this._cell}}var _ExportCellStyles;!function(e){e[e.None=0]="None";e[e.Regular=1]="Regular";e[e.Cache=2]="Cache"}(_ExportCellStyles||(_ExportCellStyles={}));export class _StyleCache{constructor(e){this._cache={};this._size=0;this._max=e}add(e,l){this._size>=this._max&&this.clear();this._cache[e]=this._cloneStyle(l);this._size++}clear(){this._cache={};this._size=0}getValue(e){return this._cache[e]||null}hasKey(e){return!!this._cache[e]}_cloneStyle(e){if(!e)return null;let l={},toCamel=e=>e.replace(/\-([a-z])/g,(e,l,t)=>t>0?l.toUpperCase():l);for(let t=0,o=e.length;t<o;t++){let o=e[t];l[toCamel(o)]=e.getPropertyValue(o)}return l}}export function _blobToBuffer(e,l){if(e&&l)if(e.arrayBuffer)e.arrayBuffer().then(e=>l(e));else{let t=new FileReader;t.onload=()=>{l(t.result);t=null};t.readAsArrayBuffer(e)}}export var HtmlEntityConversion;!function(e){e[e.Auto=0]="Auto";e[e.No=1]="No";e[e.Yes=2]="Yes"}(HtmlEntityConversion||(HtmlEntityConversion={}));_registerModule("wijmo.grid.xlsx",selfModule);