/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};return function(t,e){extendStatics(t,e);function __(){this.constructor=t}t.prototype=null===e?Object.create(e):(__.prototype=e.prototype,new __)}}();import{isIE,Point,addClass,createElement,ObservableArray,format,Rect,isFunction,copy,asArray,Size,isFirefox,clamp,isString,Binding,asString,Color,isNumber,Globalize,httpRequest,Event,EventArgs,asFunction,asNumber,_registerModule}from"wijmo/wijmo";import{SvgRenderEngine,ChartElement,ChartTooltip,FlexChartBase,Legend,RenderEventArgs,Position,_DataInfo,Palettes}from"wijmo/wijmo.chart";import*as selfModule from"wijmo/wijmo.chart.map";var MapHitTestInfo=function(){function MapHitTestInfo(){}Object.defineProperty(MapHitTestInfo.prototype,"point",{get:function(){return this._pt},enumerable:!0,configurable:!0});Object.defineProperty(MapHitTestInfo.prototype,"item",{get:function(){return this._item},enumerable:!0,configurable:!0});Object.defineProperty(MapHitTestInfo.prototype,"geoPoint",{get:function(){return this._map?this._map.convertBack(this.point):null},enumerable:!0,configurable:!0});Object.defineProperty(MapHitTestInfo.prototype,"chartElement",{get:function(){return this._chartElement},enumerable:!0,configurable:!0});Object.defineProperty(MapHitTestInfo.prototype,"map",{get:function(){return this._map},enumerable:!0,configurable:!0});return MapHitTestInfo}();export{MapHitTestInfo};var _DrawOptions=function _DrawOptions(){};export{_DrawOptions};var _SvgMapRenderEngine=function(t){__extends(_SvgMapRenderEngine,t);function _SvgMapRenderEngine(e){var i=t.call(this,e)||this;i.scale=1;i.element.setAttribute("xmlns:wj-map","http://developer.mescius.com/wijmo");return i}_SvgMapRenderEngine.prototype.drawPolygon2=function(t,e){var i=t?t.className:null,r=t?t.clipPath:null,n=t?t.style:null,o=this.precision;if(e&&e.length>0){var a=document.createElementNS("http://www.w3.org/2000/svg","path");this._applyColor(a,"stroke",this.stroke);var s=this.strokeWidth;if(null!==s){isIE()&&(s*=this.scale);this._setAttribute(a,"stroke-width",s.toString())}this._applyColor(a,"fill",this.fill);for(var h="",l=0;l<e.length;l++){var c=e[l],u=c.length/2;if(u>1){h+=" M "+c[0].toFixed(o)+" "+c[1].toFixed(o);for(var p=1;p<u;p++)h+=" L "+c[2*p].toFixed(o)+" "+c[2*p+1].toFixed(o);h+=" Z"}}this._setAttribute(a,"d",h);i&&a.setAttribute("class",i);r&&this._setClipPath(a,r);this._applyStyle(a,n);this._appendChild(a);a.setAttribute("vector-effect","non-scaling-stroke");return a}return null};return _SvgMapRenderEngine}(SvgRenderEngine);export{_SvgMapRenderEngine};var _Range=function(){function _Range(t,e){this.min=t;this.max=e}Object.defineProperty(_Range.prototype,"range",{get:function(){return this.max-this.min},enumerable:!0,configurable:!0});_Range.prototype.norm=function(t){return(t-this.min)/this.range};return _Range}();export{_Range};var _Utils=function(){function _Utils(){}_Utils.getRange=function(t,e){if(t&&e){for(var i=t.length,r=NaN,n=NaN,o=0;o<i;o++){var a=t[o];if(a){var s=void 0;s=isFunction(e)?e(a):e.getValue(a);isString(s)&&(s=parseFloat(s));if(isFinite(s)){(isNaN(r)||s<r)&&(r=s);(isNaN(n)||s>n)&&(n=s)}}}if(!isNaN(r)&&!isNaN(n))return new _Range(r,n)}return null};return _Utils}();export{_Utils};var ColorScale=function(){function ColorScale(t){this._clrs=[];this._clrUnknown="transparent";this.colors=Palettes.SequentialSingle.Greys;this.initialize(t)}ColorScale.prototype.initialize=function(t){copy(this,t)};ColorScale.prototype.convert=function(t,e){void 0===e&&(e=!0);if(!isFinite(t)||0==this._clrs.length)return this.colorUnknown;this._range&&e&&(t=this._range.norm(t));this.scale&&(t=this.scale(t));return 2==this._clrs.length?this._interpolate(this._clrs[0],this._clrs[1],t):this._clrSpline.interpolate(t).toString()};Object.defineProperty(ColorScale.prototype,"scale",{get:function(){return this._scale},set:function(t){this._scale!=t&&(this._scale=t)},enumerable:!0,configurable:!0});Object.defineProperty(ColorScale.prototype,"binding",{get:function(){return this._binding},set:function(t){this._binding!=t&&(this._binding=t)},enumerable:!0,configurable:!0});Object.defineProperty(ColorScale.prototype,"colorUnknown",{get:function(){return this._clrUnknown},set:function(t){this._clrUnknown!=t&&(this._clrUnknown=asString(t))},enumerable:!0,configurable:!0});Object.defineProperty(ColorScale.prototype,"colors",{get:function(){return this._colors},set:function(t){if(this._colors!=t){this._clrs=[];var e=this._colors=t;if(e){for(var i=0;i<e.length;i++)this._clrs.push(new Color(e[i]));this._clrSpline=new _ColorSpline(this._clrs)}}},enumerable:!0,configurable:!0});Object.defineProperty(ColorScale.prototype,"format",{get:function(){return this._fmt},set:function(t){this._fmt!=t&&(this._fmt=asString(t,!0))},enumerable:!0,configurable:!0});ColorScale.prototype.domain=function(t){isFunction(this.binding)?this._range=_Utils.getRange(t,this.binding):this._range=_Utils.getRange(t,new Binding(this.binding))};ColorScale.prototype.getValue=function(t){return isFunction(this.binding)?this.binding(t):new Binding(this.binding).getValue(t)};ColorScale.prototype._interpolate=function(t,e,i){var r=1-(i=clamp(i,0,1));return Color.fromRgba(t.r*r+e.r*i,t.g*r+e.g*i,t.b*r+e.b*i,t.a*r+e.a*i).toString()};ColorScale.prototype._drawLegend=function(t,e,i){_ColorScaleLegend.draw(t,this,e,i)};ColorScale.prototype._measureLegend=function(t,e,i,r){return _ColorScaleLegend.measure(t,this,e,i,r)};return ColorScale}();export{ColorScale};var _ColorScaleLegend=function(){function _ColorScaleLegend(){}_ColorScaleLegend.measure=function(t,e,i,r,n){var o=i?new Size(this.itemSize,n-120):new Size(r-80,this.itemSize),a=this._getValues(e),s=a.length;if(a.length){for(var h=new Size,l=0;l<s;l++){var c=this._getLabel(e,a[l]),u=t.measureString(c);h.width=Math.max(h.width,u.width);h.height=Math.max(h.height,u.height)}h.width&&h.height&&(i?o.width+=h.width+this.marginText:o.height+=h.height+this.marginText)}return o};_ColorScaleLegend.draw=function(t,e,i,r){t.stroke="transparent";var n=this._getValues(e);if(r){for(var o=(i=i.inflate(0,-10)).height/100,a=0;a<100;a++){t.fill=e.convert((a+.5)/100,!1);t.drawRect(i.left,i.top+a*o,this.itemSize,o+1)}if(n.length){t.stroke="black";for(a=0;a<n.length;a++){var s=n[a],h=e._range.norm(s),l=i.top+h*i.height,c=this._getLabel(e,s),u=t.measureString(c);t.drawString(c,new Point(i.left+this.itemSize+this.marginText,l+.5*u.height));t.drawLine(i.left,l,i.left+this.itemSize,l)}}}else{var p=(i=i.inflate(-20,0)).width/100;o=0;if(n.length)for(a=0;a<n.length;a++){s=n[a],h=e._range.norm(s);e.scale&&(h=e.scale(h));var f=i.left+h*i.width;c=this._getLabel(e,s),u=t.measureString(c);o=Math.max(o,u.height);t.drawString(this._getLabel(e,s),new Point(f-.5*u.width,i.top+u.height))}o&&(o+=this.marginText);for(a=0;a<100;a++){t.fill=e.convert((a+.5)/100,!1);t.drawRect(i.left+a*p,i.top+o,p+1,this.itemSize)}if(n.length){t.stroke="black";for(a=0;a<n.length;a++){s=n[a],h=e._range.norm(s);e.scale&&(h=e.scale(h));f=i.left+h*i.width;t.drawLine(f,i.bottom-this.itemSize,f,i.bottom)}}}};_ColorScaleLegend._getValues=function(t){var e=[],i=t._range;if(i)for(var r=this._calcDelta(i.range),n=Math.round(i.min/r)*r;n<=i.max;n+=r)n<i.min||e.push(n);return e};_ColorScaleLegend._getLabel=function(t,e){return t.format?Globalize.formatNumber(e,t.format):e.toString()};_ColorScaleLegend._calcDelta=function(t){var e=this._nicePrecision(t),i=t/10,r=this._niceNumber(2*i,-e,!0);r<i&&(r=this._niceNumber(i,1-e,!1));r<i&&(r=this._niceTickNumber(i));return r};_ColorScaleLegend._nicePrecision=function(t){if(!isNumber(t)||t<=0)return 0;var e,i=Math.log(t)/Math.LN10;e=i>=0?Math.floor(i):Math.ceil(i);var r=t/Math.pow(10,e);if(r<3){e=1-e;(r=t/Math.pow(10,e))<3&&(e+=1)}return e};_ColorScaleLegend._niceTickNumber=function(t){if(0==t)return t;t<0&&(t=-t);var e=Math.log(t)/Math.LN10,i=Math.floor(e),r=t/Math.pow(10,i),n=10;r<=1?n=1:r<=2?n=2:r<=5&&(n=5);return n*Math.pow(10,i)};_ColorScaleLegend._niceNumber=function(t,e,i){if(0==t)return t;t<0&&(t=-t);var r=t/Math.pow(10,e),n=10;i?r<1.5?n=1:r<3?n=2:r<4.5?n=4:r<7&&(n=5):r<=1?n=1:r<=2?n=2:r<=5&&(n=5);return n*Math.pow(10,e)};_ColorScaleLegend.itemSize=20;_ColorScaleLegend.marginText=4;return _ColorScaleLegend}(),_ColorSpline=function(){function _ColorSpline(t){this._clrs=t;for(var e=t.length,i=[],r=[],n=[],o=[],a=0;a<e;a++){var s=t[a],h=a/(e-1);i.push(h);r.push(s.r);n.push(s.g);o.push(s.b)}this._rsp=new _Spline(i,r);this._gsp=new _Spline(i,n);this._bsp=new _Spline(i,o)}_ColorSpline.prototype.interpolate=function(t){t=clamp(t,0,1);var e=this._rsp.calculate(t),i=this._gsp.calculate(t),r=this._bsp.calculate(t);return Color.fromRgba(e,i,r)};return _ColorSpline}(),_Spline=function(){function _Spline(t,e,i){this.k=.002;this._a=[];this._b=[];this._c=[];this._d=[];this.m=[[-.5,1.5,-1.5,.5],[1,-2.5,2,-.5],[-.5,0,.5,0],[0,1,0,0]];this._x=t;this._y=e;var r=this._len=i||Math.min(t.length,e.length);if(r>3)for(var n=0;n<r-1;n++){var o=0==n?new Point(t[n],e[n]):new Point(t[n-1],e[n-1]),a=new Point(t[n],e[n]),s=new Point(t[n+1],e[n+1]),h=n==r-2?new Point(t[n+1],e[n+1]):new Point(t[n+2],e[n+2]),l=new Point,c=new Point,u=new Point,p=new Point;l.x=o.x*this.m[0][0]+a.x*this.m[0][1]+s.x*this.m[0][2]+h.x*this.m[0][3];c.x=o.x*this.m[1][0]+a.x*this.m[1][1]+s.x*this.m[1][2]+h.x*this.m[1][3];u.x=o.x*this.m[2][0]+a.x*this.m[2][1]+s.x*this.m[2][2]+h.x*this.m[2][3];p.x=o.x*this.m[3][0]+a.x*this.m[3][1]+s.x*this.m[3][2]+h.x*this.m[3][3];l.y=o.y*this.m[0][0]+a.y*this.m[0][1]+s.y*this.m[0][2]+h.y*this.m[0][3];c.y=o.y*this.m[1][0]+a.y*this.m[1][1]+s.y*this.m[1][2]+h.y*this.m[1][3];u.y=o.y*this.m[2][0]+a.y*this.m[2][1]+s.y*this.m[2][2]+h.y*this.m[2][3];p.y=o.y*this.m[3][0]+a.y*this.m[3][1]+s.y*this.m[3][2]+h.y*this.m[3][3];this._a.push(l);this._b.push(c);this._c.push(u);this._d.push(p)}}_Spline.prototype.calculate=function(t){t*=this._len-1;var e=Math.floor(t);e<0&&(e=0);e>this._len-2&&(e=this._len-2);var i=t-e;this._a[e].x,this._b[e].x,this._c[e].x,this._d[e].x;return((this._a[e].y*i+this._b[e].y)*i+this._c[e].y)*i+this._d[e].y};return _Spline}(),FlexMap=function(t){__extends(FlexMap,t);function FlexMap(e,i){var r=t.call(this,e,null,!0)||this;r._layers=new ObservableArray;r._center=new Point;r._zoom=1;r._zoomStep=.5;r._offset=new Point;r._proj=new MercatorProjection;r._touchStartH=r._touchStart.bind(r);r._touchMoveH=r._touchMove.bind(r);r._touchEndH=r._touchEnd.bind(r);r._touchCancelH=r._touchCancel.bind(r);r._mouseWheelH=r._mouseWheel.bind(r);r._handleTouch=!1;var n=r.hostElement;r.applyTemplate("wj-control wj-flexchart wj-flexmap",null,null);r._currentRenderEngine=new _SvgMapRenderEngine(n);var o=createElement("<div></div>",null,{position:"relative"});r._overlay=createElement("<div></div>",o,{position:"absolute",left:"90%",bottom:"90%"});createElement('<button class="wj-btn"><span class="wj-glyph-plus"></span></button>',r._overlay).addEventListener("click",(function(){return r.zoom+=r._zoomStep}));createElement('<button class="wj-btn"><span class="wj-glyph-minus"></span></button>',r._overlay).addEventListener("click",(function(){return r.zoom-=r._zoomStep}));addClass(n,"wj-flexchart-touch-disabled");n.appendChild(o);r._legend=new Legend(r);r._legend.position=Position.None;r._tooltip=new ChartTooltip;r.tooltip.content=null;var a=r;r.layers.collectionChanged.addHandler((function(){r.layers.forEach((function(t){return t.map=a}));r.invalidate()}));r.addEventListener(n,"click",(function(t){if(!a.isDisabled){var e=a._tooltip;e.content&&a.isTouching&&a._updateTooltip(e,t)}}));r.addEventListener(n,"mousedown",(function(t){if(!a.isDisabled&&0==t.button){r.focus();r._dragStart=new Point(t.pageX,t.pageY);r._hideToolTip()}}));r.addEventListener(n,"mousemove",(function(t){if(!a.isDisabled)if(a._dragStart){var e=r.convertBack(r._toControl(a._dragStart)),i=r.convertBack(r._toControl(t));r.center=new Point(r.center.x-i.x+e.x,r.center.y-i.y+e.y);r._dragStart=new Point(t.pageX,t.pageY)}else{var n=a._tooltip;n.content&&!a.isTouching&&a._updateTooltip(n,t)}}));r.addEventListener(n,"mouseup",(function(t){r._dragStart=null}));r.addEventListener(n,"mouseleave",(function(t){if(t.target==a.hostElement){r._dragStart=null;a._hideToolTip()}}));r.addEventListener(n,"touchstart",r._touchStartH);r.addEventListener(n,"touchmove",r._touchMoveH);r.addEventListener(n,"touchcancel",r._touchCancelH);r.addEventListener(n,"touchend",r._touchEndH);r.addEventListener(n,"wheel",r._mouseWheelH);r.initialize(i);r.refresh();return r}Object.defineProperty(FlexMap.prototype,"layers",{get:function(){return this._layers},enumerable:!0,configurable:!0});Object.defineProperty(FlexMap.prototype,"center",{get:function(){return this._center},set:function(t){if(this._center!=t){this._center=t;this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(FlexMap.prototype,"zoom",{get:function(){return this._zoom},set:function(t){t<1&&(t=1);if(this._zoom!=t){this._zoom=t;this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(FlexMap.prototype,"tooltip",{get:function(){return this._tooltip},enumerable:!0,configurable:!0});FlexMap.prototype.convert=function(t){return this._convertMercator(t)};FlexMap.prototype.convertBack=function(t){return this._convertMercatorBack(t)};FlexMap.prototype.hitTest=function(t,e){var i=this._toControl(t,e),r=new MapHitTestInfo;if(FlexChartBase._contains(this._rectHeader,i))r._chartElement=ChartElement.Header;else if(FlexChartBase._contains(this._rectFooter,i))r._chartElement=ChartElement.Footer;else if(FlexChartBase._contains(this._rectLegend,i))r._chartElement=ChartElement.Legend;else if(FlexChartBase._contains(this._rectChart,i)){var n=void 0;if(t instanceof MouseEvent)n=new Point(t.x,t.y);else{var o=this._getHostOffset();n=new Point(o.x+i.x,o.y+i.y)}r._item=this._getItem(n)}return r};FlexMap.prototype.zoomTo=function(t){var e=this._proj.maxY,i=Math.max(t.top,-e),r=Math.min(t.bottom,e),n=this.convert(new Point(t.left,i)),o=this.convert(new Point(t.right,r));if(_DataInfo.isValid(n.x,n.y,o.x,o.y)){var a=new Point(.5*(n.x+o.x),.5*(n.y+o.y));this.center=this.convertBack(a);n=this.convert(new Point(t.left,i));o=this.convert(new Point(t.right,r));var s=this._mapRect.width/Math.abs(o.x-n.x),h=this._mapRect.height/Math.abs(o.y-n.y);this.zoom*=this.zoom+Math.log(Math.min(s,h))*Math.LOG2E}};FlexMap.prototype.invalidate=function(e){e&&this.layers.forEach((function(t){t._clearCache&&t._clearCache()}));t.prototype.invalidate.call(this,e)};FlexMap.prototype._renderChart=function(t,e,i){this.onRendering(new RenderEventArgs(t));e=this._getMapRect(e);var r="mapRect"+(1e6*Math.random()).toFixed();t.addClipRect(e,r);var n=t.startGroup(null,r,!0);this._updateOffset(e);var o=this._size,a=Math.pow(2,this.zoom);t.precision=6;for(var s=0;s<this.layers.length;s++){var h=1/(a*o);t.scale=h;var l=t.element.createSVGTransform(),c=t.element.createSVGMatrix();c.a=c.d=a*o;c.b=c.c=0;c.e=this._offset.x;c.f=this._offset.y;l.setMatrix(c);this.layers[s].render(t,l,n)}t.endGroup();var u=this._rectChart.bottom-this._mapRect.bottom;this._overlay.style.left=(this._mapRect.right-80).toString()+"px";this._overlay.style.bottom=u.toString()+"px";this.onRendered(new RenderEventArgs(t))};FlexMap.prototype._getDesiredLegendSize=function(t,e,i,r){for(var n=new Size,o=0;o<this.layers.length;o++){var a=this.layers[o];if(a.colorScale){a.getAllFeatures?a.colorScale.domain(a.getAllFeatures()):a.colorScale.domain(a.itemsSource);var s=a.colorScale._measureLegend(t,e,i,r);s&&s.width&&s.height&&(n=s)}}return n};FlexMap.prototype._renderLegend=function(t,e,i,r,n,o){var a=new Rect(e.x,e.y,n,o);this.layers.forEach((function(e){e.colorScale&&e.colorScale._drawLegend(t,a,r)}))};FlexMap.prototype._copy=function(t,e){if("layers"==t){this.layers.clear();for(var i=asArray(e),r=0;r<i.length;r++)this.layers.push(i[r]);return!0}return!1};FlexMap.prototype._getMapRect=function(t){var e=t.width,i=t.height,r=this._parseMargin(this.plotMargin);isNaN(r.left)&&(r.left=8);isNaN(r.right)&&(r.right=8);isNaN(r.top)&&(r.top=8);isNaN(r.bottom)&&(r.bottom=8);t.top+=r.top;i=t.height-(r.top+r.bottom);t.height=i>0?i:24;t.left+=r.left;e=t.width-(r.left+r.right);t.width=e>0?e:24;return t};FlexMap.prototype._updateOffset=function(t){this._mapRect=t.clone();var e=this._size=.5*Math.min(t.width,t.height);this._offset.x=this._mapRect.left;this._offset.y=this._mapRect.top;t.width>2*e?this._offset.x=.5*t.width-e+this._mapRect.left:t.height>2*this._size&&(this._offset.y=.5*t.height-e+this._mapRect.top);var i=Math.pow(2,this.zoom),r=this._proj.convert(this.center);r.x=r.x*i*e-e;r.y=r.y*i*e-e;this._offset.x-=r.x;this._offset.y-=r.y};FlexMap.prototype._updateTooltip=function(t,e){var i=t.content;if(i){var r=this._getItem(new Point(e.clientX,e.clientY));if(r){isFunction(i)&&(i=i(r));i=format(i,r)}else i=null}i&&i.trim().length>0?this._showToolTip(i,new Rect(e.clientX,e.clientY,5,5)):this._hideToolTip()};FlexMap.prototype._getItemById=function(t){for(var e=0;e<this.layers.length;e++){var i=this.layers[e];if(i._getFeatureById){if(r=i._getFeatureById(t))return r.properties}else if(i.getItemById){var r;if(r=i.getItemById(t))return r}}return null};FlexMap.prototype._convertMercator=function(t){var e=Math.pow(2,this.zoom)*this._size,i=this._proj.convert(t);i.x*=e;i.y*=e;i.x+=this._offset.x;i.y+=this._offset.y;return i};FlexMap.prototype._convertMercatorBack=function(t){var e=Math.pow(2,this.zoom)*this._size,i=this._proj,r=t.clone();r.x-=this._offset.x;r.y-=this._offset.y;r.x/=e;r.y/=e;return r=i.convertBack(r)};FlexMap.prototype._touchStart=function(t){if(!this.isDisabled){switch(t.touches.length){case 1:this._handleTouch=!0;this._dragStart=new Point(t.touches[0].pageX,t.touches[0].pageY);break;case 2:this._dragStart=null;this._handleTouch=!0;this._touch1=new Point(t.touches[0].pageX,t.touches[0].pageY);this._touch2=new Point(t.touches[1].pageX,t.touches[1].pageY)}this._handleTouch&&this._hideToolTip()}};FlexMap.prototype._touchMove=function(t){if(!this.isDisabled){this._handleTouch&&t.preventDefault();if(this._dragStart){var e=this.convertBack(this._toControl(this._dragStart)),i=this.convertBack(this._toControl(t.touches[0].pageX,t.touches[0].pageY));this.center=new Point(this.center.x-i.x+e.x,this.center.y-i.y+e.y);this._dragStart=new Point(t.touches[0].pageX,t.touches[0].pageY)}else if(this._touch1&&this._touch2){var r=new Point(t.touches[0].pageX,t.touches[0].pageY),n=new Point(t.touches[1].pageX,t.touches[1].pageY),o=this._dist(this._touch1,this._touch2),a=this._dist(r,n);if(Math.abs(a-o)>1){this.zoom+=Math.log2(a/o);this._touch1=r;this._touch2=n}}}};FlexMap.prototype._dist=function(t,e){var i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)};FlexMap.prototype._touchEnd=function(t){this._handleTouch=!1;this._dragStart=this._touch1=this._touch2=null};FlexMap.prototype._touchCancel=function(t){this._handleTouch=!1;this._dragStart=this._touch1=this._touch2=null};FlexMap.prototype._mouseWheel=function(t){if(!this.isDisabled){t.preventDefault();this._hideToolTip();var e=this.pageToControl(t.pageX,t.pageY),i=this.convertBack(e),r=-t.deltaY;r=r>0?.1:-.1;this._zoom+=r;this._zoom<1&&(this._zoom=1);this._updateOffset(this._mapRect);var n=this.convertBack(e);this.center=new Point(this.center.x-n.x+i.x,this.center.y-n.y+i.y);this.refresh()}};FlexMap.prototype._getItem=function(t){var e=null;if(isFirefox()||isIE()){var i=t.clone();i.x+=pageXOffset;i.y+=pageYOffset;i=this._toControl(i);var r=this.layers.length;i=this.convertBack(i);for(var n=r-1;n>=0;n--){var o=this.layers[n];if(o._hitTest)e=o._hitTest(i.x,i.y);else if(o.getItemById){if(a=document.elementFromPoint(t.x,t.y)){null!=(s=a.getAttribute("wj-map:id"))&&(e=o.getItemById(s))}}if(e)break}}else{var a;if(a=document.elementFromPoint(t.x,t.y)){var s;null!=(s=a.getAttribute("wj-map:id"))&&(e=this._getItemById(s))}}return e};return FlexMap}(FlexChartBase);export{FlexMap};var MercatorProjection=function(){function MercatorProjection(){this.maxY=(2*Math.atan(Math.exp(Math.PI))-.5*Math.PI)/M.toRadians}MercatorProjection.prototype.convert=function(t){var e=this._convertX(t.x),i=Math.abs(t.y)>this.maxY?(t.y>0?1:-1)*this.maxY:t.y;i=this._convertY(i);return new Point(e,i)};MercatorProjection.prototype.convertBack=function(t){var e=this._convertBackX(t.x),i=this._convertBackY(t.y);return new Point(e,i)};MercatorProjection.prototype._convertX=function(t){return(t*M.toRadians+Math.PI)/M.pi2};MercatorProjection.prototype._convertBackX=function(t){return(t*M.pi2-Math.PI)/M.toRadians};MercatorProjection.prototype._convertY=function(t){return(Math.PI+Math.log(Math.tan(M.pi4-.5*t*M.toRadians)))/M.pi2};MercatorProjection.prototype._convertBackY=function(t){return-(2*Math.atan(Math.exp(t*M.pi2-Math.PI))-.5*Math.PI)/M.toRadians};return MercatorProjection}(),M=function(){function M(){}M.toRadians=Math.PI/180;M.pi4=.25*Math.PI;M.pi2=2*Math.PI;return M}();export var empty={};var MapLayerBase=function(){function MapLayerBase(){this.itemsSourceChanged=new Event}Object.defineProperty(MapLayerBase.prototype,"map",{get:function(){return this._map},set:function(t){this._map=t},enumerable:!0,configurable:!0});Object.defineProperty(MapLayerBase.prototype,"style",{get:function(){return this._style},set:function(t){if(this._style!=t){this._style=t;this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(MapLayerBase.prototype,"itemsSource",{get:function(){return this._items},set:function(t){this._setItems(t)},enumerable:!0,configurable:!0});MapLayerBase.prototype.onItemsSourceChanged=function(t){this.itemsSourceChanged.raise(this,t)};Object.defineProperty(MapLayerBase.prototype,"url",{get:function(){return this._url},set:function(t){if(this._url!=t){this._url=asString(t,!0);this._loadUrl()}},enumerable:!0,configurable:!0});Object.defineProperty(MapLayerBase.prototype,"colorScale",{get:function(){return this._colorScale},set:function(t){if(this._colorScale!=t){this._colorScale=t;this._clearCache();this.invalidate()}},enumerable:!0,configurable:!0});MapLayerBase.prototype.render=function(t,e,i){};MapLayerBase.prototype.invalidate=function(){this.map&&this.map.invalidate()};MapLayerBase.prototype.initialize=function(t){copy(this,t)};MapLayerBase.prototype._applyStyle=function(t){if(this.style){t.fill=this.style.fill;t.stroke=this.style.stroke;t.strokeWidth=this.style.strokeWidth}};MapLayerBase.prototype._clearCache=function(){};MapLayerBase.prototype._loadUrl=function(){var t=this;this.url?httpRequest(this.url,{success:function(e){return t.itemsSource=JSON.parse(e.responseText)}}):this.itemsSource=null};MapLayerBase.prototype._setItems=function(t){if(this._items!=t){this._clearCache();this._items=t;this.onItemsSourceChanged(new EventArgs);this.invalidate()}};return MapLayerBase}();export{MapLayerBase};var ScatterMapLayer=function(t){__extends(ScatterMapLayer,t);function ScatterMapLayer(e){var i=t.call(this)||this;i._symbolSize=5;i._symbolMinSize=5;i._symbolMaxSize=50;i._index=0;i._prefix="_";i._elMap={};i._hasBindings=!1;i.style={stroke:"grey",strokeWidth:.5,fill:"transparent"};i.initialize(e);return i}Object.defineProperty(ScatterMapLayer.prototype,"symbolSize",{get:function(){return this._symbolSize},set:function(t){if(this._symbolSize!=t){this._symbolSize=asNumber(t);this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(ScatterMapLayer.prototype,"symbolMinSize",{get:function(){return this._symbolMinSize},set:function(t){if(this._symbolMinSize!=t){this._symbolMinSize=asNumber(t);this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(ScatterMapLayer.prototype,"symbolMaxSize",{get:function(){return this._symbolMaxSize},set:function(t){if(this._symbolMaxSize!=t){this._symbolMaxSize=asNumber(t);this.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(ScatterMapLayer.prototype,"itemsSource",{get:function(){return this._items},set:function(t){this._setItems(t)},enumerable:!0,configurable:!0});Object.defineProperty(ScatterMapLayer.prototype,"binding",{get:function(){return this._binding},set:function(t){if(this._binding!=t){this._binding=asString(t,!0);this.parseBindings();this.invalidate()}},enumerable:!0,configurable:!0});ScatterMapLayer.prototype.render=function(t,e,i){this._elMap={};this._index=0;this._prefix=this.map.layers.indexOf(this).toString()+"_";var r=t.startGroup();this.map,this.map._mapRect;this._applyStyle(t);var n=this.itemsSource,o=n?n.length:0,a=this._xBnd,s=this._yBnd,h=this._cBnd,l=this._szBnd;l&&(this._szRange=_Utils.getRange(n,l));var c=this.colorScale;c&&c.domain(n);if(a&&s||h)for(var u=0;u<o;u++){var p=n[u];if(p){var f=this.getItemPos(p);if(f){c&&(t.fill=c.convert(c.getValue(p)));this.renderItem(t,p,f.x,f.y)}}this._index++}t.endGroup();return r};ScatterMapLayer.prototype.renderItem=function(t,e,i,r){if(isNumber(i)&&isNumber(r)){var n=this.map.convert(new Point(i,r));if(isFinite(n.x)&&isFinite(n.y)){var o=this.symbolSize;if(this._szRange){var a=this._szBnd.getValue(e);a=Math.sqrt((a-this._szRange.min)/this._szRange.range);o=this.symbolMinSize+(this.symbolMaxSize-this.symbolMinSize)*a}if(isFinite(o)){var s=t.drawEllipse(n.x,n.y,.5*o,.5*o);s.setAttribute("vector-effect","non-scaling-stroke");var h=this.createId();this.setId(s,h);this._elMap[h]=s}}}};ScatterMapLayer.prototype.getItemById=function(t){var e=this.itemsSource;if(e){if(this._elMap[t]){var i=parseInt(t.split("_")[1]);if(isNumber(i)&&i<e.length)return e[i]}}return null};ScatterMapLayer.prototype.getGeoBBox=function(){var t=this.itemsSource,e=t?t.length:0;if(this._hasBindings){for(var i=NaN,r=NaN,n=NaN,o=NaN,a=0;a<e;a++){var s=t[a];if(s){var h=this.getItemPos(s);if(h){if(isFinite(h.x)){(isNaN(i)||h.x<i)&&(i=h.x);(isNaN(r)||h.x>r)&&(r=h.x)}if(isFinite(h.y)){(isNaN(n)||h.y<n)&&(n=h.y);(isNaN(o)||h.y>o)&&(o=h.y)}}}}if(!isNaN(i)&&!isNaN(n))return new Rect(i,n,r-i,o-n)}return null};ScatterMapLayer.prototype.getItemPos=function(t){var e=this._xBnd,i=this._yBnd,r=this._cBnd;if(r){var n=r.getValue(t);if(n){var o=n.split(",");if(o&&o.length>=2){var a=parseFloat(o[0]),s=parseFloat(o[1]);if(isFinite(a)&&isFinite(s))return new Point(a,s)}}}else{a=e.getValue(t),s=i.getValue(t);isString(a)&&(a=parseFloat(a));isString(s)&&(s=parseFloat(s));if(isFinite(a)&&isFinite(s))return new Point(a,s)}return null};ScatterMapLayer.prototype.setId=function(t,e){t&&e&&t.setAttribute("wj-map:id",e)};ScatterMapLayer.prototype.createId=function(){return this._prefix+this._index.toString()};ScatterMapLayer.prototype.parseBindings=function(){var t=this.binding;this._xBnd=this._yBnd=this._szBnd=null;this._hasBindings=!1;if(t){var e=t.split(",");if(1==e.length){this._cBnd=new Binding(e[0].trim());this._hasBindings=!0}else if(e.length>=2){this._xBnd=new Binding(e[0].trim());this._yBnd=new Binding(e[1].trim());this._hasBindings=!0;e.length>=3&&(this._szBnd=new Binding(e[2].trim()))}}};return ScatterMapLayer}(MapLayerBase);export{ScatterMapLayer};var _GeoJsonRender=function(){function _GeoJsonRender(){this._map={};this._index=0;this.prefix="_";this.hasPoints=!1;this.symbolSize=5}_GeoJsonRender.prototype.convert=function(t){this.converter&&(t=this.converter.convert(t));return t};_GeoJsonRender.prototype.render=function(t,e,i){void 0===i&&(i=null);this._map={};this._index=0;this.hasPoints=!1;if(e)switch(e.type){case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":case"GeometryCollection":this.renderGeometry(t,e);break;case"Feature":this.renderFeature(t,e,i);break;case"FeatureCollection":if(e.features)for(var r=0;r<e.features.length;r++)this.renderFeature(t,e.features[r],i)}};_GeoJsonRender.prototype.renderFeature=function(t,e,i){void 0===i&&(i=null);if(e&&e.geometry){i&&i(t,e);var r=this.createId();this.renderGeometry(t,e.geometry,r);this._map[r]=e;this._index++}};_GeoJsonRender.prototype.renderGeometry=function(t,e,i){void 0===i&&(i=null);if(e)switch(e.type){case"Point":this.renderPoint(t,e,i);this.hasPoints=!0;break;case"MultiPoint":this.renderMultiPoint(t,e,i);this.hasPoints=!0;break;case"LineString":this.renderLineString(t,e,i);break;case"MultiLineString":this.renderMultiLineString(t,e,i);break;case"Polygon":this.renderPolygon(t,e,i);break;case"MultiPolygon":this.renderMultiPolygon(t,e,i);break;case"GeometryCollection":if(e.geometries)for(var r=0;r<e.geometries.length;r++)this.renderGeometry(t,e.geometries[r],i)}};_GeoJsonRender.prototype.renderPoint=function(t,e,i){void 0===i&&(i=null);if(e&&e.coordinates&&e.coordinates.length>=2){var r=new Point(e.coordinates[0],e.coordinates[1]);r=this.convert(r);var n=t.scale*this.symbolSize,o=t.drawEllipse(r.x,r.y,n,n);o.setAttribute("vector-effect","non-scaling-stroke");this.setAttribute(o,i)}};_GeoJsonRender.prototype.renderMultiPoint=function(t,e,i){void 0===i&&(i=null);if(e&&e.coordinates)for(var r=e.coordinates,n=e.coordinates.length,o=0;o<n;o++){var a=new Point(r[o][0],r[o][1]);a=this.convert(a);var s=t.scale*this.symbolSize,h=t.drawEllipse(a.x,a.y,s,s);this.setAttribute(h,i)}};_GeoJsonRender.prototype.renderLineString=function(t,e,i){void 0===i&&(i=null);if(e&&e.coordinates){for(var r=e.coordinates,n=e.coordinates.length,o=[],a=[],s=0;s<n;s++){var h=new Point(r[s][0],r[s][1]);h=this.convert(h);o.push(h.x);a.push(h.y)}var l=t.drawLines(o,a);this.setAttribute(l,i)}};_GeoJsonRender.prototype.renderMultiLineString=function(t,e,i){void 0===i&&(i=null);if(e&&e.coordinates)for(var r=e.coordinates,n=r.length,o=0;o<n;o++){for(var a=r[o],s=[],h=[],l=0;l<a.length;l++){var c=new Point(a[l][0],a[l][1]);c=this.convert(c);s.push(c.x);h.push(c.y)}var u=t.drawLines(s,h);this.setAttribute(u,i)}};_GeoJsonRender.prototype.renderMultiPolygon=function(t,e,i){void 0===i&&(i=null);if(e&&e.coordinates)for(var r=e.coordinates,n=r.length,o=t,a=0;a<n;a++){for(var s=r[a],h=(s.length,[]),l=0;l<1;l++){for(var c=s[l],u=[],p=0;p<c.length;p++){var f=new Point(c[p][0],c[p][1]);f=this.convert(f);u.push(f.x);u.push(f.y)}h.push(u)}var _=o.drawPolygon2(null,h);this.setAttribute(_,i)}};_GeoJsonRender.prototype.renderPolygon=function(t,e,i){void 0===i&&(i=null);if(e&&e.coordinates){for(var r=e.coordinates,n=r.length,o=t,a=[],s=0;s<n;s++){for(var h=r[s],l=[],c=0;c<h.length;c++){var u=new Point(h[c][0],h[c][1]);u=this.convert(u);l.push(u.x);l.push(u.y)}a.push(l)}var p=o.drawPolygon2(null,a);this.setAttribute(p,i)}};_GeoJsonRender.prototype.getFeatureById=function(t){return this._map[t]};_GeoJsonRender.prototype.getAllFeatures=function(t){var e=[];if(t)switch(t.type){case"Feature":e.push(t);break;case"FeatureCollection":if(t.features)for(var i=0;i<t.features.length;i++)e.push(t.features[i])}return e};_GeoJsonRender.prototype.getBBox=function(t){var e=null;if(t)switch(t.type){case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":case"GeometryCollection":e=this.getGeometryBBox(t);break;case"Feature":e=this.getGeometryBBox(t.geometry);break;case"FeatureCollection":if(t.features)for(var i=0;i<t.features.length;i++){var r=this.getGeometryBBox(t.features[i].geometry,e);r&&(e=r)}}return e};_GeoJsonRender.prototype.getGeometryBBox=function(t,e){var i=null;if(t)switch(t.type){case"Point":case"MultiPoint":case"LineString":case"MultiLineString":case"Polygon":case"MultiPolygon":var r=t.coordinates,n=this.flat(r,10);i=this.getRect(n,e);break;case"GeometryCollection":if(t.geometries)for(var o=0;o<t.geometries.length;o++)(i=this.getGeometryBBox(t.geometries[o],e))&&(e=i.clone())}return i};_GeoJsonRender.prototype.getRect=function(t,e){var i=null;if(t){var r=NaN,n=NaN,o=NaN,a=NaN;if(e){r=e.left;n=e.right;o=e.top;a=e.bottom}for(var s=t.length/2,h=0;h<s;h++){var l=t[2*h],c=t[2*h+1];(isNaN(r)||l<r)&&(r=l);(isNaN(n)||l>n)&&(n=l);(isNaN(o)||c<o)&&(o=c);(isNaN(a)||c>a)&&(a=c)}isNaN(r)||isNaN(o)||(i=new Rect(r,o,n-r,a-o))}return i};_GeoJsonRender.prototype.hitTest=function(t,e,i){for(var r=this.getAllFeatures(t),n=0;n<r.length;n++)if(_GeoJsonHitTest.hitTest(r[n],e,i))return r[n];return null};_GeoJsonRender.prototype.setAttribute=function(t,e){t&&e&&t.setAttribute("wj-map:id",e)};_GeoJsonRender.prototype.createId=function(){return this.prefix+this._index.toString()};_GeoJsonRender.prototype.flat=function(t,e){if(t.flat)return t.flat(e);for(var i=t.slice(),r=[];i.length;){var n=i.pop();Array.isArray(n)?i.push.apply(i,n):r.push(n)}return r.reverse()};return _GeoJsonRender}();export{_GeoJsonRender};var _GeoJsonHitTest=function(){function _GeoJsonHitTest(){}_GeoJsonHitTest.hitTest=function(t,e,i){var r=!1;if(t)switch(t.type){case"Point":case"MultiPoint":case"LineString":case"MultiLineString":r=!1;break;case"Polygon":r=this.hitTestPolygon(t,e,i);break;case"MultiPolygon":r=this.hitTestMultiPolygon(t,e,i);break;case"GeometryCollection":r=!1;break;case"Feature":r=this.hitTestGeometry(t.geometry,e,i);break;case"FeatureCollection":if(t.features)for(var n=0;n<t.features.length;n++);}return r};_GeoJsonHitTest.hitTestPolygon=function(t,e,i){var r=!1;if(t&&t.coordinates){for(var n=t.coordinates,o=n.length,a=0;a<1;a++){var s=n[a];r=this.contains(s,e,i)}if(r)for(a=1;a<o;a++){s=n[a];if(this.contains(s,e,i)){r=!1;break}}}return r};_GeoJsonHitTest.hitTestMultiPolygon=function(t,e,i){var r=!1;if(t&&t.coordinates)for(var n=t.coordinates,o=n.length-1;o>=0;o--){for(var a=n[o],s=a.length,h=0;h<1;h++){var l=a[h];r=this.contains(l,e,i)}if(r)for(var c=1;c<s;c++){l=a[c];if(this.contains(l,e,i)){r=!1;break}}if(r)break}return r};_GeoJsonHitTest.hitTestGeometry=function(t,e,i){var r=!1;if(t)switch(t.type){case"Point":case"MultiPoint":case"LineString":case"MultiLineString":break;case"Polygon":r=this.hitTestPolygon(t,e,i);break;case"MultiPolygon":r=this.hitTestMultiPolygon(t,e,i);break;case"GeometryCollection":if(t.geometries)for(var n=0;n<t.geometries.length&&!(r=this.hitTestGeometry(t.geometries[n],e,i));n++);}return r};_GeoJsonHitTest.contains=function(t,e,i){for(var r=0,n=t.length,o=0;o<n-1;o++){var a=t[o][0],s=t[o][1],h=t[o+1][0],l=t[o+1][1];this.west(a,s,h,l,e,i)&&++r}return r%2==1};_GeoJsonHitTest.west=function(t,e,i,r,n,o){return e<=r?!(o<=e||o>r||n>=t&&n>=i)&&(n<t&&n<i||(o-e)/(n-t)>(r-e)/(i-t)):this.west(i,r,t,e,n,o)};return _GeoJsonHitTest}();export{_GeoJsonHitTest};var GeoMapLayer=function(t){__extends(GeoMapLayer,t);function GeoMapLayer(e){var i=t.call(this)||this;i._render=new _GeoJsonRender;i._symbolSize=5;i.style={stroke:"gray",fill:"transparent",strokeWidth:.5};e&&i.initialize(e);return i}Object.defineProperty(GeoMapLayer.prototype,"itemFormatter",{get:function(){return this._ifmt},set:function(t){if(this._ifmt!=t){this._ifmt=asFunction(t,!0);this._clearCache();this.invalidate()}},enumerable:!0,configurable:!0});GeoMapLayer.prototype.getAllFeatures=function(){return this._render.getAllFeatures(this.itemsSource)};GeoMapLayer.prototype.render=function(t,e,i){this._render.hasPoints&&this._clearCache();var r=this._g;if(r)i.appendChild(r);else{r=t.startGroup();this._render.symbolSize=this.symbolSize;this._render.converter=this.map._proj;var n=this.colorScale;n&&n.domain(this.getAllFeatures());this._applyStyle(t);this._render.prefix=this.map.layers.indexOf(this).toString()+"_";n?this._render.render(t,this.itemsSource,(function(t,e){t.fill=n.convert(n.getValue(e))})):this._render.render(t,this.itemsSource,this.itemFormatter);t.endGroup();this._g=r}0==r.transform.baseVal.numberOfItems?r.transform.baseVal.appendItem(e):r.transform.baseVal.replaceItem(e,0);return r};GeoMapLayer.prototype.getGeoBBox=function(t){return t?this._render.getBBox(t):this._render.getBBox(this.itemsSource)};Object.defineProperty(GeoMapLayer.prototype,"symbolSize",{get:function(){return this._symbolSize},set:function(t){if(this._symbolSize!=t){this._symbolSize=asNumber(t);this.invalidate()}},enumerable:!0,configurable:!0});GeoMapLayer.prototype._clearCache=function(){this._g=null};GeoMapLayer.prototype._getFeatureById=function(t){return this._render.getFeatureById(t)};GeoMapLayer.prototype._hitTest=function(t,e){var i=this._render.hitTest(this.itemsSource,t,e);return i?i.properties:null};return GeoMapLayer}(MapLayerBase);export{GeoMapLayer};var GeoGridLayer=function(t){__extends(GeoGridLayer,t);function GeoGridLayer(){var e=t.call(this)||this;e.style={stroke:"lightgrey",strokeWidth:.5,fill:"lightgrey"};return e}GeoGridLayer.prototype.render=function(t,e,i){var r=t.startGroup("wj-flexmap-geogrid"),n=this.map,o=this.map._mapRect,a="wj-label";this._applyStyle(t);for(var s=-180;s<=180;s+=30){var h=n.convert(new Point(s,-85)),l=n.convert(new Point(s,85));if(this.isValid(h)&&this.isValid(l)){var c=s.toString(),u=t.measureString(c,a);t.drawString(c,new Point(h.x-.5*u.width,o.top+u.height),a);t.drawLine(h.x,h.y,l.x,l.y)}}for(var p=o.left,f=-80;f<=80;f+=20){h=n.convert(new Point(-180,f)),l=n.convert(new Point(180,f));if(this.isValid(h)&&this.isValid(l)){c=p.toString(),u=t.measureString(c,a);t.drawString(f.toString(),new Point(p,h.y+.5*u.height),a);t.drawLine(h.x,h.y,l.x,l.y)}}t.endGroup();return r};GeoGridLayer.prototype.isValid=function(t){return isFinite(t.x)&&isFinite(t.y)};return GeoGridLayer}(MapLayerBase);export{GeoGridLayer};_registerModule("wijmo.chart.map",selfModule);