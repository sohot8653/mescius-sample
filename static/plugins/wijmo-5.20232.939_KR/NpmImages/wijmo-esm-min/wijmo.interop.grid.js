/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var l in t)t.hasOwnProperty(l)&&(e[l]=t[l])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();import{_getModule,_registerModule}from"wijmo/wijmo";import*as wjcCore from"wijmo/wijmo";import*as wjcGrid from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.interop.grid";export function softInput(){return _getModule("wijmo.input")}export function softGridDetail(){return _getModule("wijmo.grid.detail")}var __gridCFRef=wjcGrid&&wjcGrid.CellFactory;if(!__gridCFRef){window.wijmo.grid={};window.wijmo.grid.CellFactory=function(){}}var DirectiveCellFactoryBase=function(e){__extends(DirectiveCellFactoryBase,e);function DirectiveCellFactoryBase(t){var l=e.call(this)||this;l._lastApplyTimeStamp=0;l._noApplyLag=!1;l._startingEditing=!1;l._cellStampCounter=0;l._composing=!1;l._isCheckingHeight=!1;l._backupHeight=-1;l._cacheRow=null;l.grid=t;if(!DirectiveCellFactoryBase._templateTypes){DirectiveCellFactoryBase._templateTypes=[];for(var i in GridCellTemplateType)isNaN(i)&&DirectiveCellFactoryBase._templateTypes.push(i)}var r=l;l._baseCf=t.cellFactory;t.cellFactory=l;l._evtInput=document.createEvent("HTMLEvents");l._evtInput.initEvent("input",!0,!1);l._evtBlur=document.createEvent("HTMLEvents");l._evtBlur.initEvent("blur",!1,!1);t.prepareCellForEdit.addHandler((function(e,t){r._noApplyLag=!0}));t.cellEditEnded.addHandler((function(e,l){var i=l.range,o=i.col;(o<0||o<t.columns.length&&!t._getBindingColumn(t.cells,i.row,t.columns[o])[DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType.CellEdit)])&&(r._editChar=null);setTimeout((function(){r._noApplyLag=!1}),300)}));t.beginningEdit.addHandler((function(e,t){r._startingEditing=!0}));t.hostElement.addEventListener("keydown",(function(e){r._startingEditing=!1}),!0);t.hostElement.addEventListener("keypress",(function(e){var l=e.charCode>32?String.fromCharCode(e.charCode):null;if(l&&wjcCore.closest(e.target,".wj-flexgrid")===t.hostElement)if(!t.activeEditor||r._startingEditing){r._editChar=l;setTimeout((function(){t.activeEditor||(r._editChar=null)}),0)}else r._editChar&&(r._editChar+=l)}),!0);t.hostElement.addEventListener("compositionstart",(function(e){r._composing=!0}),!0);t.hostElement.addEventListener("compositionend",(function(e){r._composing=!1}),!0);return l}DirectiveCellFactoryBase.prototype.updateCell=function(e,t,l,i,r){var o=this;this._cellStampCounter=(this._cellStampCounter+1)%1e7;var n=i[DirectiveCellFactoryBase._cellStampProp]=this._cellStampCounter;i.style.overflow&&(i.style.overflow="");var a=t,c=l;if(r&&!r.isSingleCell){t=r.row;l=r.col}var s,d=this,p=e.grid,u=p.editRange,C=e.rows[t],m=C.dataItem,f=!1,v=!1,g=!1,y=!1;switch(e.cellType){case wjcGrid.CellType.Cell:if(u&&u.row===t&&u.col===l){s=GridCellTemplateType.CellEdit;v=g=!0}else if(C instanceof wjcGrid.GroupRow){var _=!((y=m instanceof wjcCore.CollectionViewGroup)||C.hasChildren);if(l==e.columns.firstVisibleIndex)s=_?GridCellTemplateType.Cell:GridCellTemplateType.GroupHeader;else{s=_?GridCellTemplateType.Cell:GridCellTemplateType.Group;v=!0}}else C instanceof wjcGrid._NewRowTemplate?s=GridCellTemplateType.NewCellTemplate:softGridDetail()&&softGridDetail().DetailRow&&C instanceof softGridDetail().DetailRow||(s=GridCellTemplateType.Cell);break;case wjcGrid.CellType.ColumnHeader:s=GridCellTemplateType.ColumnHeader;break;case wjcGrid.CellType.RowHeader:s=p.collectionView&&p.collectionView.currentEditItem===m?GridCellTemplateType.RowHeaderEdit:GridCellTemplateType.RowHeader;f=!0;break;case wjcGrid.CellType.TopLeft:s=GridCellTemplateType.TopLeft;f=!0;break;case wjcGrid.CellType.ColumnFooter:s=GridCellTemplateType.ColumnFooter;v=!0;break;case wjcGrid.CellType.BottomLeft:s=GridCellTemplateType.BottomLeft;f=!0}var h=!1;if(null!=s){var w=null;y&&s==GridCellTemplateType.GroupHeader?w=p.getColumn(m.groupDescription.propertyName):l>=0&&l<e.columns.length&&(w=e.cellType===wjcGrid.CellType.ColumnHeader&&p._hasColumnGroups()?p._getColumnGroup(t,l):p._getBindingColumn(e,t,e.columns[l]));if(w){var E=DirectiveCellFactoryBase.getTemplContextProp,T=E(s),F=(f?p:w)[T];if(!F)if(s===GridCellTemplateType.RowHeaderEdit){T=E(s=GridCellTemplateType.RowHeader);F=p[T]}else if((s===GridCellTemplateType.Group||s===GridCellTemplateType.GroupHeader)&&!y){T=E(s=GridCellTemplateType.Cell);F=w[T]}if(F){var G;v&&(G=e.getCellData(t,l,!1));h=!0;var D=i.getAttribute(wjcGrid.FlexGrid._WJS_MEASURE),j=D&&"true"===D.toLowerCase();if(g){this.clearCell(i);this._baseCf.updateCell(e,a,c,i,r,!0)}var B,H=g&&p.imeEnabled,I=H&&this._composing,R=i[T],b={cell:i,column:w,row:C,panel:e,rng:r,isEdit:g,isImeInput:H,isTrueImeInput:I,templateContext:F,templateCache:R,templateContextProperty:T,cellStamp:n,cellValue:G};if(this.shouldInstantiate(b)){if(g){var S=i.firstElementChild;if(S){H||i.focus();S.style.display="none"}}else this.clearCell(i);this._doDisposeCell(i);this.renderTemplate(b,!0);b.templateCache=R=i[T];B=b.cellBindingsData}else{this.renderTemplate(b,!1);B=b.cellBindingsData}F.cellOverflow&&(i.style.overflow=F.cellOverflow);j?this.applyImmediately(b):F.autoSizeRows&&!H?this.checkHeight(b):g&&setTimeout((function(){H?o._initImeEditInput(b.cell,F):o._initEditInput(b.cell,F,null)}),0);if(g){d._cellEditorVars=B.localVars;var editEndingEH=function(e,t){p.cellEditEnding.removeHandler(editEndingEH);if(!t.stayInEditMode){var l=wjcCore.getActiveElement();l&&l.dispatchEvent(d._evtBlur);wjcCore.contains(i,wjcCore.getActiveElement())&&i.focus()}d._triggerEditorEvents(i);if(!t.cancel&&!t.stayInEditMode)for(var r=B.localVars,o=0,n=Object.getOwnPropertyNames(B.bindings);o<n.length;o++){var a=n[o];B.bindings[a].setValue(r,B.localVars.values[a])}var c=i.querySelectorAll(".wj-dropdown");[].forEach.call(c,(function(e){var t=wjcCore.Control.getControl(e);t&&softInput()&&t instanceof softInput().DropDown&&(t.isDroppedDown=!1)}))},editEndedEH_1=function(e,t){p.cellEditEnded.removeHandler(editEndedEH_1);d._cellEditorVars=null};p.cellEditEnding.addHandler(editEndingEH);p.cellEditEnded.addHandler(editEndedEH_1)}else this._baseCf.updateCell(e,a,c,i,r,!1)}}}if(!h){this._doDisposeCell(i);this._baseCf.updateCell(e,a,c,i,r)}};DirectiveCellFactoryBase.prototype.getEditorValue=function(t){if(this._cellEditorVars){var l=t.editRange;l&&l.isValid&&this._triggerEditorEvents(t.cells.getCellElement(l.row,l.col));return this._cellEditorVars.value}return e.prototype.getEditorValue.call(this,t)};DirectiveCellFactoryBase.prototype.disposeCell=function(e){this._doDisposeCell(e)};DirectiveCellFactoryBase.prototype.disposeTemplate=function(e,t,l){if(t){t.rootElement=null;t.column=null;e[t.templateContextProperty]=null;t.templateContextProperty=null}};DirectiveCellFactoryBase.prototype.setBindingsData=function(e,t,l,i,r,o){e.row=t;e.col=l;e.item=i;var n={},a=e.cell||{},c={},s={localVars:a,bindings:c};a.row=t;a.col=l;a.item=i;a.value=r;a.values=n;if(o)for(var d=0,p=Object.getOwnPropertyNames(o);d<p.length;d++){var u=p[d],C=new wjcCore.Binding(o[u]);c[u]=C;n[u]=C.getValue(a)}e.cell!==a&&(e.cell=a);return s};DirectiveCellFactoryBase.prototype.checkHeight=function(e){var t=this;this._isCheckingHeight||setTimeout((function(){var l=e.cell;if(e.cellStamp===l[DirectiveCellFactoryBase._cellStampProp]){var i=l.scrollHeight,r=e.panel.rows,o=e.row.index,n=e.rng,a=n&&n.rowSpan||1,c=e.isEdit;null!=r.maxSize&&(i=Math.min(i,r.maxSize));if(o<r.length&&r[o].renderHeight*a<i-1){var s=r.defaultSize=i/a;if(c){var d=t._isFullEdit(),p=t.grid;t._backupHeight=e.row.height;e.row.height=s;t._cacheRow=e.row;t._isCheckingHeight=!0;p.refresh();p.startEditing(d);t._isCheckingHeight=!1;return}}else c&&(e.isImeInput?t._initImeEditInput(e.cell,e.templateContext):t._initEditInput(e.cell,e.templateContext,null))}}),0)};DirectiveCellFactoryBase.prototype._restoreRowHeight=function(){if(!this._isCheckingHeight&&this._backupHeight>0){this._cacheRow.height=this._backupHeight;this._backupHeight=-1;this._cacheRow=null}};DirectiveCellFactoryBase.prototype.doDisposeCell=function(e){for(var t=DirectiveCellFactoryBase._templateTypes,l=0;l<t.length;l++){var i=DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType[t[l]]),r=e[i];if(r){var o=(r.column||this.grid)[i];this.disposeTemplate(e,r,o);t[l]==GridCellTemplateType[GridCellTemplateType.CellEdit]&&this._restoreRowHeight()}}};DirectiveCellFactoryBase.getTemplContextProp=function(e){return"$__cellTempl"+GridCellTemplateType[e]};DirectiveCellFactoryBase.prototype._doDisposeCell=function(e){this.doDisposeCell(e)};DirectiveCellFactoryBase.prototype._initEditInput=function(e,t,l){var i=this;this.setEditorFocusFlag(!0);var r=!1!==this.getEditorFocusFlag();this.setEditorFocusFlag(null);this._setFullEdit(t);r&&setTimeout((function(){var t=i._findInitialInput(e);if(t){var inpFocusEh=function(){t.removeEventListener("focus",inpFocusEh);setTimeout((function(){setTimeout((function(){var e=null!=l?l:i._editChar;if(e){t.value=e;i._editChar=null;DirectiveCellFactoryBase._setSelectionRange(t,e.length,e.length);t.dispatchEvent(i._evtInput)}}),0)}),DirectiveCellFactoryBase._FOCUS_INTERVAL)};t.addEventListener("focus",inpFocusEh);t.focus()}}),100)};DirectiveCellFactoryBase.prototype._initImeEditInput=function(e,t){var l=this,i=wjcCore.getActiveElement();if(i&&(i instanceof HTMLInputElement||i instanceof HTMLTextAreaElement)&&wjcCore.hasClass(i,"wj-grid-ime")){var r=this._findInitialInput(e),o=r&&r.style.color,n=this._composing,compEndEh_1=function(){i.removeEventListener("compositionend",compEndEh_1);wjcCore.setCss(i,wjcGrid._ImeHandler._cssHidden);l.setEditorFocusFlag(!0);r&&(r.style.color=o);l._initEditInput(e,t,n?i.value:null)};if(n){i.addEventListener("compositionend",compEndEh_1);if(r){var a=r.getBoundingClientRect(),c=i.getBoundingClientRect(),s=window.getComputedStyle(i),d=parseFloat(s.left),p=parseFloat(s.top);wjcCore.setCss(i,{left:d+a.left-c.left+"px",top:p+a.top-c.top+"px",width:a.width+"px",height:a.height+"px"});r.style.color="transparent"}}else setTimeout((function(){return compEndEh_1()}),DirectiveCellFactoryBase._FOCUS_INTERVAL)}};DirectiveCellFactoryBase.prototype._findInitialInput=function(e){var t=e&&e.rootElement&&e.rootElement.querySelectorAll("input,textarea")||e&&e.querySelectorAll("input,textarea");if(t)for(var l=0;l<t.length;l++){var i=t[l],r=window.getComputedStyle(i);if("none"!==r.display&&"visible"===r.visibility)return i}return null};DirectiveCellFactoryBase._setSelectionRange=function(e,t,l){void 0===l&&(l=t);if(wjcCore.contains(document.body,e)&&!e.disabled&&"none"!=e.style.display)try{e.setSelectionRange(wjcCore.asNumber(t),wjcCore.asNumber(l),wjcCore.isIE()?null:"backward");e.focus()}catch(e){}};DirectiveCellFactoryBase.prototype._triggerEditorEvents=function(e){if(e)for(var t=e.querySelectorAll(".wj-control"),l=0;l<t.length;l++){var i=t[l],r=wjcCore.Control.getControl(i);r&&this.flushPendingEvents(r)}};DirectiveCellFactoryBase.prototype._isFullEdit=function(){var e=this.grid;return!e.activeEditor||e._edtHdl._fullEdit};DirectiveCellFactoryBase.prototype._setFullEdit=function(e){var t=this.grid;e.forceFullEdit&&t.activeEditor&&(t._edtHdl._fullEdit=!0)};DirectiveCellFactoryBase._cellStampProp="__wjCellStamp";DirectiveCellFactoryBase._FOCUS_INTERVAL=wjcCore.Control._FOCUS_INTERVAL+20;return DirectiveCellFactoryBase}(wjcGrid.CellFactory);export{DirectiveCellFactoryBase};__gridCFRef||(window.wijmo.grid=null);export var GridCellTemplateType;!function(e){e[e.Cell=0]="Cell";e[e.CellEdit=1]="CellEdit";e[e.ColumnHeader=2]="ColumnHeader";e[e.RowHeader=3]="RowHeader";e[e.RowHeaderEdit=4]="RowHeaderEdit";e[e.TopLeft=5]="TopLeft";e[e.GroupHeader=6]="GroupHeader";e[e.Group=7]="Group";e[e.NewCellTemplate=8]="NewCellTemplate";e[e.ColumnFooter=9]="ColumnFooter";e[e.BottomLeft=10]="BottomLeft"}(GridCellTemplateType||(GridCellTemplateType={}));_registerModule("wijmo.interop.grid",selfModule);