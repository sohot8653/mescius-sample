/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.hasOwnProperty.call(e,o)&&(t[o]=e[o]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@grapecity/wijmo"),wijmo_grid_1=require("@grapecity/wijmo.grid"),selfModule=__importStar(require("@grapecity/wijmo.grid.transposedmultirow"));class _MultiRow extends wijmo_grid_1.Row{constructor(e,t){super(e);this._idxData=t}}exports._MultiRow=_MultiRow;class _Cell extends wijmo_grid_1.Column{constructor(e){super();this._row=this._col=0;this._rowspan=this._colspan=1;wijmo_1.copy(this,e)}get row(){return this._row}set row(e){this._row=wijmo_1.asInt(e,!1,!0)}get col(){return this._col}set col(e){this._col=wijmo_1.asInt(e,!1,!0)}get colspan(){return this._colspan}set colspan(e){this._colspan=wijmo_1.asInt(e,!1,!0);wijmo_1.assert(this._colspan>0,"colspan must be >= 1")}get rowspan(){return this._rowspan}set rowspan(e){this._rowspan=wijmo_1.asInt(e,!1,!0);wijmo_1.assert(this._rowspan>0,"colspan must be >= 1")}}exports._Cell=_Cell;class _CellGroup extends _Cell{constructor(e,t){super();this._colstart=0;this._rowstart=0;this._layout=e;this._g=e._grid;wijmo_1.copy(this,t);if(!this._cells)throw"Cell group with no cells?";let o=0,i=0;this._cells.forEach((e,t)=>{for(;!this._cellFits(e,t,o,i);)0==(i=(i+1)%this.colspan)&&o++;e.row=o;e.col=i});let l=1,r=1;this._cells.forEach(e=>{l=Math.max(l,e.row+e.rowspan);r=Math.max(r,e.col+e.colspan)});this.rowspan=l;this.colspan=r}_copy(e,t){if("cells"==e){this._cells=[];wijmo_1.isArray(t)&&t.forEach(e=>{let t=new _Cell(e);t.binding&&!t.header&&(t.header=wijmo_1.toHeaderCase(t.binding));this._cells.push(t);this.colspan=Math.max(this.colspan,t.colspan)});return!0}return!1}get cells(){return this._cells}closeGroup(e){if(e>this.colspan){this._cells.forEach(t=>{t.col==this.colspan-1&&(t.colspan=e-t.col)});this.colspan=e}this._cells.forEach(e=>{for(;e.col+e.colspan<this.colspan&&!this._slotTaken(e.row,e.col+e.colspan);)e.colspan++});this._cells.forEach(e=>{for(;e.row+e.rowspan<this.rowspan&&!this._slotTaken(e.row+e.rowspan,e.col);)e.rowspan++});for(let e=0;e<this.rowspan;e++)for(let t=0;t<this.colspan;t++)wijmo_1.assert(this._slotTaken(e,t),"Invalid layout (empty cells).");this._cols=new wijmo_grid_1.ColumnCollection(this._g,this._g.columns.defaultSize);this._rng=new Array(e*this.rowspan);this._cells.forEach(e=>{for(let t=0;t<e.rowspan;t++)for(let o=0;o<e.colspan;o++){let i=(e.row+t)*this.colspan+(e.col+o);this._cols.setAt(i,e);let l=new wijmo_grid_1.CellRange(e.row,e.col,e.row+e.rowspan-1,e.col+e.colspan-1);l.isSingleCell||(this._rng[i]=l)}});this._rng[-1]=new wijmo_grid_1.CellRange(this._rowstart,this._colstart,this._rowstart+this._rowspan-1,this._colstart)}getMergedRange(e,t,o){if(o<0)return this._rng[-1];let i=t-this._rowstart,l=o%this.colspan,r=this._rng[i*this.colspan+l];e.cellType==wijmo_grid_1.CellType.RowHeader&&o++;let s=t-i,n=o-l;return r?new wijmo_grid_1.CellRange(s+r.row,n+r.col,s+r.row2,n+r.col2):null}getBindingColumn(e,t,o){if(o<0)return this;let i=t-this._rowstart,l=o%this.colspan;return this._cols[i*this.colspan+l]}_cellFits(e,t,o,i){if(i>0&&i+e.colspan>this.colspan)return!1;for(let l=0;l<e.colspan;l++)if(this._slotTaken(o,i+l,t))return!1;this.colspan=Math.max(this.colspan,i+e.colspan-1);return!0}_slotTaken(e,t,o=this._cells.length){for(let i=0;i<o;i++){let o=this._cells[i];if(e>=o.row&&e<=o.row+o.rowspan-1&&t>=o.col&&t<=o.col+o.colspan-1)return!0}return!1}_updateCellTypes(e){this._cols.forEach(t=>{let o=t;null==o.dataType&&o._binding&&(o.dataType=wijmo_1.getType(o._binding.getValue(e)))})}}exports._CellGroup=_CellGroup;class _MergeManager extends wijmo_grid_1.MergeManager{getMergedRange(e,t,o,i=!0){let l=e.grid;if(t<0||t>=e.rows.length||o<0||o>=e.columns.length)return null;switch(e.cellType){case wijmo_grid_1.CellType.Cell:case wijmo_grid_1.CellType.RowHeader:let i=e.rows[t].dataItem._rowInfo.index,r=o;e.cellType==wijmo_grid_1.CellType.RowHeader&&r--;let s=l._getGroupByRow(t);wijmo_1.assert(s instanceof _CellGroup,"Failed to get the group!");let n=s.getMergedRange(e,i,r);if(n){let o=i,l=t;if(t>0){o=e.rows[t-1].dataItem._rowInfo.index;l=t-1}n.row<=o?n.row=l:n.row=t;let r=i,s=t;if(t<e.rows.length-1){r=e.rows[t+1].dataItem._rowInfo.index;s=t+1}n.row2>=r?n.row2=s:n.row2=t}wijmo_1.assert(!n||n.contains(t,o),"Merged range must contain source cell");return n;case wijmo_grid_1.CellType.ColumnHeader:let a=l.columnsPerItem,_=o-o%a,w=Math.min(_+a-1,e.columns.length-1);return new wijmo_grid_1.CellRange(0,_,e.rows.length-1,w);case wijmo_grid_1.CellType.TopLeft:return new wijmo_grid_1.CellRange(0,0,e.rows.length-1,e.columns.length-1)}return null}}exports._MergeManager=_MergeManager;class _MultiRowLayout{constructor(e,t){this._columnsPerItem=1;this._bindingGroups=[];this._groupsByRow={};this._grid=e;this._bindingGroups=this._parseCellGroups(t)}get totalRowSpan(){let e=this._bindingGroups;if(e&&e.length){let t=e[e.length-1];return t._rowstart+t.rowspan}return 0}_parseCellGroups(e){let t=[],o=1;if(e){for(let i=0,l=0;i<e.length;i++){let r=new _CellGroup(this,e[i]);r._rowstart=l;l+=r._rowspan;o=Math.max(o,r._colspan);t.push(r)}t.forEach(e=>{e.closeGroup(o)});this._columnsPerItem=o}return t}_getGroupByRow(e){let t=this._getGroupIndexByRow(e);return t>-1?this._bindingGroups[t]:null}_getGroupIndexByRow(e){let t=this._groupsByRow[e];if(t)return t;let o=this._bindingGroups;for(let t=0;t<o.length;t++){let i=o[t];if(e>=i._rowstart&&e<=i._rowstart+i._rowspan-1){this._groupsByRow[e]=t;return t}}return-1}_updateCellTypes(e){this._bindingGroups.forEach(t=>{t._updateCellTypes(e)})}}exports._MultiRowLayout=_MultiRowLayout;class TransposedMultiRow extends wijmo_grid_1.FlexGrid{constructor(e,t){super(e);this._currentPos=-1;this._bindingColumns={};this._keyPrefix="item";wijmo_1.addClass(this.hostElement,"wj-transposed-multirow");this._layout=new _MultiRowLayout(this,null);this.allowDragging=wijmo_grid_1.AllowDragging.None;this.allowSorting=wijmo_grid_1.AllowSorting.None;this.mergeManager=new _MergeManager;this.formatItem.addHandler(this._formatItem,this);this._rowInfo=new wijmo_grid_1.ColumnCollection(this,this.columns.defaultSize);this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this)}get layoutDefinition(){return this._layoutDef}set layoutDefinition(e){this._layoutDef=wijmo_1.asArray(e);this._layout=new _MultiRowLayout(this,e);this._rowInfoChanged()}getBindingColumn(e,t,o){if(e.cellType!=wijmo_grid_1.CellType.Cell)return null;let i=t>-1?e.rows[t]:null,l=null!=i?i.dataItem._rowInfo:null,r=null!=l?l.index:-1,s=r+"_"+o,n=this._bindingColumns[s];if(n)return n;if(t>-1){let i=this._getGroupByRow(t).getBindingColumn(e,r,o);if(i){n=new wijmo_grid_1.Column;wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Column).forEach(e=>{null!=i[e]&&(n[e]=i[e])});let e=Math.floor(o/this.columnsPerItem),t=o%this.columnsPerItem;n.binding=this._keyPrefix+e+"_"+t;this._bindingColumns[s]=n}}return n}get columnsPerItem(){return this._layout._columnsPerItem}get allowAddNew(){return!1}set allowAddNew(e){wijmo_1.assert(!e,"TransposedMultiRow does not support items addition.")}get allowDelete(){return!1}set allowDelete(e){wijmo_1.assert(!e,"TransposedMultiRow does not support items deletion.")}get allowDragging(){return wijmo_grid_1.AllowDragging.None}set allowDragging(e){wijmo_1.assert(e===wijmo_grid_1.AllowDragging.None,"TransposedMultiRow does not support dragging.");if(e!==this._alDragging){this._alDragging=e;this.invalidate()}}get allowPinning(){return!1}set allowPinning(e){wijmo_1.assert(!e,"TransposedMultiRow does not support pinning.")}get allowSorting(){return wijmo_grid_1.AllowSorting.None}set allowSorting(e){wijmo_1.assert(e===wijmo_grid_1.AllowSorting.None,"TransposedMultiRow does not support sorting.");this._alSorting=e}get columnLayout(){throw"TransposedMultiRow does not support column layout."}set columnLayout(e){throw"TransposedMultiRow does not support column layout."}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}onLoadedRows(e){let t=this.columnHeaders.columns;for(let e=0;e<t.length;e++)this.columnHeaders.setCellData(0,e,"");let o=this.columns;for(let e=0;e<o.length;e++){let t=o[e];t.align=null;t.dataType=0}let i=this.rowHeaders.columns;this.rows.forEach(e=>{let t=e.dataItem._rowInfo;if(t)for(let o=i.length-2;o>=0;o--){let i=t.headers[o]||wijmo_1.toHeaderCase(t.bindings[o]);this.rowHeaders.setCellData(e.index,o+1,i)}});i[0].visible=!1;for(let e=1;e<i.length;e++){i[e].align="left";i[e].visible=!0;i[e].width=this.columns.defaultSize}super.onLoadedRows(e)}_getGroupByRow(e){let t=this.cells.rows[e].dataItem._rowInfo.index,o=this._layout._getGroupByRow(t);wijmo_1.assert(o instanceof _CellGroup,"Failed to get the group!");return o}_addBoundRow(e,t){let o=e[t];this.rows.push(new _MultiRow(o,t))}_updateColumnTypes(){super._updateColumnTypes();let e=this.collectionView;if(wijmo_1.hasItems(e)&&this._layout){let t=e.items[0]._arr;t&&t.length>0&&this._layout._updateCellTypes(t[0])}}_getBindingColumn(e,t,o){if(this._layout){e==this.cells&&o&&(o=this.getBindingColumn(e,t,o.index));return o}return super._getBindingColumn(e,t,o)}_isTransposed(){return!0}_autoSizeRows(){this.autoSizeMode&wijmo_grid_1.AutoSizeMode.Both&&this.autoSizeRows();super._autoSizeRows()}onRowEditEnded(e){if(null!=this._view){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change);this._view.collectionChanged.raise(this._view,e)}super.onRowEditEnded(e)}_getCollectionView(e){let t=null;null!=this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);if(wijmo_1.isArray(e))e=this._transposeItemsSource(e);else if(e){this._view&&this._view.collectionChanged.removeHandler(this._sourceViewChanged);this._view=wijmo_1.tryCast(e,"ICollectionView");if(this._view){this._view.collectionChanged.addHandler(this._sourceViewChanged,this);e instanceof wijmo_1.CollectionView&&(t=e.getError);e=this._transposeItemsSource(this._view.items)}}this.autoGenerateColumns=!0;let o=super._getCollectionView(e);o&&this._currentPos>=0&&(o.currentPosition=Math.min(o.items.length-1,this._currentPos));t&&o instanceof wijmo_1.CollectionView&&(o.getError=(e,o)=>{if(null==o)return null;let i=e._keys.indexOf(o),l=i%e._bnd.length,r=Math.floor(i/e._bnd.length);return t(e._arr[r],e._bnd[l].path)});return o}_rowInfoChanged(){try{let e=this.collectionView;this._currentPos=e?e.currentPosition:-1;let t=this.selection;this._bindingColumns={};let o=this.itemsSource;this.itemsSource=null;this.itemsSource=o;t&&t.isValid&&(this.selection=t)}finally{this._currentPos=-1}}_formatItem(e,t){let o=this.columnsPerItem,i=t.panel,l=i.cellType,r=i.rows[t.range.row],s=(i.rows[t.range.row2],t.cell);l==wijmo_grid_1.CellType.RowHeader&&wijmo_1.toggleClass(s,"wj-group-header",0==t.range.row);if(l==wijmo_grid_1.CellType.Cell||l==wijmo_grid_1.CellType.RowHeader){let e=this._getGroupByRow(t.row);wijmo_1.toggleClass(s,"wj-group-start",e._rowstart==t.range.row);wijmo_1.toggleClass(s,"wj-group-end",e._rowstart+e._rowspan-1==t.range.row2)}if(o>1&&(l==wijmo_grid_1.CellType.Cell||l==wijmo_grid_1.CellType.ColumnHeader)){wijmo_1.toggleClass(s,"wj-record-start",t.range.col%o==0);wijmo_1.toggleClass(s,"wj-record-end",t.range.col2%o==o-1)}let n=this.alternatingRowStep;if(n&&l==wijmo_grid_1.CellType.Cell){let e=this._layout.totalRowSpan,t=this._layout._bindingGroups.length,o=Math.floor(r.dataIndex/e)*t,i=r.dataIndex%e,l=(o+=this._layout._getGroupIndexByRow(i)+1)%(n+1)==0;wijmo_1.toggleClass(s,"wj-alt",l)}if(l==wijmo_grid_1.CellType.RowHeader){let e=r.dataItem._rowInfo,o=this._getGroupByRow(t.row).getBindingColumn(i,e.index,t.col);wijmo_1.toggleClass(s,"wj-wrap",o.wordWrap)}}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new wijmo_1.ObservableArray;if(this._layout&&this._layout._bindingGroups.length){this._getRowInfo(e).forEach((o,i)=>{let l=this._createKeys(e);if(this._supportsProxies()){let i=this._createProxy(e,o,l);t.push(i)}else{let i=this._createTransposedObject(e,o,l);t.push(i)}});e instanceof wijmo_1.ObservableArray&&e.collectionChanged.addHandler((e,o)=>{if(o.action===wijmo_1.NotifyCollectionChangedAction.Change)this.activeEditor||this.invalidate();else{let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()}})}return t}_createKeys(e){let t=Array.apply(null,{length:this.columnsPerItem}),o=e.map((e,o)=>t.map((e,t)=>this._keyPrefix+o+"_"+t));return[].concat.apply([],o)}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,o){let i={_arr:e,_rowInfo:t,_bnd:t.bindings.map(e=>new wijmo_1.Binding(e)),_keys:o};return new Proxy(i,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let o=e._keys.indexOf(t);if(o>-1){let t=e._bnd,i=e._arr,l=t.length,r=o%l,s=Math.floor(o/l);return t[r].getValue(i[s])}return e[t]},set:(e,t,o)=>{let i=e._keys.indexOf(t);if(i>-1){let t=e._bnd,l=e._arr,r=t.length,s=i%r,n=Math.floor(i/r);t[s].setValue(l[n],o);if(l instanceof wijmo_1.ObservableArray||l instanceof wijmo_1.CollectionView){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,l[n],n);l.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,o){let i={_arr:e,_rowInfo:t,_bnd:t.bindings.map(e=>new wijmo_1.Binding(e)),_keys:o};for(let t=0;t<o.length;t++){let l=o[t];Object.defineProperty(i,l,{enumerable:!0,get:()=>{let o=i._bnd,l=o.length,r=t%l,s=Math.floor(t/l);return o[r].getValue(e[s])},set:o=>{let l=i._bnd,r=l.length,s=t%r,n=Math.floor(t/r);l[s].setValue(e[n],o);if(e instanceof wijmo_1.ObservableArray){let t=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,e[n],n);e.onCollectionChanged(t)}return!0}})}return i}_getRowInfo(e){let t=[];if(this._layout){let e=this.rowHeaders.columns,o=this.columnsPerItem+1;for(;e.length>o;)e.removeAt(e.length-1);for(;e.length<o;)e.push(new wijmo_grid_1.Column);this._layout._bindingGroups.forEach(e=>{for(let o=0;o<e.rowspan;o++){let i={index:e._rowstart+o,bindings:[],headers:[]};for(let t=0;t<e.colspan;t++)for(let l=0;l<e.cells.length;l++){let r=e.cells[l];if(o>=r.row&&o<r.row+r.rowspan&&t>=r.col&&t<r.col+r.colspan){i.bindings.push(r.binding);i.headers.push(r.header);break}}t.push(i)}})}return t}}exports.TransposedMultiRow=TransposedMultiRow;wijmo_1._registerModule("wijmo.grid.transposedmultirow",selfModule);