/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(s,n){function fulfilled(e){try{step(i.next(e))}catch(e){n(e)}}function rejected(e){try{step(i.throw(e))}catch(e){n(e)}}function step(e){e.done?s(e.value):new r((function(t){t(e.value)})).then(fulfilled,rejected)}step((i=i.apply(e,t||[])).next())}))};import{asArray,asBoolean,asInt,copy,clamp,CollectionView,Event,CancelEventArgs,_registerModule}from"wijmo/wijmo";import*as selfModule from"wijmo/wijmo.rest";export class RestCollectionView extends CollectionView{constructor(e){super();this._loading=!1;this._fields=null;this._keys=null;this._sortOnServer=!0;this._pageOnServer=!0;this._filterOnServer=!0;this._totalItemCount=0;this.loading=new Event;this.loaded=new Event;this.error=new Event;e&&copy(this,e);this.sortDescriptions.collectionChanged.addHandler(()=>{this.sortOnServer&&this._getData()});this._getData()}get fields(){return this._fields}set fields(e){if(this._fields!=e){this._fields=asArray(e);this._getData()}}get sortOnServer(){return this._sortOnServer}set sortOnServer(e){if(e!=this._sortOnServer){this._sortOnServer=asBoolean(e);this._getData()}}get pageOnServer(){return this._pageOnServer}set pageOnServer(e){if(e!=this._pageOnServer){this._pageOnServer=asBoolean(e);this._getData()}}get filterOnServer(){return this._filterOnServer}set filterOnServer(e){if(e!=this._filterOnServer){this._filterOnServer=asBoolean(e);this._getData()}}get requestHeaders(){return this._requestHeaders}set requestHeaders(e){this._requestHeaders=e}updateFilterDefinition(e){if(this.filterOnServer){this._filterProvider=e;this._getData()}}get isLoading(){return this._loading}onLoading(e){this.loading.raise(this,e)}onLoaded(e){this.loaded.raise(this,e)}load(){this._getData()}onError(e){this.error.raise(this,e);return!e.cancel}_performRefresh(){let e=this._canFilter,t=this._canSort;this._canFilter=!this._filterOnServer;this._canSort=!this._sortOnServer;super._performRefresh();this._canFilter=e;this._canSort=t}get totalItemCount(){return this.pageOnServer?this._totalItemCount:this._view.length}get pageCount(){return this.pageSize?Math.ceil(this.totalItemCount/this.pageSize):1}get pageSize(){return this._pgSz}set pageSize(e){if(e!=this._pgSz){this._pgSz=asInt(e);if(this.pageOnServer){this._pgIdx=clamp(this._pgIdx,0,this.pageCount-1);this._getData()}else this.refresh()}}onPageChanging(e){super.onPageChanging(e);this.pageOnServer&&!e.cancel&&this._getData();return!e.cancel}commitNew(){let e=this.currentAddItem;if(e)try{let t=this.addItem(e);t&&t.then&&t.then(()=>this.refresh())}catch(e){this._raiseError(e,!0)}super.commitNew()}commitEdit(){let e=this.currentEditItem;if(e&&!this.currentAddItem&&!this._sameContent(e,this._edtClone)&&this.items.indexOf(e)>-1)try{let t=this.patchItem(e);t&&t.then&&t.then(()=>this.refresh())}catch(e){this._raiseError(e,!0)}super.commitEdit()}remove(e){if(e&&e!=this.currentAddItem&&this.items.indexOf(e)>-1)try{let t=this.deleteItem(e);t&&t.then&&t.then(()=>this.refresh())}catch(e){this._raiseError(e,!0)}super.remove(e)}_getPageView(){return this.pageOnServer?this._view:super._getPageView()}_getData(){this._toGetData&&clearTimeout(this._toGetData);this._toGetData=setTimeout(()=>__awaiter(this,void 0,void 0,(function*(){this._toGetData=null;this._loading=!0;this.onLoading();let e=null,t=null;try{let t=this.currentPosition;e=yield this.getItems();this.sourceCollection=e;this.refresh();t>-1&&this.moveCurrentToPosition(t);this.pageIndex>0&&this.pageIndex>=this.pageCount&&this.moveToLastPage()}catch(e){t=e}this._loading=!1;this.onLoaded();t&&this._raiseError(t,!1)})),100)}_raiseError(e,t){if(this.onError(new RESTErrorEventArgs(e))){t&&this._getData();throw"Server Error: "+e}}getItems(){throw"This method is virtual: it should be overridden"}addItem(e){throw"This method is virtual: it should be overridden"}patchItem(e){throw"This method is virtual: it should be overridden"}deleteItem(e){throw"This method is virtual: it should be overridden"}}export class RESTErrorEventArgs extends CancelEventArgs{constructor(e){super();this._error=e}get error(){return this._error}}_registerModule("wijmo.rest",selfModule);