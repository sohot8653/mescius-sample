<div class="content_top">
    <div class="cont_tit">대리점별매출실적</div>
    <div class="div">
        <button class="btn_search">
        <i class="ico_srch"></i>
        <span>search</span>
        </button>
    </div>
</div>
        
<div class="search_box active">
    <table class="srch_tbl">
        <colgroup>
        <col width="10.9%">
        <col width="*">
        <col width="10.9%">
        <col width="*">
        <col width="10.9%">
        <col width="*">
        </colgroup>
        <tbody>
        <tr>
            <th>업체코드</th>
            <td>
                <input type="text" value="">
            </td>
            <th>업체명</th>
            <td>
                <input type="text" value="">
            </td>
            <th>오픈일자</th>
            <td class="ipt_date_wrap">
                <div class="ipt_date_div">
                    <input type="text" class="ipt_date datepicker">
                </div>
                <span class="line">-</span>
                <div class="ipt_date_div">
                    <input type="text" class="ipt_date datepicker">
                </div>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<div class="content_box" style="height: calc(100vh - 360px);">
    <div class="sample-tutorial">
        <div id="ss" class="sample-spreadsheets"></div>
        <div class="options-container">
                <div class="inputContainer" style="height: 50%;">
                    템플릿명 <input id="txtTemplateName">
                    <div id="sampleDiv3" style="height: 70%;"></div>
                    <div class="col-xs-4" style="float:right;">
                        <input id="setButton" class="button" type="button" value="적용"/>
                        <input id="saveButton" class="button" type="button" value="저장"/>
                    </div>
                </div>
                <div class="inputContainer" style="height: 50%;">
                    <div id="sampleDiv4" style="height: 100%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
.sample-tutorial {
   position: relative;
   height: 100%;
   overflow: hidden;
}

.sample-spreadsheets {
  width: calc(100% - 500px);
  height: 100%;
  overflow: hidden;
  float: left;
}

.options-container {
  float: right;
  width: 500px;
  padding: 3px;
  height: 100%;
  box-sizing: border-box;
  background: #fbfbfb;
  overflow: auto;
}

.sample-options {
  z-index: 1000;
}

.inputContainer {
  width: 100%;
  height: auto;
  border: 1px solid #eee;
  padding: 6px 12px;
  margin-bottom: 10px;
  box-sizing: border-box;
}

.input {
  font-size: 14px;
  border: 0;
  outline: none;
  background: transparent;
}

.button {
  height: 30px;
  padding: 6px 6px;
  width: 80px;
  margin-top: 6px;
}

body {
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
}
</style>

<script>
var tables = {};
var selectedTable = "order";
var dataTemplate = [
    {
        id: 0,
        name: '기본 컬럼 구조',
        column: [
            [
                "업체코드",
                "업체코드"
            ],
            [
                "업체명",
                "업체명"
            ],
            [
                "오픈일자",
                "오픈일자"
            ],
            [
                "합계",
                "합계"
            ]
        ]
    },
    {
        id: 1,
        name: '계산값 추가',
        column: [
        [
                "업체코드",
                "업체코드"
            ],
            [
                "업체명",
                "업체명"
            ],
            [
                "오픈일자",
                "오픈일자"
            ],
            [
                "합계",
                '=CONCATENATE([@합계],"원")'
            ],
            [
                "합계(VAT+)",
                '=CONCATENATE(ROUND([@합계] + ([@합계] * 0.1), 0),"원")'
            ],
            [
                "시공비 합계",
                '=CONCATENATE(ROUND([@합계] + ([@합계] * 0.1) + ([@합계] * 0.2), 0),"원")'
            ],
            [
                "배송비 합계",
                '=CONCATENATE(ROUND([@합계] + ([@합계] * 0.1) + ([@합계] * 0.2) + 100000, 0),"원")'
            ],
        ]
    }
]
window.onload = function () {
    var mainSpread = new GC.Spread.Sheets.Workbook(document.getElementById("ss"));
    var dataManager = mainSpread.dataManager();
    tables.order = dataManager.addTable("orderTable", {
        data: getData()
    });
    
    var columnsSpread = new GC.Spread.Sheets.Workbook(document.getElementById("sampleDiv3"));
    var sheet = columnsSpread.getActiveSheet();
    columnsSpread.options.tabStripVisible = false;
    columnsSpread.options.showHorizontalScrollbar = false;
    columnsSpread.options.scrollbarMaxAlign = true;
    
    sheet.setColumnCount(2);
    sheet.setRowCount(10);
    sheet.setColumnWidth(0, 100);
    sheet.setColumnWidth(1, "*");
    sheet.setText(0,0,"헤더명",1);
    sheet.setText(0,1,"출력값",1);
    sheet.getRange(-1,1,-1,1).formatter("@");
    
    document.getElementById("setButton").addEventListener("click", function (e) {
        setView();
    }, false);
    document.getElementById("saveButton").addEventListener("click", function (e) {
        insertTemplate();
    }, false);
    var spread = GC.Spread.Sheets.findControl( document.getElementById("sampleDiv3"));
    var sheet = spread.getActiveSheet();
    sheet.setArray(0, 0, dataTemplate.find(x => x.id == 1).column);

    var columnsSpread = new GC.Spread.Sheets.Workbook(document.getElementById("sampleDiv4"));
    var sheet = columnsSpread.getActiveSheet();
    columnsSpread.options.tabStripVisible = false;
    columnsSpread.options.showHorizontalScrollbar = false;
    columnsSpread.options.scrollbarMaxAlign = true;
    sheet.setColumnCount(2);
    sheet.setRowCount(dataTemplate.map(x => [x.name]).length);
    sheet.setColumnWidth(0, 60);
    sheet.setColumnWidth(1, "*");
    sheet.setText(0,0,"ID",1);
    sheet.setText(0,1,"템플릿",1);
    sheet.getRange(-1,1,-1,1).formatter("@");
    sheet.setArray(0, 0, dataTemplate.map(x => [x.id, x.name]));
    sheet.options.isProtected = true;
    sheet.selectionPolicy(0);
    sheet.selectionUnit(1);
    sheet.bind(GC.Spread.Sheets.Events.SelectionChanging, function (e, info) {
        switchTable(sheet.getValue(info.newSelections[0].row, 0));
    });

    setView();
};

function switchTable (templateId) {
    var spread = GC.Spread.Sheets.findControl( document.getElementById("sampleDiv3"));
    var sheet = spread.getActiveSheet();
    sheet.clear(0, 0, sheet.getRowCount(), sheet.getColumnCount(), GC.Spread.Sheets.SheetArea.viewport, GC.Spread.Sheets.StorageType.data);
    sheet.setArray(0, 0, dataTemplate.find(x => x.id == templateId).column);
    setView();
}
function setView () {
    var spread = GC.Spread.Sheets.findControl( document.getElementById("sampleDiv3"));
    var sheet = spread.getActiveSheet();
    var rowCount = sheet.getRowCount();
    var fields = [];
    for (var i = 0; i < rowCount; i++) {
        var value = sheet.getValue(i, 1);
        if (value) {
            fields.push({value: value, caption: sheet.getValue(i, 0), width: 200, headerStyle: {backColor : "#5A74AB", foreColor:"white"}});
        }
    }
    var view = tables[selectedTable].addView("selectedTable"+(new Date()).valueOf(), fields);

    var spread = GC.Spread.Sheets.findControl( document.getElementById("ss"));
    spread.clearSheets();
    spread.clearSheetTabs();
    var sheet = spread.addSheetTab(0, "TableSheet1", GC.Spread.Sheets.SheetType.tableSheet);
    sheet.options.allowAddNew = false;
    sheet.actionColumn.options({ visible: false });
    sheet.setDefaultRowHeight(40, GC.Spread.Sheets.SheetArea.colHeader);
    spread.options.autoFitType = GC.Spread.Sheets.AutoFitType.cellWithHeader;

    view.fetch().then(function(args) {
        sheet.suspendPaint();
        sheet.setDataView(view);
        sheet.resumePaint();
    });
}

function insertTemplate() {
    var spread = GC.Spread.Sheets.findControl( document.getElementById("sampleDiv3"));
    var sheet = spread.getActiveSheet();
    dataTemplate.push({
        id: Math.max(...dataTemplate.map(x => x.id)) + 1,
        name: document.getElementById('txtTemplateName').value || '이름없음',
        column: sheet.getArray(0, 0, sheet.getRowCount(), sheet.getColumnCount())
    })

    var spread = GC.Spread.Sheets.findControl( document.getElementById("sampleDiv4"));
    var sheet = spread.getActiveSheet();
    sheet.clear(0, 0, sheet.getRowCount(), sheet.getColumnCount(), GC.Spread.Sheets.SheetArea.viewport, GC.Spread.Sheets.StorageType.data);
    sheet.setRowCount(dataTemplate.map(x => [x.name]).length);
    sheet.setArray(0, 0, dataTemplate.map(x => [x.id, x.name]));
}

function getData() {
  let arr = [];

  for(var i = 1; i < 150; i++) {

      var local = getRandomArrayElement([['서울/경인', '서울 서초구 양재동'], ['경상', '부산광역시 남구'], ['강원', '강원 원주시'], ['경기/수원', '경기 수원시 영통구'], ['경기/이천', '경기 이천시 이천구']]);
      var obj = {};
      obj.업체코드 = Math.floor(Math.random() * (140000 - 110000)) + 110000;
      obj.업체명 = ['디자인앤바스', '위생도기앤델라', '마누스인테리어', '(주)제이유산업', '자람건설', '오티시스템'][Math.floor(Math.random() * 6)];
      obj.오픈일자 = ['2015-01-05', '2018-05-18', '2019-07-25', '1997-02-03', '1999-05-08', '2001-12-18'][Math.floor(Math.random() * 6)];
      obj.합계 = Math.floor(Math.random() * (140000 - 110000)) + 110000;
      arr.push(obj);
  }

  function getRandomDate(start, end) {
      const startDate = start.getTime();
      const endDate = end.getTime();
          
      return new Date(startDate + Math.random() * (endDate - startDate));
  }

  function getRandomArrayElement(arr) {
      return arr[Math.floor(Math.random() * arr.length)]
  }


  return arr;
}
</script>