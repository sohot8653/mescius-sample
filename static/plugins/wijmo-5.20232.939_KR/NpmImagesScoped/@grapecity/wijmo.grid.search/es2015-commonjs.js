/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)Object.hasOwnProperty.call(t,i)&&(e[i]=t[i]);e.default=t;return e};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@grapecity/wijmo"),wijmo_grid_1=require("@grapecity/wijmo.grid"),selfModule=__importStar(require("@grapecity/wijmo.grid.search"));class FlexGridSearch extends wijmo_1.Control{constructor(t,e){super(t);this._delay=wijmo_1.Control._SEARCH_DELAY;this._cssMatch="wj-state-match";this._searchAllColumns=!1;this._rxSrch=null;this._rxHilite=null;let i=this.getTemplate();this.applyTemplate("wj-control wj-content wj-flexgridsearch",i,{_tbx:"input",_btn:"btn"},"input");this._filterBnd=this._filter.bind(this);this._tbx.addEventListener("input",()=>{this._toSearch&&clearTimeout(this._toSearch);this._toSearch=setTimeout(()=>{this._toSearch=null;this._applySearch()},this._delay)});this._btn.addEventListener("click",()=>{this._toSearch&&clearTimeout(this._toSearch);this._toSearch=null;this._tbx.value="";this._applySearch();this.containsFocus()&&this._tbx.focus()});this.initialize(e)}get grid(){return this._g}set grid(t){if((t=wijmo_1.asType(t,wijmo_grid_1.FlexGrid,!0))!=this._g){let e=this._g;if(e){e.formatItem.removeHandler(this._formatItem);e.itemsSourceChanged.removeHandler(this._itemsSourceChanged)}e=this._g=t;this._itemsSourceChanged();if(e){e.formatItem.addHandler(this._formatItem,this);e.itemsSourceChanged.addHandler(this._itemsSourceChanged,this)}}}get inputElement(){return this._tbx}get text(){return this._tbx.value}set text(t){if(t!=this.text){this._tbx.value=wijmo_1.asString(t);this._applySearch()}}get delay(){return this._delay}set delay(t){this._delay=wijmo_1.asNumber(t,!1,!0)}get placeholder(){return this._tbx.placeholder}set placeholder(t){this._tbx.placeholder=t}get cssMatch(){return this._cssMatch}set cssMatch(t){this._cssMatch=wijmo_1.asString(t)}get searchAllColumns(){return this._searchAllColumns}set searchAllColumns(t){this._searchAllColumns=wijmo_1.asBoolean(t)}_formatItem(t,e){if(this._rxHilite&&this._cssMatch&&e.panel==t.cells&&!e.getColumn()._getFlag(wijmo_grid_1.RowColFlags.HasTemplate)&&!e.cell.querySelector("input")){let t=e.cell.innerHTML;this._rxHilite.test(t)&&(e.cell.innerHTML=t.replace(this._rxHilite,'<span class="'+this._cssMatch+'">$1</span>'))}}_itemsSourceChanged(){this._cv&&this._cv.filters.remove(this._filterBnd);let t=this._g?this._g.collectionView:null;this._cv=t instanceof wijmo_1.CollectionView?t:null;this._cv&&this._cv.filters.push(this._filterBnd)}_applySearch(){let t=this._g;this._rxSrch=this._rxHilite=null;let e=wijmo_1.escapeRegExp(this.text).split(" ").filter(t=>t);if(e.length){let i=t&&t.caseSensitiveSearch?"g":"gi";this._rxSrch=new RegExp("(?=.*"+e.join(")(?=.*")+")",i);e=e.map(t=>_escapeHtml(t));this._rxHilite=new RegExp("("+e.join("|")+")(?![^<]*>)",i)}let i=t?t.collectionView:null;i instanceof wijmo_1.CollectionView&&i.refresh()}_filter(t){if(this._rxSrch&&this._g){let e=this._getItemText(t);return this._rxSrch.test(e)}return!0}_getItemText(t){let e=[],i=this._g._getBindingColumns();for(let s=0;s<i.length;s++){let l=i[s],r=l._binding;if(r&&(l.visible||this.searchAllColumns)){let i=r.getValue(t);i=l.dataMap?l.dataMap.getDisplayValue(i):wijmo_1.Globalize.format(i,l.format);l.isContentHtml&&(i=wijmo_1.toPlainText(i));i&&e.push(i)}}return e.join(" ")}}FlexGridSearch.controlTemplate='<div class="wj-template"><div class="wj-input"><div class="wj-input-group wj-input-btn-visible"><input wj-part="input" type="text" class="wj-form-control"/><span wj-part="btn" class="wj-input-group-btn"><button class="wj-btn wj-btn-default" tabindex="-1">&times</button></span></div></div></div>';exports.FlexGridSearch=FlexGridSearch;const _ENTITYMAP={"&":"&amp;","<":"&lt;",">":"&gt;"};function _escapeHtml(t){t&&wijmo_1.isString(t)&&(t=t.replace(/[&<>]/g,t=>_ENTITYMAP[t]));return null!=t?t.toString():""}wijmo_1._registerModule("wijmo.grid.search",selfModule);