/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

var __extends=this&&this.__extends||function(){var extendStatics=function(e,t){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};return function(e,t){extendStatics(e,t);function __(){this.constructor=e}e.prototype=null===t?Object.create(t):(__.prototype=t.prototype,new __)}}();import{_addCultureInfo,Key,Control,culture,copy,asEnum,asNumber,asBoolean,asFunction,isFunction,isNumber,animate,setCss,closest,closestClass,addClass,hasClass,setAriaLabel,setAttribute,_registerModule}from"wijmo/wijmo";import{Row,FlexGrid,MergeManager,CellRange,CellType,_NewRowTemplate,GroupRow}from"wijmo/wijmo.grid";import*as selfModule from"wijmo/wijmo.grid.detail";var DetailRow=function(e){__extends(DetailRow,e);function DetailRow(t){var i=e.call(this)||this;i.isReadOnly=!0;return i}Object.defineProperty(DetailRow.prototype,"detail",{get:function(){return this._detail},set:function(e){this._detail=e},enumerable:!0,configurable:!0});return DetailRow}(Row);export{DetailRow};var DetailMergeManager=function(e){__extends(DetailMergeManager,e);function DetailMergeManager(t){var i=e.call(this)||this;i._originalMergeManager=t.mergeManager;return i}DetailMergeManager.prototype.getMergedRange=function(e,t,i,r){void 0===r&&(r=!0);switch(e.cellType){case CellType.Cell:if(e.rows[t]instanceof DetailRow){e.columns.frozen>0&&e.grid&&(e.grid.cloneFrozenCells=!1);return new CellRange(t,0,t,e.columns.length-1)}break;case CellType.RowHeader:var o=_isFrozen(e,t),l=_isNew(e,t),n=e.rows[t].dataItem;!n&&t>0&&e.rows[t]instanceof DetailRow&&(n=e.rows[t-1].dataItem);for(var a=t;a>0&&e.rows[a-1].dataItem==n&&_isFrozen(e,a-1)==o&&_isNew(e,a-1)==l;)a--;for(var s=t;s<e.rows.length-1&&e.rows[s+1].dataItem==n&&_isFrozen(e,s+1)==o&&_isNew(e,s+1)==l;)s++;s<e.rows.length-1&&e.rows[s+1]instanceof DetailRow&&_isFrozen(e,s+1)==o&&_isNew(e,s+1)==l&&s++;return a!=s?new CellRange(a,i,s,i):null}return this._originalMergeManager.getMergedRange(e,t,i,r)};return DetailMergeManager}(MergeManager);export{DetailMergeManager};function _isFrozen(e,t){return t<e.rows.frozen}function _isNew(e,t){return e.rows[t]instanceof _NewRowTemplate}_addCultureInfo("FlexGridDetailProvider",{ariaLabels:{toggleDetail:"Toggle Row Detail"}});export var KeyAction;!function(e){e[e.None=0]="None";e[e.ToggleDetail=1]="ToggleDetail"}(KeyAction||(KeyAction={}));export var DetailVisibilityMode;!function(e){e[e.Code=0]="Code";e[e.Selection=1]="Selection";e[e.ExpandSingle=2]="ExpandSingle";e[e.ExpandMulti=3]="ExpandMulti"}(DetailVisibilityMode||(DetailVisibilityMode={}));var FlexGridDetailProvider=function(){function FlexGridDetailProvider(e,t){var i=this;this._maxHeight=null;this._mode=DetailVisibilityMode.ExpandSingle;this._animated=!1;this._keyActionEnter=KeyAction.None;this._g=e;e.mergeManager=new DetailMergeManager(e);e.rowHeaders.hostElement.addEventListener("click",this._hdrClick.bind(this));e.rowHeaders.hostElement.addEventListener("mousedown",(function(t){var r=e.editableCollectionView;if(e.activeEditor||r&&r.currentEditItem){i._hdrClick(t);t.preventDefault()}}));setTimeout((function(){e.formatItem.addHandler(i._formatItem,i)}),100);e.selectionChanged.addHandler(this._selectionChanged,this);e.resizedRow.addHandler(this._resizedRow,this);e.loadingRows.addHandler((function(){return i.hideDetail()}));e.deletingRow.addHandler((function(e,t){i.hideDetail(t.row)}));e.updatedView.addHandler(this._handleFrozenCells,this);e.cloneFrozenCells=!1;e.draggingRow.addHandler((function(e,t){if(t.row<e.rows.length-1&&e.rows[t.row+1]instanceof DetailRow){t.cancel=!0;i.hideDetail(t.row)}}));e.hostElement.addEventListener("keydown",(function(e){if(e.keyCode==Key.Enter&&i._keyActionEnter==KeyAction.ToggleDetail){var t=i._g.selection.row;i._toggleRowDetail(t)&&e.preventDefault()}}),!0);e._root.addEventListener("scroll",(function(){hasClass(e.activeCell,"wj-detail")&&Control.sharedState.InvalidScroll||Control.refreshAll(e._root)}));copy(this,t)}Object.defineProperty(FlexGridDetailProvider.prototype,"grid",{get:function(){return this._g},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"detailVisibilityMode",{get:function(){return this._mode},set:function(e){if((e=asEnum(e,DetailVisibilityMode))!=this._mode){this._mode=e;this.hideDetail();this._g.invalidate()}},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"maxHeight",{get:function(){return this._maxHeight},set:function(e){if((e=asNumber(e,!0))!=this._maxHeight){this._maxHeight=e;this.hideDetail()}},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"isAnimated",{get:function(){return this._animated},set:function(e){e!=this._animated&&(this._animated=asBoolean(e))},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"keyActionEnter",{get:function(){return this._keyActionEnter},set:function(e){this._keyActionEnter=asEnum(e,KeyAction)},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"createDetailCell",{get:function(){return this._createDetailCellFn},set:function(e){this._createDetailCellFn=asFunction(e,!0)},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"disposeDetailCell",{get:function(){return this._disposeDetailCellFn},set:function(e){this._disposeDetailCellFn=asFunction(e,!0)},enumerable:!0,configurable:!0});Object.defineProperty(FlexGridDetailProvider.prototype,"rowHasDetail",{get:function(){return this._rowHasDetailFn},set:function(e){if((e=asFunction(e,!0))!=this._rowHasDetailFn){this._rowHasDetailFn=e;this.hideDetail();this._g.invalidate()}},enumerable:!0,configurable:!0});FlexGridDetailProvider.prototype.getDetailRow=function(e){for(var t=this._g.rows,i=this._toIndex(e),r=t[i]?t[i].dataItem:void 0;i<t.length;i++){var o=t[i];if(o instanceof DetailRow)return o;if(o.dataItem!=r)return null}return null};FlexGridDetailProvider.prototype.isDetailVisible=function(e){return null!=this.getDetailRow(e)};FlexGridDetailProvider.prototype.isDetailAvailable=function(e){e=this._toIndex(e);return this._hasDetail(e)};FlexGridDetailProvider.prototype.hideDetail=function(e){var t=this._g,i=t.rows;if(null!=e){var r=this._toIndex(e);if(r<=t.rows.frozen-1){t.rows.frozenDetailChildren-=1;t.rows.frozen-=1}for(;!(i[r]instanceof DetailRow)&&r<i.length-1;)r++;var o=i[r];if(o instanceof DetailRow){var l=o.detail.parentElement;if(l)for(var n=l.querySelectorAll(".wj-control"),a=0;a<n.length;a++){var s=Control.getControl(n[a]);s&&s.containsFocus()&&t.focus(!0)}var d=this.disposeDetailCell;!!d&&d(o)||Control.disposeAll(o.detail);i.removeAt(r)}}else for(var c=0;c<i.length;c++)i[c]instanceof DetailRow&&this.hideDetail(c)};FlexGridDetailProvider.prototype.showDetail=function(e,t){void 0===t&&(t=!1);var i=this._g,r=i.rows,o=this._toIndex(e);if(o<=i.rows.frozen-1){i.rows.frozenDetailChildren+=1;i.rows.frozen+=1}o>0&&r[o]instanceof DetailRow&&o--;for(var l=r[o].dataItem;o<r.length-1&&r[o+1].dataItem==l;)o++;if(t){for(var n=i.selection,a=!1,s=0;s<r.length-1;s++)if(s!=o&&r[s+1]instanceof DetailRow){this.hideDetail(s);s<o&&o--;if(s<n.row){n.row--;n.row2--;a=!0}}a&&i.select(n,!1)}if(!this.isDetailVisible(o)&&this._hasDetail(o)){var d=new DetailRow(r[o]),c=this._createDetailCell(r[o]);d.detail=c;if(c){r.insert(o+1,d);var u=i.containsFocus();if(this._animated){var h=c.style;h.transform="translateY(-100%)";h.opacity="0";animate((function(e){if(e<1){h.transform="translateY("+(100*-(1-e)).toFixed(0)+"%)";h.opacity=(e*e).toString()}else{h.transform=h.opacity="";Control.invalidateAll(c);u&&i.scrollIntoView(o+1,-1)}}))}else u&&i.scrollIntoView(o+1,-1,!0)}}};FlexGridDetailProvider.prototype._sizeDetailRow=function(e,t){void 0===t&&(t=!1);var i=this._g,r=e.detail;Control.refreshAll(r);var o=t?r.scrollHeight:r.offsetHeight,l=o+i._cellPadVert+1,n=this._maxHeight;isNumber(n)&&n>0&&l>n&&(l=n);e.height=l;r.style.height||(r.style.height="100%");var a=r.querySelector(".wj-flexgrid");a&&!a.style.height&&(a.style.height="100%");return o};FlexGridDetailProvider.prototype._handleFrozenCells=function(){var e=this._g,t=e.hostElement,i=Control.getControl(t.querySelector(".wj-flexgrid"));if(i instanceof FlexGrid&&(i.rows.frozen||i.columns.frozen)){setCss([e._eTL,e._eBL,e._eCFtr,e._eRHdr,e._eMarquee],{zIndex:"13"});setCss(e._eCHdr,{zIndex:"14"});for(var r=t.querySelectorAll(".wj-frozen"),o=0;o<r.length;o++){var l=r[o];if(closest(l,".wj-flexgrid")==t){var n=parseInt(l.style.zIndex);l.style.zIndex=(n%10+10).toString()}}}};FlexGridDetailProvider.prototype._toIndex=function(e){return e instanceof Row?e.index:asNumber(e)};FlexGridDetailProvider.prototype._hdrClick=function(e){if(!e.defaultPrevented&&0==e.button&&closestClass(e.target,FlexGridDetailProvider._WJC_DETAIL)){var t=DetailVisibilityMode;switch(this._mode){case t.ExpandMulti:case t.ExpandSingle:var i=this._g,r=i.hitTest(e.target);r.panel||(r=i.hitTest(e));r.panel&&this._toggleRowDetail(r.row)&&e.preventDefault()}}};FlexGridDetailProvider.prototype._toggleRowDetail=function(e){if(e>-1){if(this.isDetailVisible(e)){this.hideDetail(e);return!0}if(this._hasDetail(e)){var t=this._g;t.select(new CellRange(e,0,e,t.columns.length-1));this.showDetail(e,this._mode==DetailVisibilityMode.ExpandSingle);return!0}}return!1};FlexGridDetailProvider.prototype._selectionChanged=function(e,t){var i=this;if(this._mode==DetailVisibilityMode.Selection){this._toSel&&clearTimeout(this._toSel);this._toSel=setTimeout((function(){var t=e._selHdl.selection.row;t>-1?i.showDetail(t,!0):i.hideDetail()}),300)}};FlexGridDetailProvider.prototype._formatItem=function(e,t){var i=this,r=this._g,o=t.cell,l=t.getRow(),n=DetailVisibilityMode;if(t.panel==r.cells&&l instanceof DetailRow&&null!=l.detail&&!hasClass(o,"wj-detail")){addClass(o,"wj-detail");o.textContent="";o.style.textAlign="";o.className=o.className.replace(/wj\-align\-[\S]+/g,"");o.appendChild(l.detail);null==l.height?0===this._sizeDetailRow(l)&&setTimeout((function(){i._sizeDetailRow(l,!0)}),1):Control.refreshAll(l.detail)}if(t.panel==r.rowHeaders&&0==t.col&&this._hasDetail(t.row)){o.style.cursor="";switch(this._mode){case n.ExpandMulti:case n.ExpandSingle:var a=this.isDetailVisible(t.row),s=a?"minus":"plus",d=FlexGridDetailProvider._WJC_DETAIL;o.innerHTML='<div class="wj-btn wj-btn-glyph '+d+'" role="button" tabindex="-1"><span class="wj-glyph-'+s+'"></span></div>';var c=o.children[0],u=culture.FlexGridDetailProvider.ariaLabels.toggleDetail;setAriaLabel(c,u);setAttribute(c,"aria-expanded",a)}}};FlexGridDetailProvider.prototype._resizedRow=function(e,t){var i=t.getRow();i instanceof DetailRow&&i.detail&&Control.refreshAll(i.detail)};FlexGridDetailProvider.prototype._hasDetail=function(e){var t=this._g.rows[e];return isFunction(this._rowHasDetailFn)?this._rowHasDetailFn(t):this._isRegularRow(t)};FlexGridDetailProvider.prototype._isRegularRow=function(e){return!(e instanceof _NewRowTemplate||e instanceof DetailRow)&&!(e instanceof GroupRow&&!this._g.childItemsPath)};FlexGridDetailProvider.prototype._createDetailCell=function(e){return this.createDetailCell?this.createDetailCell(e):null};FlexGridDetailProvider._WJC_DETAIL="wj-elem-detail";return FlexGridDetailProvider}();export{FlexGridDetailProvider};_registerModule("wijmo.grid.detail",selfModule);