/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)Object.hasOwnProperty.call(e,o)&&(t[o]=e[o]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_grid_1=require("@grapecity/wijmo.grid"),wijmo_1=require("@grapecity/wijmo"),selfModule=__importStar(require("@grapecity/wijmo.grid.transposed"));class _MergeManager extends wijmo_grid_1.MergeManager{getMergedRange(e,t,o,r=!0){let i=e.grid,s=i._hasColumnGroups();if(e==i.columnHeaders&&s)return null;if(e==i.rowHeaders&&s){if(t<0||t>=e.rows.length||o<0||o>=e.columns.length)return null;let r=i._getColumnGroup(t,o);if(r){let o=r._rng,i=e.rows;if(i.isFrozen(o.row)!=i.isFrozen(o.row2)){o=o.clone();i.isFrozen(t)?o.row2=i.frozen-1:o.row=i.frozen}return o}return null}return super.getMergedRange(e,t,o,r)}}exports._MergeManager=_MergeManager;class TransposedGrid extends wijmo_grid_1.FlexGrid{constructor(e,t){super(e,null);this._keyPrefix="item";this._autoGenRows=!0;wijmo_1.addClass(this.hostElement,"wj-transposed-grid");this.allowSorting=wijmo_grid_1.AllowSorting.None;this.headersVisibility=wijmo_grid_1.HeadersVisibility.Row;this._rowInfo=new wijmo_grid_1.ColumnCollection(this,this.columns.defaultSize);this._grpHdl=new _RowGroupHandler(this);this.mergeManager=new _MergeManager;this.initialize(t);this._rowInfo.collectionChanged.addHandler(this._rowInfoChanged,this);this.deferUpdate(()=>{let e=this.rowHeaders.columns;if(e.length){e[e.length-1].width=this.columns.defaultSize}})}get autoGenerateRows(){return this._autoGenRows}set autoGenerateRows(e){this._autoGenRows=wijmo_1.asBoolean(e)}get rowGroups(){return this._grpHdl.getGroupDefinitions()}set rowGroups(e){this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();this._grpHdl.createColumnGroups(wijmo_1.asArray(e))})}refresh(e){let t=this._rowInfo;if(t._dirty){t._dirty=!1;this._rowInfoChanged()}else super.refresh(e)}get allowAddNew(){return!1}set allowAddNew(e){}get allowDelete(){return!1}set allowDelete(e){}get allowSorting(){return wijmo_grid_1.AllowSorting.None}set allowSorting(e){wijmo_1.assert(e===wijmo_grid_1.AllowSorting.None,"TransposedGrid does not support sorting.");this._alSorting=e}get columnGroups(){return null}set columnGroups(e){throw"TransposedGrid does not support columnGroups, use rowGroups instead."}onRowEditEnded(e){let t=wijmo_1.tryCast(this._sourceItems,"ICollectionView");if(t){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change);t.collectionChanged.raise(t,e)}super.onRowEditEnded(e)}_getCollectionView(e){let t=wijmo_1.tryCast(this._sourceItems,"ICollectionView");t&&t.collectionChanged.removeHandler(this._sourceViewChanged);t=wijmo_1.tryCast(e,"ICollectionView");let o=e;if(wijmo_1.isArray(e))o=this._transposeItemsSource(e);else if(t){t.collectionChanged.addHandler(this._sourceViewChanged,this);o=this._transposeItemsSource(t.items)}this.autoGenerateColumns=!0;let r=super._getCollectionView(o),i=null;t instanceof wijmo_1.CollectionView&&(i=t.getError);i&&r instanceof wijmo_1.CollectionView&&(this._supportsProxies()?r.getError=(e,t)=>{if(null==t)return null;let o=e._keys.indexOf(t);return i(e._arr[o],e._bnd.path)}:r.getError=(e,t)=>{if(null==t)return null;let o=parseInt(t.substr(this._keyPrefix.length));return i(e._arr[o],e._rowInfo.binding)});this._sourceItems=e;return r}_getColumnTypes(e){let t,o;if(this._sourceItems)if(wijmo_1.isArray(this._sourceItems))o=this._sourceItems;else{let e=wijmo_1.tryCast(this._sourceItems,"ICollectionView");e&&(o=e.items)}return t=o?o.map((e,t)=>({binding:this._keyPrefix+t,dataType:wijmo_1.DataType.Object})):wijmo_1.getTypes(e)}_copy(e,t){if(/rows|columns/.test(e)){wijmo_1.assert(wijmo_1.isArray(t),"Array Expected.");let e=wijmo_1.asArray(t);e.some(e=>null!=e.columns)?this.rowGroups=e:this._rowInfo.deferUpdate(()=>{this.autoGenerateRows=!1;this._rowInfo.clear();t.forEach(e=>{let t=new TransposedGridRow(e);this._rowInfo.push(t)})});return!0}return super._copy(e,t)}onLoadedRows(e){let t=this.columns;for(let e=0;e<t.length;e++){let o=t[e];o.align=null;o.dataType=0}let o=this.rowHeaders.columns;for(let e=0;e<o.length;e++){o[e].align="left";o[e].width=0}let r=wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Row);this.rows.forEach(e=>{let t=e.dataItem._rowInfo;if(t){this._copyProps(t,e,r,["showDropDown","width","size"]);if(this._hasColumnGroups())for(let t=0;t<o.length;t++){let o=this._grpHdl.getColumnGroup(e.index,t);o&&this._updateRowHeaders(e.index,t,o)}else o.length&&this._updateRowHeaders(e.index,o.length-1,t)}});for(let e=0;e<o.length;e++)0===o[e].width&&(o[e].width=this.columns.defaultSize);super.onLoadedRows(e)}_getBindingColumn(e,t,o){let r=o;if(e!=this.cells)return r;let i=e.rows[t],s=i&&i.dataItem&&i.dataItem._rowInfo;if(wijmo_1.isUndefined(s))return r;r=new wijmo_grid_1.Column;let n=wijmo_grid_1.FlexGrid._getSerializableProperties(wijmo_grid_1.Column);this._copyProps(s,r,n);r.binding=o.binding;r.header=s.header||wijmo_1.toHeaderCase(s.binding);return r}_isTransposed(){return!0}_autoSizeRows(){this.autoSizeMode&wijmo_grid_1.AutoSizeMode.Both&&this.autoSizeRows();super._autoSizeRows()}_copyProps(e,t,o,r=[]){for(let i in e)if(o.indexOf(i)>-1&&-1===r.indexOf(i)){let o=e[i];if(!wijmo_1.isUndefined(o))try{t[i]=o}catch(e){}}}_updateRowHeaders(e,t,o){let r=o.header||wijmo_1.toHeaderCase(o.binding);this.rowHeaders.setCellData(e,t,r);let i=this.rowHeaders.columns,s=o.width;if(wijmo_1.isNumber(s)&&s>0){let e=o._rng;if(e&&e instanceof wijmo_grid_1.CellRange&&e.isValid){let t=e.columnSpan;wijmo_1.assert(t>0,"Column span is negative or equal to 0");s/=t}i[t].width=Math.max(i[t].width,s)}}_rowInfoChanged(){this._toRowInfo&&clearTimeout(this._toRowInfo);this._toRowInfo=setTimeout(()=>{let e=this.selection,t=this.itemsSource;this.itemsSource=null;this.itemsSource=t;this.selection=e},wijmo_1.Control._REFRESH_INTERVAL)}_sourceViewChanged(e,t){this.activeEditor||this.invalidate()}_transposeItemsSource(e){let t=new wijmo_1.ObservableArray,o=wijmo_1.getTypes(e),r=e.map((e,t)=>this._keyPrefix+t);(this.autoGenerateRows?this._getRowInfo(e):this._rowInfo).forEach((i,s)=>{let n=new wijmo_1.Binding(i.binding);if(null==i.dataType&&e.length){let t=n.getValue(e[0]);i.dataType=null!=t?wijmo_1.getType(t):o[s].dataType}if(this._supportsProxies()){let o=this._createProxy(e,i,r);t.push(o)}else{let o=this._createTransposedObject(e,i,this._keyPrefix);t.push(o)}});e instanceof wijmo_1.ObservableArray&&e.collectionChanged.addHandler((e,o)=>{if(o.action===wijmo_1.NotifyCollectionChangedAction.Change)this.activeEditor||this.invalidate();else{let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Reset);t.onCollectionChanged(e);this._rowInfoChanged()}});return t}_supportsProxies(){return null!=window.Proxy}_createProxy(e,t,o){let r={_arr:e,_rowInfo:t,_bnd:new wijmo_1.Binding(t.binding),_keys:o};return new Proxy(r,{ownKeys:e=>e._keys,getOwnPropertyDescriptor:()=>({enumerable:!0,configurable:!0,writable:!0}),get:(e,t)=>{let o=e._keys.indexOf(t);return o>-1?e._bnd.getValue(e._arr[o]):e[t]},set:(e,t,o)=>{let r=e._keys.indexOf(t);if(r>-1){let t=e._arr,i=t[r];e._bnd.setValue(i,o);if(t instanceof wijmo_1.ObservableArray){let e=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,i,r);t.onCollectionChanged(e)}return!0}return!1}})}_createTransposedObject(e,t,o){let r={_arr:e,_rowInfo:t},i=new wijmo_1.Binding(t.binding);for(let t=0;t<e.length;t++){let s=e[t];Object.defineProperty(r,o+t,{enumerable:!0,get:()=>i.getValue(s),set:o=>{i.setValue(s,o);if(e instanceof wijmo_1.ObservableArray){let o=new wijmo_1.NotifyCollectionChangedEventArgs(wijmo_1.NotifyCollectionChangedAction.Change,s,t);e.onCollectionChanged(o)}return!0}})}return r}_getRowInfo(e){let t=[];wijmo_1.getTypes(e).forEach(e=>{let o=e.binding,r=e.dataType;if(r!=wijmo_1.DataType.Object&&r!=wijmo_1.DataType.Array){let e={binding:o,header:wijmo_1.toHeaderCase(o),dataType:r},i=wijmo_grid_1.FlexGrid._defTypeWidth[r];if(null!=i){if(wijmo_1.isString(i)){let e=Math.round(parseFloat(i));i=i.indexOf("*")<0?e:e*this.columns.defaultSize}wijmo_1.isNumber(i)&&i>0&&(e.width=i)}t.push(e)}});return t}}exports.TransposedGrid=TransposedGrid;class TransposedGridRow extends wijmo_grid_1.Column{get height(){return this._height}set height(e){this._height=e}}exports.TransposedGridRow=TransposedGridRow;class _RowGroupHandler{constructor(e){this._grid=e}get columnGroups(){return null}createColumnGroups(e){this._createRowGroups(e)}hasColumnGroups(){return null!=this._colGroups&&this._colGroups.length>0}getGroupDefinitions(){return this._groupDefs}getColumnGroup(e,t){let o=this._grid;if(t<o.rowHeaders.columns.length&&e<o._rowInfo.length)for(let o=this._colGroups;o;){let r=o;for(let r=0;r<o.length;r++){let i=o[r],s=i._rng;if(s.containsRow(e)){if(s.containsColumn(t)||0==i.columns.length)return i;o=i.columns;break}}if(o==r)break}return null}canMoveColumnGroup(e,t,o,r){return this._grid.columns.canMoveElement(t,r)}moveColumnGroup(e,t,o,r,i){return this._grid.columns.moveElement(t,r)}_createRowGroups(e){let t=this._grid;this._groupDefs=wijmo_1.asArray(e);t.autoGenerateRows=!1;t._rowInfo.clear();this._colGroups=[];e.forEach(e=>{this._colGroups.push(new _RowGroup(e,null))});let o=1;this._colGroups.forEach(e=>{this._addRowGroup(e);o=Math.max(o,e._getMaxLevel())});this._colGroups.forEach(e=>{e._expandRange(o)});let r=t.rowHeaders.columns;r.clear();for(let e=0;e<=o;e++){let t=new wijmo_grid_1.Column;r.splice(e,0,t);e<o&&(t.cssClassAll="wj-colgroup")}}_addRowGroup(e){let t=this._grid;e._grid=t;e._rng.row=t._rowInfo.length;0==e.columns.length?t._rowInfo.push(e):e.columns.forEach(e=>{this._addRowGroup(e)});e._rng.row2=t._rowInfo.length-1}}exports._RowGroupHandler=_RowGroupHandler;class _RowGroup extends wijmo_grid_1.Column{constructor(e,t){super();this._rng=new wijmo_grid_1.CellRange(-1,0);this._cols=[];this._lvl=0;this._collapsed=!1;this._pGrp=t;this._lvl=0;for(let e=t;e;e=e._pGrp)this._lvl++;t&&t.columns.indexOf(this)<0&&t.columns.push(this);this._rng.col=this._rng.col2=this._lvl;this.allowDragging=!1;wijmo_1.copy(this,e)}get columns(){return this._cols}set columns(e){let t=this._cols=[];e.forEach(e=>{let o=new _RowGroup(e,this);t.indexOf(o)<0&&t.push(o)})}get rows(){return this._cols}get isEmpty(){return 0===this._cols.length}get height(){return this._height}set height(e){this._height=e}get level(){let e=this,t=0;for(;e._pGrp;){e=e._pGrp;t++}return t}get collapseTo(){return this._collTo}set collapseTo(e){wijmo_1.assert(wijmo_1.isArray(e)||wijmo_1.isString(e),"collapseTo should be an array or a string.");this._collTo=e}get isCollapsed(){return this._collapsed}set isCollapsed(e){if(e!=this._collapsed){let t=this._grid;if(t){let o=new wijmo_grid_1.CellRangeEventArgs(t.rowHeaders,this._rng,this);if(t.onColumnGroupCollapsedChanging(o)){this._collapsed=wijmo_1.asBoolean(e);t.onColumnGroupCollapsedChanged(o)}}else this._collapsed=wijmo_1.asBoolean(e)}setTimeout(()=>{this._updateCollapsedState()})}_copy(e,t){if(/rows|columns/.test(e)){let e=wijmo_1.asArray(t);this.columns=e;return!0}return!1}_updateCollapsedState(){let e=this._grid._rowInfo,t=this._rng,o=this._collapsed;this._cols.forEach(e=>{if(e instanceof _RowGroup){e._collapsed=o;e._updateCollapsedState()}});let r=this._getCollapseToIndices();for(let i=t.topRow;i<=t.bottomRow;i++)e[i].visible=!o||r.indexOf(i)>-1}_getMaxLevel(){let e=this._lvl;this.columns.forEach(t=>{e=Math.max(e,t._getMaxLevel())});return e}_expandRange(e){let t=e-this._getMaxLevel();if(t>0){this._rng.col2+=t;this._cols.forEach(e=>{e._shiftRange(t)})}let o=this._grid._rowInfo,r=this._rng;for(let t=r.row;t<=r.row2;t++){o[t]._rng.col2=e}}_shiftRange(e){this._rng.col+=e;this._rng.col2+=e;this._cols.forEach(t=>{t._shiftRange(e)})}_getCollapseToBindings(){let e=this.collapseTo;return wijmo_1.isString(e)?[e]:e}_getCollapseToIndices(){let e=this._grid,t=this._rng,o=this._getCollapseToBindings();if(o&&o.length){let r=[],i=e._rowInfo;for(let e=0;e<o.length;e++)switch(o[e]){case"$first":r.push(t.topRow);break;case"$last":r.push(t.bottomRow);break;default:let s=i.indexOf(o[e]);s>-1&&r.push(s)}if(r.length)return r}return[t.bottomRow]}}exports._RowGroup=_RowGroup;wijmo_1._registerModule("wijmo.grid.transposed",selfModule);