/*!
    *
    * Wijmo Library 5.20232.939
    * https://developer.mescius.com/wijmo
    *
    * Copyright(c) MESCIUS inc. All rights reserved.
    *
    * Licensed under the End-User License Agreement For MESCIUS Wijmo Software.
    * us.sales@mescius.com
    * https://developer.mescius.com/wijmo/licensing
    *
    */

"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var l in e)Object.hasOwnProperty.call(e,l)&&(t[l]=e[l]);t.default=e;return t};Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("wijmo/wijmo"),wjcCore=__importStar(require("wijmo/wijmo")),wjcGrid=__importStar(require("wijmo/wijmo.grid")),selfModule=__importStar(require("wijmo/wijmo.interop.grid"));function softInput(){return wijmo_1._getModule("wijmo.input")}exports.softInput=softInput;function softGridDetail(){return wijmo_1._getModule("wijmo.grid.detail")}exports.softGridDetail=softGridDetail;var GridCellTemplateType,__gridCFRef=wjcGrid&&wjcGrid.CellFactory;if(!__gridCFRef){window.wijmo.grid={};window.wijmo.grid.CellFactory=function(){}}class DirectiveCellFactoryBase extends wjcGrid.CellFactory{constructor(e){super();this._lastApplyTimeStamp=0;this._noApplyLag=!1;this._startingEditing=!1;this._cellStampCounter=0;this._composing=!1;this._isCheckingHeight=!1;this._backupHeight=-1;this._cacheRow=null;this.grid=e;if(!DirectiveCellFactoryBase._templateTypes){DirectiveCellFactoryBase._templateTypes=[];for(var t in GridCellTemplateType)isNaN(t)&&DirectiveCellFactoryBase._templateTypes.push(t)}var l=this;this._baseCf=e.cellFactory;e.cellFactory=this;this._evtInput=document.createEvent("HTMLEvents");this._evtInput.initEvent("input",!0,!1);this._evtBlur=document.createEvent("HTMLEvents");this._evtBlur.initEvent("blur",!1,!1);e.prepareCellForEdit.addHandler((function(e,t){l._noApplyLag=!0}));e.cellEditEnded.addHandler((function(t,i){let r=i.range,o=r.col;(o<0||o<e.columns.length&&!e._getBindingColumn(e.cells,r.row,e.columns[o])[DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType.CellEdit)])&&(l._editChar=null);setTimeout((function(){l._noApplyLag=!1}),300)}));e.beginningEdit.addHandler((function(e,t){l._startingEditing=!0}));e.hostElement.addEventListener("keydown",(function(e){l._startingEditing=!1}),!0);e.hostElement.addEventListener("keypress",(function(t){var i=t.charCode>32?String.fromCharCode(t.charCode):null;if(i&&wjcCore.closest(t.target,".wj-flexgrid")===e.hostElement)if(!e.activeEditor||l._startingEditing){l._editChar=i;setTimeout(()=>{e.activeEditor||(l._editChar=null)},0)}else l._editChar&&(l._editChar+=i)}),!0);e.hostElement.addEventListener("compositionstart",(function(e){l._composing=!0}),!0);e.hostElement.addEventListener("compositionend",(function(e){l._composing=!1}),!0)}updateCell(e,t,l,i,r){this._cellStampCounter=(this._cellStampCounter+1)%1e7;let o=i[DirectiveCellFactoryBase._cellStampProp]=this._cellStampCounter;i.style.overflow&&(i.style.overflow="");let n=t,a=l;if(r&&!r.isSingleCell){t=r.row;l=r.col}let s,d=this,c=e.grid,p=c.editRange,u=e.rows[t],m=u.dataItem,C=!1,h=!1,g=!1,_=!1;switch(e.cellType){case wjcGrid.CellType.Cell:if(p&&p.row===t&&p.col===l){s=GridCellTemplateType.CellEdit;h=g=!0}else if(u instanceof wjcGrid.GroupRow){var f=!((_=m instanceof wjcCore.CollectionViewGroup)||u.hasChildren);if(l==e.columns.firstVisibleIndex)s=f?GridCellTemplateType.Cell:GridCellTemplateType.GroupHeader;else{s=f?GridCellTemplateType.Cell:GridCellTemplateType.Group;h=!0}}else u instanceof wjcGrid._NewRowTemplate?s=GridCellTemplateType.NewCellTemplate:softGridDetail()&&softGridDetail().DetailRow&&u instanceof softGridDetail().DetailRow||(s=GridCellTemplateType.Cell);break;case wjcGrid.CellType.ColumnHeader:s=GridCellTemplateType.ColumnHeader;break;case wjcGrid.CellType.RowHeader:s=c.collectionView&&c.collectionView.currentEditItem===m?GridCellTemplateType.RowHeaderEdit:GridCellTemplateType.RowHeader;C=!0;break;case wjcGrid.CellType.TopLeft:s=GridCellTemplateType.TopLeft;C=!0;break;case wjcGrid.CellType.ColumnFooter:s=GridCellTemplateType.ColumnFooter;h=!0;break;case wjcGrid.CellType.BottomLeft:s=GridCellTemplateType.BottomLeft;C=!0}var w=!1;if(null!=s){let p=null;_&&s==GridCellTemplateType.GroupHeader?p=c.getColumn(m.groupDescription.propertyName):l>=0&&l<e.columns.length&&(p=e.cellType===wjcGrid.CellType.ColumnHeader&&c._hasColumnGroups()?c._getColumnGroup(t,l):c._getBindingColumn(e,t,e.columns[l]));if(p){var T=DirectiveCellFactoryBase.getTemplContextProp,E=T(s),y=(C?c:p)[E];if(!y)if(s===GridCellTemplateType.RowHeaderEdit){E=T(s=GridCellTemplateType.RowHeader);y=c[E]}else if((s===GridCellTemplateType.Group||s===GridCellTemplateType.GroupHeader)&&!_){E=T(s=GridCellTemplateType.Cell);y=p[E]}if(y){var v;h&&(v=e.getCellData(t,l,!1));{w=!0;let t=i.getAttribute(wjcGrid.FlexGrid._WJS_MEASURE),l=t&&"true"===t.toLowerCase();if(g){this.clearCell(i);this._baseCf.updateCell(e,n,a,i,r,!0)}let s,m=g&&c.imeEnabled,C=m&&this._composing,h=i[E],_={cell:i,column:p,row:u,panel:e,rng:r,isEdit:g,isImeInput:m,isTrueImeInput:C,templateContext:y,templateCache:h,templateContextProperty:E,cellStamp:o,cellValue:v};if(this.shouldInstantiate(_)){if(g){var G=i.firstElementChild;if(G){m||i.focus();G.style.display="none"}}else this.clearCell(i);this._doDisposeCell(i);this.renderTemplate(_,!0);_.templateCache=h=i[E];s=_.cellBindingsData}else{this.renderTemplate(_,!1);s=_.cellBindingsData}y.cellOverflow&&(i.style.overflow=y.cellOverflow);l?this.applyImmediately(_):y.autoSizeRows&&!m?this.checkHeight(_):g&&setTimeout(()=>{m?this._initImeEditInput(_.cell,y):this._initEditInput(_.cell,y,null)},0);if(g){d._cellEditorVars=s.localVars;var editEndingEH=function(e,t){c.cellEditEnding.removeHandler(editEndingEH);if(!t.stayInEditMode){let e=wjcCore.getActiveElement();e&&e.dispatchEvent(d._evtBlur);wjcCore.contains(i,wjcCore.getActiveElement())&&i.focus()}d._triggerEditorEvents(i);if(!t.cancel&&!t.stayInEditMode){let e=s.localVars,t=Object.getOwnPropertyNames(s.bindings);for(let l of t)s.bindings[l].setValue(e,s.localVars.values[l])}var l=i.querySelectorAll(".wj-dropdown");[].forEach.call(l,(function(e){var t=wjcCore.Control.getControl(e);t&&softInput()&&t instanceof softInput().DropDown&&(t.isDroppedDown=!1)}))};let editEndedEH=function(e,t){c.cellEditEnded.removeHandler(editEndedEH);d._cellEditorVars=null};c.cellEditEnding.addHandler(editEndingEH);c.cellEditEnded.addHandler(editEndedEH)}else this._baseCf.updateCell(e,n,a,i,r,!1)}}}}if(!w){this._doDisposeCell(i);this._baseCf.updateCell(e,n,a,i,r)}}getEditorValue(e){if(this._cellEditorVars){let t=e.editRange;t&&t.isValid&&this._triggerEditorEvents(e.cells.getCellElement(t.row,t.col));return this._cellEditorVars.value}return super.getEditorValue(e)}disposeCell(e){this._doDisposeCell(e)}disposeTemplate(e,t,l){if(t){t.rootElement=null;t.column=null;e[t.templateContextProperty]=null;t.templateContextProperty=null}}setBindingsData(e,t,l,i,r,o){e.row=t;e.col=l;e.item=i;let n={},a=e.cell||{},s={},d={localVars:a,bindings:s};a.row=t;a.col=l;a.item=i;a.value=r;a.values=n;if(o){let e=Object.getOwnPropertyNames(o);for(let t of e){let e=new wjcCore.Binding(o[t]);s[t]=e;n[t]=e.getValue(a)}}e.cell!==a&&(e.cell=a);return d}checkHeight(e){this._isCheckingHeight||setTimeout(()=>{let t=e.cell;if(e.cellStamp===t[DirectiveCellFactoryBase._cellStampProp]){var l=t.scrollHeight,i=e.panel.rows,r=e.row.index,o=e.rng,n=o&&o.rowSpan||1,a=e.isEdit;null!=i.maxSize&&(l=Math.min(l,i.maxSize));if(r<i.length&&i[r].renderHeight*n<l-1){const t=i.defaultSize=l/n;if(a){let l=this._isFullEdit(),i=this.grid;this._backupHeight=e.row.height;e.row.height=t;this._cacheRow=e.row;this._isCheckingHeight=!0;i.refresh();i.startEditing(l);this._isCheckingHeight=!1;return}}else a&&(e.isImeInput?this._initImeEditInput(e.cell,e.templateContext):this._initEditInput(e.cell,e.templateContext,null))}},0)}_restoreRowHeight(){if(!this._isCheckingHeight&&this._backupHeight>0){this._cacheRow.height=this._backupHeight;this._backupHeight=-1;this._cacheRow=null}}doDisposeCell(e){for(var t=DirectiveCellFactoryBase._templateTypes,l=0;l<t.length;l++){var i=DirectiveCellFactoryBase.getTemplContextProp(GridCellTemplateType[t[l]]),r=e[i];if(r){let o=(r.column||this.grid)[i];this.disposeTemplate(e,r,o);t[l]==GridCellTemplateType[GridCellTemplateType.CellEdit]&&this._restoreRowHeight()}}}static getTemplContextProp(e){return"$__cellTempl"+GridCellTemplateType[e]}_doDisposeCell(e){this.doDisposeCell(e)}_initEditInput(e,t,l){this.setEditorFocusFlag(!0);let i=!1!==this.getEditorFocusFlag();this.setEditorFocusFlag(null);this._setFullEdit(t);i&&setTimeout(()=>{let t=this._findInitialInput(e);if(t){var inpFocusEh=()=>{t.removeEventListener("focus",inpFocusEh);setTimeout(()=>{setTimeout(()=>{let e=null!=l?l:this._editChar;if(e){t.value=e;this._editChar=null;DirectiveCellFactoryBase._setSelectionRange(t,e.length,e.length);t.dispatchEvent(this._evtInput)}},0)},DirectiveCellFactoryBase._FOCUS_INTERVAL)};t.addEventListener("focus",inpFocusEh);t.focus()}},100)}_initImeEditInput(e,t){let l=wjcCore.getActiveElement();if(l&&(l instanceof HTMLInputElement||l instanceof HTMLTextAreaElement)&&wjcCore.hasClass(l,"wj-grid-ime")){let i=this._findInitialInput(e),r=i&&i.style.color,o=this._composing,compEndEh=()=>{l.removeEventListener("compositionend",compEndEh);wjcCore.setCss(l,wjcGrid._ImeHandler._cssHidden);this.setEditorFocusFlag(!0);i&&(i.style.color=r);this._initEditInput(e,t,o?l.value:null)};if(o){l.addEventListener("compositionend",compEndEh);if(i){let e=i.getBoundingClientRect(),t=l.getBoundingClientRect(),r=window.getComputedStyle(l),o=parseFloat(r.left),n=parseFloat(r.top);wjcCore.setCss(l,{left:o+e.left-t.left+"px",top:n+e.top-t.top+"px",width:e.width+"px",height:e.height+"px"});i.style.color="transparent"}}else setTimeout(()=>compEndEh(),DirectiveCellFactoryBase._FOCUS_INTERVAL)}}_findInitialInput(e){let t=e&&e.rootElement&&e.rootElement.querySelectorAll("input,textarea")||e&&e.querySelectorAll("input,textarea");if(t)for(var l=0;l<t.length;l++){var i=t[l],r=window.getComputedStyle(i);if("none"!==r.display&&"visible"===r.visibility)return i}return null}static _setSelectionRange(e,t,l=t){if(wjcCore.contains(document.body,e)&&!e.disabled&&"none"!=e.style.display)try{e.setSelectionRange(wjcCore.asNumber(t),wjcCore.asNumber(l),wjcCore.isIE()?null:"backward");e.focus()}catch(e){}}_triggerEditorEvents(e){if(e){let t=e.querySelectorAll(".wj-control");for(let e=0;e<t.length;e++){let l=t[e],i=wjcCore.Control.getControl(l);i&&this.flushPendingEvents(i)}}}_isFullEdit(){let e=this.grid;return!e.activeEditor||e._edtHdl._fullEdit}_setFullEdit(e){let t=this.grid;e.forceFullEdit&&t.activeEditor&&(t._edtHdl._fullEdit=!0)}}DirectiveCellFactoryBase._cellStampProp="__wjCellStamp";DirectiveCellFactoryBase._FOCUS_INTERVAL=wjcCore.Control._FOCUS_INTERVAL+20;exports.DirectiveCellFactoryBase=DirectiveCellFactoryBase;__gridCFRef||(window.wijmo.grid=null);!function(e){e[e.Cell=0]="Cell";e[e.CellEdit=1]="CellEdit";e[e.ColumnHeader=2]="ColumnHeader";e[e.RowHeader=3]="RowHeader";e[e.RowHeaderEdit=4]="RowHeaderEdit";e[e.TopLeft=5]="TopLeft";e[e.GroupHeader=6]="GroupHeader";e[e.Group=7]="Group";e[e.NewCellTemplate=8]="NewCellTemplate";e[e.ColumnFooter=9]="ColumnFooter";e[e.BottomLeft=10]="BottomLeft"}(GridCellTemplateType=exports.GridCellTemplateType||(exports.GridCellTemplateType={}));wijmo_1._registerModule("wijmo.interop.grid",selfModule);